<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Narrrf's World Admin Interface</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 🔗 Discord Token of Render System -->
  <script src="discord-config.js"></script>
  
  <style>
    .admin-card {
      background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
      border-radius: 15px;
      padding: 20px;
      margin: 10px;
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .stats-card {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      border-radius: 12px;
      padding: 15px;
      margin: 8px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .user-card {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 8px;
      border-left: 4px solid #f0c92c;
      transition: all 0.3s ease;
    }
    .user-card:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    .tab-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
    }
    .tab-btn.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }
    .history-item {
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin: 5px 0;
      border-left: 4px solid #f0c92c;
    }
    .positive { border-left-color: #10b981; }
    .negative { border-left-color: #ef4444; }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-purple-50 to-pink-100 min-h-screen p-4">
  
  <div class="max-w-7xl mx-auto">
    
    <!-- Header -->
    <div class="text-center mb-6">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">🎮 Narrrf's World Admin Interface</h1>
      <p class="text-gray-600">Complete Discord Bot Management System</p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="stats-card">
        <h3 class="text-lg font-semibold">👥 Total Users</h3>
        <p class="text-2xl font-bold" id="totalUsers">Loading...</p>
      </div>
      <div class="stats-card">
        <h3 class="text-lg font-semibold">💰 Total Scores</h3>
        <p class="text-2xl font-bold" id="totalScores">Loading...</p>
      </div>
      <div class="stats-card">
        <h3 class="text-lg font-semibold">🏪 Store Items</h3>
        <p class="text-2xl font-bold" id="totalItems">Loading...</p>
      </div>
      <div class="stats-card">
        <h3 class="text-lg font-semibold">🏆 Active Quests</h3>
        <p class="text-2xl font-bold" id="activeQuests">Loading...</p>
      </div>
    </div>

    <!-- Admin Authentication -->
    <div class="admin-card mb-6" id="authPanel">
      <h2 class="text-xl font-semibold mb-4">🔐 Admin Authentication</h2>
      
      <!-- Discord Auth for Moderators -->
      <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">🎮 Discord Authentication (Moderators)</h3>
        <p class="text-sm text-gray-300 mb-3">If you have the moderator role in Discord, you can access basic admin features:</p>
        <button onclick="authenticateDiscord()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded">
          🔗 Login with Discord
        </button>
        <div id="discordAuthStatus" class="mt-2 text-sm"></div>
      </div>

      <!-- Password Auth for Super Admin -->
      <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">🔑 Super Admin Access</h3>
        <p class="text-sm text-gray-300 mb-3">For advanced features and user management:</p>
        
        <!-- Login Form -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium mb-2">Username:</label>
            <input type="text" id="loginUsername" placeholder="Enter username" class="w-full px-3 py-2 rounded text-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter password" class="w-full px-3 py-2 rounded text-gray-800">
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="loginAdmin()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">Super Admin Login</button>
          <button onclick="showUserManagement()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">Manage Users</button>
        </div>
      </div>

      <!-- User Management (Super Admin Only) -->
      <div id="userManagementPanel" class="hidden">
        <h3 class="text-lg font-semibold mb-4">👥 User Management</h3>
        
        <!-- Add New User -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-4">
          <h4 class="text-md font-semibold mb-3">➕ Add New User</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="newUsername" placeholder="Username" class="px-3 py-2 rounded text-gray-800">
            <input type="password" id="newPassword" placeholder="Password" class="px-3 py-2 rounded text-gray-800">
            <select id="newRole" class="px-3 py-2 rounded text-gray-800">
              <option value="moderator">Moderator</option>
              <option value="admin">Admin</option>
            </select>
            <input type="text" id="newDiscordId" placeholder="Discord ID (optional)" class="px-3 py-2 rounded text-gray-800">
          </div>
          <button onclick="addUser()" class="mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add User</button>
        </div>

        <!-- Current Users -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h4 class="text-md font-semibold mb-3">📋 Current Users</h4>
          <div id="currentUsersList" class="space-y-2">
            <div class="text-gray-300">Loading users...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="admin-card mb-6" id="navPanel" style="display: none;">
      <div class="flex flex-wrap gap-2 mb-4">
        <button class="tab-btn active px-4 py-2 rounded" data-tab="dashboard">📊 Dashboard</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="users">👥 User Management</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="points">💰 Point Management</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="store">🏪 Store Management</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="quests">🏆 Quest System</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="games">🎮 Game Management</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="discord">🔗 Discord Config</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="holderVerification">🎴 Holder Verification</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="cheeseGuide">🧀 Cheese Guide</button>
      </div>
      
      <!-- Additional Admin Links -->
      <div class="text-center mt-4 pt-4 border-t border-gray-600">
        <!-- Database options for all moderators (password protected) -->
        <div id="databaseOptions" style="display: none;">
          <a href="download-db.php" class="inline-block bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 mr-4">
            📥 Download Database
          </a>
          <button onclick="showUploadModal()" class="inline-block bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 mr-4">
            📤 Upload Database
          </button>
          <button onclick="showDatabaseViewer()" class="inline-block bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 mr-4">
            👁️ Database Viewer
          </button>
          <button onclick="triggerBackup()" class="inline-block bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 mr-4">
            🗄️ Database Backup
          </button>
        </div>
        
        <!-- Database access unlock button -->
        <div id="databaseUnlockSection">
          <button onclick="showDatabaseUnlock()" class="inline-block bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 mr-4">
            🔓 Unlock Database Access
          </button>
        </div>
        
        <!-- All admin users can see Home link -->
        <a href="index.html" class="inline-block bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
          🏠 Home
        </a>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="admin-card mb-6" id="dashboardTab">
      <h2 class="text-xl font-semibold mb-4">📊 System Dashboard</h2>
      
      <!-- System Stats -->
      <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">📈 Detailed System Statistics</h3>
        <div id="systemStats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-green-400" id="totalUsersDetail">-</div>
            <div class="text-sm text-gray-300">Total Users</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-400" id="totalScoresDetail">-</div>
            <div class="text-sm text-gray-300">Score Records</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-yellow-400" id="totalItemsDetail">-</div>
            <div class="text-sm text-gray-300">Store Items</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-400" id="activeQuestsDetail">-</div>
            <div class="text-sm text-gray-300">Active Quests</div>
          </div>
        </div>
        
        <!-- Cheese Click Statistics -->
        <div class="mt-6 pt-6 border-t border-gray-600">
          <h4 class="text-md font-semibold mb-3 text-orange-400">🧀 Cheese Click Statistics</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-xl font-bold text-orange-400" id="totalCheeseClicks">-</div>
              <div class="text-sm text-gray-300">Total Cheese Clicks</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-orange-400" id="recentCheeseClicks">-</div>
              <div class="text-sm text-gray-300">Last 24h Clicks</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-orange-400" id="topCheeseUser">-</div>
              <div class="text-sm text-gray-300">Top Clicker</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-orange-400" id="mostClickedCheese">-</div>
              <div class="text-sm text-gray-300">Most Clicked</div>
            </div>
          </div>
          
          <!-- Detailed Cheese Stats -->
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h5 class="text-sm font-semibold mb-2 text-orange-300">Clicks by Cheese Type:</h5>
              <div id="cheeseClicksByType" class="text-sm text-gray-300">
                Loading cheese click data...
              </div>
            </div>
            <div>
              <h5 class="text-sm font-semibold mb-2 text-orange-300">Top Cheese Clickers:</h5>
              <div id="topCheeseClickers" class="text-sm text-gray-300">
                Loading top clickers...
              </div>
            </div>
          </div>
        </div>
        
        <!-- Quest and Role Statistics -->
        <div class="mt-6 pt-6 border-t border-gray-600">
          <h4 class="text-md font-semibold mb-3 text-green-400">🎯 Quest & Role Statistics</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-xl font-bold text-green-400" id="openQuests">-</div>
              <div class="text-sm text-gray-300">Open Quests</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-yellow-400" id="pendingClaims">-</div>
              <div class="text-sm text-gray-300">Pending Claims</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-blue-400" id="completedQuests">-</div>
              <div class="text-sm text-gray-300">Completed Quests</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-purple-400" id="rolesGranted">-</div>
              <div class="text-sm text-gray-300">Roles Granted</div>
            </div>
          </div>
          
          <!-- Detailed Quest Stats -->
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h5 class="text-sm font-semibold mb-2 text-green-300">Recent Quest Claims:</h5>
              <div id="recentQuestClaims" class="text-sm text-gray-300">
                Loading quest claims...
              </div>
            </div>
            <div>
              <h5 class="text-sm font-semibold mb-2 text-purple-300">Active Quests by Type:</h5>
              <div id="activeQuestsByType" class="text-sm text-gray-300">
                Loading active quests...
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Statistics -->
        <div class="mt-6 pt-6 border-t border-gray-600">
          <h4 class="text-md font-semibold mb-3 text-cyan-400">🚀 Enhanced Statistics</h4>
          
          <!-- Immediate Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center">
              <div class="text-xl font-bold text-cyan-400" id="avgClicksPerUser">-</div>
              <div class="text-sm text-gray-300">Avg Clicks/User</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-emerald-400" id="totalDSPOINC">-</div>
              <div class="text-sm text-gray-300">Total $DSPOINC</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-pink-400" id="questCompletionRate">-</div>
              <div class="text-sm text-gray-300">Quest Success %</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-indigo-400" id="avgQuestReward">-</div>
              <div class="text-sm text-gray-300">Avg Quest Reward</div>
            </div>
          </div>

          <!-- Daily Activity Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center">
              <div class="text-lg font-bold text-yellow-400" id="clicksLast24h">-</div>
              <div class="text-sm text-gray-300">Clicks (24h)</div>
            </div>
            <div class="text-center">
              <div class="text-lg font-bold text-green-400" id="newUsersToday">-</div>
              <div class="text-sm text-gray-300">New Users (24h)</div>
            </div>
            <div class="text-center">
              <div class="text-lg font-bold text-blue-400" id="questsClaimedToday">-</div>
              <div class="text-sm text-gray-300">Quests (24h)</div>
            </div>
            <div class="text-center">
              <div class="text-lg font-bold text-purple-400" id="rolesGrantedToday">-</div>
              <div class="text-sm text-gray-300">Roles (24h)</div>
            </div>
          </div>

          <!-- Engagement Stats -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h5 class="text-sm font-semibold mb-2 text-cyan-300">User Engagement:</h5>
              <div id="engagementStats" class="text-sm text-gray-300">
                Loading engagement data...
              </div>
            </div>
            <div>
              <h5 class="text-sm font-semibold mb-2 text-emerald-300">Wealth Distribution:</h5>
              <div id="wealthStats" class="text-sm text-gray-300">
                Loading wealth data...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">⚡ Quick Actions</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <button onclick="refreshDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all duration-300">
            🔄 Refresh Data
          </button>
          <!-- Database actions (password protected) -->
          <div id="databaseQuickActions" style="display: none;">
            <button onclick="showUploadModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all duration-300">
              📤 Upload DB
            </button>
            <button onclick="showDatabaseViewer()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-all duration-300">
              👁️ View DB
            </button>
            <button onclick="triggerBackup()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all duration-300">
              💾 Backup DB
            </button>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-3">🔄 Recent Point Adjustments</h3>
          <div id="recentAdjustments" class="max-h-64 overflow-y-auto">
            <div class="text-gray-300">Loading recent adjustments...</div>
          </div>
        </div>
        
        <div>
          <h3 class="text-lg font-semibold mb-3">🏆 Top Users by Balance</h3>
          <div id="topUsers" class="max-h-64 overflow-y-auto">
            <div class="text-gray-300">Loading top users...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Management Tab -->
    <div class="admin-card mb-6" id="usersTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">👥 User Management</h2>
      
      <!-- Instant User Search -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">🔍 Instant User Search:</label>
        <div class="flex gap-2">
          <input type="text" id="userSearch" placeholder="Search by Discord ID or username..." 
                 class="flex-1 px-3 py-2 rounded text-gray-800" 
                 oninput="searchUsersInstant(this.value)">
          <button onclick="searchUsers()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Search</button>
        </div>
      </div>

      <!-- User Results -->
      <div id="userResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="text-gray-300">Search for users to see results...</div>
      </div>

      <!-- User Quest History Section -->
      <div class="mt-6 bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">🏆 User Quest History</h3>
        <div class="mb-4">
          <div class="flex gap-2">
            <input type="text" id="questHistoryUserId" placeholder="Enter Discord ID or username..." 
                   class="flex-1 px-3 py-2 rounded text-gray-800">
            <button onclick="loadUserQuestHistory()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Load History</button>
          </div>
        </div>
        
        <!-- User Quest History Results -->
        <div id="userQuestHistory" class="space-y-4">
          <div class="text-gray-300">Enter a user ID or username to view their quest and cheese click history...</div>
        </div>
      </div>
    </div>

    <!-- Point Management Tab -->
    <div class="admin-card mb-6" id="pointsTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">💰 Point Management</h2>
      
      <!-- Quick User Selection -->
      <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">🎯 Quick User Selection</h3>
        <div class="flex gap-2">
          <input type="text" id="quickUserId" placeholder="Enter username or ID" 
                 class="flex-1 px-3 py-2 rounded text-gray-800" oninput="quickSearchUsersInstant(this.value)">
          <button onclick="quickSelectUser()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Select User</button>
        </div>
        <div id="quickUserResults" class="mt-3 max-h-48 overflow-y-auto">
          <div class="text-gray-300">Enter at least 2 characters to search...</div>
        </div>
        <div id="selectedUserInfo" class="mt-3 p-3 bg-gray-700 rounded hidden">
          <!-- Selected user info will appear here -->
        </div>
      </div>

      <!-- Point Operations -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <!-- Add Points -->
        <div class="bg-green-900 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">➕ Add Points</h3>
          <div class="space-y-3">
            <input type="text" id="addUserId" placeholder="Discord User ID" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="number" id="addAmount" placeholder="Amount to add" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="text" id="addReason" placeholder="Reason (optional)" class="w-full px-3 py-2 rounded text-gray-800">
            <button onclick="addPoints()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Points</button>
          </div>
        </div>

        <!-- Set Points -->
        <div class="bg-blue-900 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">🎯 Set Points</h3>
          <div class="space-y-3">
            <input type="text" id="setUserId" placeholder="Discord User ID" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="number" id="setAmount" placeholder="New total amount" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="text" id="setReason" placeholder="Reason (optional)" class="w-full px-3 py-2 rounded text-gray-800">
            <button onclick="setPoints()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Set Points</button>
          </div>
        </div>

        <!-- Remove Points -->
        <div class="bg-red-900 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">➖ Remove Points</h3>
          <div class="space-y-3">
            <input type="text" id="removeUserId" placeholder="Discord User ID" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="number" id="removeAmount" placeholder="Amount to remove" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="text" id="removeReason" placeholder="Reason (optional)" class="w-full px-3 py-2 rounded text-gray-800">
            <button onclick="removePoints()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Remove Points</button>
          </div>
        </div>
      </div>

      <!-- Balance & History -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Quick Balance Check -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">💳 Quick Balance Check</h3>
          <div class="flex gap-2">
            <input type="text" id="balanceUserId" placeholder="Discord User ID" class="flex-1 px-3 py-2 rounded text-gray-800">
            <button onclick="checkBalance()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Check Balance</button>
          </div>
          <div id="balanceResult" class="mt-3 p-3 bg-gray-700 rounded hidden">
            <!-- Balance result will be shown here -->
          </div>
        </div>

        <!-- Transaction History -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">📋 Transaction History</h3>
          <div class="flex gap-2 mb-3">
            <input type="text" id="historyUserId" placeholder="Discord User ID" class="flex-1 px-3 py-2 rounded text-gray-800">
            <button onclick="getHistory()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">Get History</button>
          </div>
          <div id="historyResult" class="max-h-64 overflow-y-auto">
            <!-- History will be shown here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Store Management Tab -->
    <div class="admin-card mb-6" id="storeTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">🏪 Store Management</h2>
      
      <!-- Store Items -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">📦 Available Store Items</h3>
        <button onclick="loadStoreItems()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mb-3">Refresh Items</button>
        <div id="storeItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="text-gray-300">Click "Refresh Items" to load store items...</div>
        </div>
      </div>

      <!-- Add New Item -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3">➕ Add New Store Item</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="newItemName" placeholder="Item Name" class="px-3 py-2 rounded text-gray-800">
          <input type="number" id="newItemPrice" placeholder="Price in $DSPOINC" class="px-3 py-2 rounded text-gray-800">
          <input type="text" id="newItemImageUrl" placeholder="Image URL (optional)" class="px-3 py-2 rounded text-gray-800">
          <textarea id="newItemDescription" placeholder="Item Description" class="px-3 py-2 rounded text-gray-800 md:col-span-2"></textarea>
          <button onclick="createStoreItem()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Create Item</button>
        </div>
      </div>

      <!-- Give Item to User -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3">🎁 Give Item to User</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="relative">
            <input type="text" id="giveItemUserId" placeholder="Search User ID or Username" class="px-3 py-2 rounded text-gray-800 w-full" oninput="giveItemSearchUsersInstant(this.value)">
            <div id="giveItemUserResults" class="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded mt-1 max-h-40 overflow-y-auto" style="display: none;"></div>
          </div>
          <input type="text" id="giveItemName" placeholder="Item Name" class="px-3 py-2 rounded text-gray-800">
          <input type="number" id="giveItemQuantity" placeholder="Quantity" value="1" class="px-3 py-2 rounded text-gray-800">
        </div>
        <button onclick="giveItemToUser()" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">Give Item</button>
      </div>

      <!-- View User Inventory -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">👤 View User Inventory</h3>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <input type="text" id="viewInventoryUserId" placeholder="Search User ID or Username" class="px-3 py-2 rounded text-gray-800 w-full" oninput="viewInventorySearchUsersInstant(this.value)">
            <div id="viewInventoryUserResults" class="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded mt-1 max-h-40 overflow-y-auto" style="display: none;"></div>
          </div>
          <button onclick="viewUserInventory()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">View Inventory</button>
        </div>
        <div id="userInventoryList" class="mt-3">
          <div class="text-gray-300">Search for a user and click "View Inventory"...</div>
        </div>
      </div>
    </div>

    <!-- Quest System Tab -->
    <div class="admin-card mb-6" id="questsTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">🏆 Quest System</h2>
      
      <!-- Active Quests -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">🎯 Active Quests</h3>
        <div id="activeQuestsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="text-gray-300">Loading active quests...</div>
        </div>
      </div>

      <!-- Create New Quest -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">➕ Create New Quest</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <select id="newQuestType" class="px-3 py-2 rounded text-gray-800" onchange="toggleCheeseQuestConfig()">
            <option value="">Select Quest Type...</option>
            <option value="cheese_hunt">🧀 Cheese Hunt</option>
            <option value="tetris">🟦 Tetris Quest</option>
            <option value="snake">🐍 Snake Quest</option>
            <option value="hytopia_game">🎮 Hytopia Game Quest</option>
            <option value="tweet">🐦 Twitter Quest</option>
            <option value="invite">👥 Invite Friends</option>
            <option value="custom">⚙️ Custom Quest</option>
          </select>
          <input type="number" id="newQuestReward" placeholder="Reward in $DSPOINC" class="px-3 py-2 rounded text-gray-800">
          <input type="text" id="newQuestUrl" placeholder="Quest URL" class="px-3 py-2 rounded text-gray-800">
          <textarea id="newQuestDescription" placeholder="Quest Description" class="px-3 py-2 rounded text-gray-800 md:col-span-2"></textarea>
          
          <!-- Role Granting Options -->
          <div class="md:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-green-400">🎭 Role Granting Options</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex items-center">
                <input type="checkbox" id="grantRoleCheckbox" class="mr-2 w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-2">
                <label for="grantRoleCheckbox" class="text-sm font-medium">Grant Discord Role on Completion</label>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Discord Role ID:</label>
                <select id="questRoleId" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="">Select a role...</option>
                  <option value="1399651053682692208">🧀 Cheese Hunter (1399651053682692208)</option>
                  <option value="1332017770937847809">🏆 Alpha Caller (1332017770937847809)</option>
                  <option value="1332017420591697972">🥇 Champion (1332017420591697972)</option>
                  <option value="1332017969181622342">👥 Community Member (1332017969181622342)</option>
                  <option value="1332017063610548445">🌽 Corny Companion (1332017063610548445)</option>
                  <option value="1332017858342944808">💬 Engager (1332017858342944808)</option>
                  <option value="1332016854390280306">🌈 Kaleido Supporter (1332016854390280306)</option>
                  <option value="1332049628300054679">🛡️ Moderator (1332049628300054679)</option>
                  <option value="1332017533800284211">🃏 Poker OG (1332017533800284211)</option>
                  <option value="1332017205667299489">🐰 Bunny Buddy (1332017205667299489)</option>
                  <option value="1332017710351122482">🥊 Rumble Champ (1332017710351122482)</option>
                  <option value="1356296242757369898">🚀 Server Booster (1356296242757369898)</option>
                  <option value="1332016526848692345">👑 VIP Cheese Lord (1332016526848692345)</option>
                  <option value="1333347801408737323">✅ Verified (1333347801408737323)</option>
                  <option value="1332017340392538123">🌿 Weedery (1332017340392538123)</option>
                  <option value="1332108350518857842">🏆 WL (1332108350518857842)</option>
                </select>
                <p class="text-xs text-gray-400 mt-1">Select the Discord role to grant when quest is completed</p>
              </div>
            </div>
          </div>
          
          <!-- Cheese Quest Configuration (shown when type is cheese_hunt) -->
          <div id="cheeseQuestConfig" class="md:col-span-2 bg-gray-700 p-4 rounded-lg" style="display: none;">
            <h4 class="text-lg font-semibold mb-3 text-yellow-400">🧀 Cheese Hunt Configuration</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Movement Pattern:</label>
                <select id="cheeseMovementPattern" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="random">Random Jump</option>
                  <option value="edge_hunter">Edge Hunter</option>
                  <option value="sneaky">Sneaky (Hidden Areas)</option>
                  <option value="corner_lurker">Corner Lurker</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Movement Speed:</label>
                <select id="cheeseMovementSpeed" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="fast">Fast & Sneaky</option>
                  <option value="normal" selected>Normal Hunter</option>
                  <option value="slow">Slow & Patient</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Cheese Count:</label>
                <input type="number" id="cheeseCount" value="3" min="1" max="10" class="w-full px-3 py-2 rounded text-gray-800">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Hidden Areas:</label>
                <select id="cheeseHiddenAreas" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="true" selected>Enabled</option>
                  <option value="false">Disabled</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Discord Ticket:</label>
                <select id="cheeseDiscordTicket" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="true" selected>Create Ticket</option>
                  <option value="false">No Ticket</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Screenshot Required:</label>
                <select id="cheeseScreenshotRequired" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="true" selected>Required</option>
                  <option value="false">Optional</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Game Settings Section -->
          <div class="md:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-blue-400">🎮 Game Settings & WL Role Grants</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Tetris WL Settings -->
              <div class="bg-gray-600 p-3 rounded-lg">
                <h5 class="text-md font-semibold mb-2 text-green-400">🟦 Tetris WL Settings</h5>
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="tetrisWlEnabled" class="mr-2 w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-2">
                    <label for="tetrisWlEnabled" class="text-sm font-medium">Enable WL Role Grant</label>
                  </div>
                  <div>
                    <label class="block text-xs font-medium mb-1">Score Threshold:</label>
                    <input type="number" id="tetrisWlThreshold" value="4000" min="1000" max="10000" class="w-full px-2 py-1 rounded text-gray-800 text-sm">
                  </div>
                                 <div>
                 <label class="block text-xs font-medium mb-1">WL Role ID:</label>
                 <select id="tetrisWlRoleId" class="w-full px-2 py-1 rounded text-gray-800 text-sm">
                   <option value="">Select WL role...</option>
                   <option value="1399651053682692208">🧀 Cheese Hunter (1399651053682692208)</option>
                   <option value="1332017770937847809">🏆 Alpha Caller (1332017770937847809)</option>
                   <option value="1332017420591697972">🥇 Champion (1332017420591697972)</option>
                   <option value="1332016526848692345">👑 VIP Cheese Lord (1332016526848692345)</option>
                   <option value="1333347801408737323">✅ Verified (1333347801408737323)</option>
                 </select>
               </div>
               <div>
                 <label class="block text-xs font-medium mb-1">Bonus Points:</label>
                 <input type="number" id="tetrisWlBonus" value="1000" min="100" max="10000" class="w-full px-2 py-1 rounded text-gray-800 text-sm">
               </div>
                </div>
              </div>
              
              <!-- Snake WL Settings -->
              <div class="bg-gray-600 p-3 rounded-lg">
                <h5 class="text-md font-semibold mb-2 text-green-400">🐍 Snake WL Settings</h5>
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="snakeWlEnabled" class="mr-2 w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-2">
                    <label for="snakeWlEnabled" class="text-sm font-medium">Enable WL Role Grant</label>
                  </div>
                  <div>
                    <label class="block text-xs font-medium mb-1">Score Threshold:</label>
                    <input type="number" id="snakeWlThreshold" value="4000" min="1000" max="10000" class="w-full px-2 py-1 rounded text-gray-800 text-sm">
                  </div>
                                 <div>
                 <label class="block text-xs font-medium mb-1">WL Role ID:</label>
                 <select id="snakeWlRoleId" class="w-full px-2 py-1 rounded text-gray-800 text-sm">
                   <option value="">Select WL role...</option>
                   <option value="1399651053682692208">🧀 Cheese Hunter (1399651053682692208)</option>
                   <option value="1332017770937847809">🏆 Alpha Caller (1332017770937847809)</option>
                   <option value="1332017420591697972">🥇 Champion (1332017420591697972)</option>
                   <option value="1332016526848692345">👑 VIP Cheese Lord (1332016526848692345)</option>
                   <option value="1333347801408737323">✅ Verified (1333347801408737323)</option>
                 </select>
               </div>
               <div>
                 <label class="block text-xs font-medium mb-1">Bonus Points:</label>
                 <input type="number" id="snakeWlBonus" value="1000" min="100" max="10000" class="w-full px-2 py-1 rounded text-gray-800 text-sm">
               </div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <button onclick="saveGameSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                💾 Save Game Settings
              </button>
            </div>
          </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1">Winner Message:</label>
                <input type="text" id="cheeseWinnerMessage" value="🎯 Congratulations! You found the cheese!" class="w-full px-3 py-2 rounded text-gray-800">
              </div>
            </div>
          </div>
          
          <button onclick="createQuest()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Create Quest</button>
        </div>
      </div>
      
      <!-- Quest Claims Management -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mt-6">
        <h3 class="text-lg font-semibold mb-3">📋 Quest Claims Management</h3>
        <div class="mb-4">
          <button onclick="loadEnhancedQuestClaims()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded mr-2">🔄 Refresh Claims</button>
          <select id="claimStatusFilter" onchange="filterQuestClaims()" class="px-3 py-2 rounded text-gray-800">
            <option value="all">All Claims</option>
            <option value="pending">Pending Review</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
          <button onclick="toggleUserHistoryView()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded ml-2">👤 Show User History</button>
        </div>
        <div id="questClaimsList" class="space-y-4 max-h-96 overflow-y-auto">
          <div class="text-gray-300">Click "Refresh Claims" to load quest submissions...</div>
        </div>
      </div>
    </div>

    <!-- Game Management Tab -->
    <div class="admin-card mb-6" id="gamesTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">🎮 Game Management</h2>
      
      <!-- Game Statistics Overview -->
      <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">📊 Game Statistics</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <!-- Tetris Stats -->
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-blue-400 mb-2">🟦 Tetris</h4>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Total Scores:</span>
                <span class="text-white font-semibold" id="tetrisTotalScores">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Unique Players:</span>
                <span class="text-white font-semibold" id="tetrisUniquePlayers">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Highest Score:</span>
                <span class="text-green-400 font-semibold" id="tetrisMaxScore">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Recent (24h):</span>
                <span class="text-blue-400 font-semibold" id="tetrisRecent24h">-</span>
              </div>
            </div>
          </div>

          <!-- Snake Stats -->
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-green-400 mb-2">🐍 Snake</h4>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Total Scores:</span>
                <span class="text-white font-semibold" id="snakeTotalScores">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Unique Players:</span>
                <span class="text-white font-semibold" id="snakeUniquePlayers">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Highest Score:</span>
                <span class="text-green-400 font-semibold" id="snakeMaxScore">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Recent (24h):</span>
                <span class="text-blue-400 font-semibold" id="snakeRecent24h">-</span>
              </div>
            </div>
          </div>

          <!-- Total Stats -->
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-purple-400 mb-2">📈 Combined</h4>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Total Scores:</span>
                <span class="text-white font-semibold" id="totalGameScores">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Total Players:</span>
                <span class="text-white font-semibold" id="totalGamePlayers">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Recent (24h):</span>
                <span class="text-blue-400 font-semibold" id="totalGameRecent24h">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Recent (7d):</span>
                <span class="text-purple-400 font-semibold" id="totalGameRecent7d">-</span>
              </div>
            </div>
          </div>
        </div>
        
        <button onclick="loadGameStatistics()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">🔄 Refresh Statistics</button>
      </div>

      <!-- Score Reset Management -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">🔄 Score Reset Management</h3>
        
        <!-- Reset Options -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
          <!-- Game Selection -->
          <div>
            <label class="block text-sm font-medium mb-2">🎮 Select Game:</label>
            <select id="resetGameType" class="w-full px-3 py-2 rounded text-gray-800">
              <option value="all">All Games (Tetris + Snake)</option>
              <option value="tetris">🟦 Tetris Only</option>
              <option value="snake">🐍 Snake Only</option>
            </select>
          </div>

          <!-- Reset Type -->
          <div>
            <label class="block text-sm font-medium mb-2">🔄 Reset Type:</label>
            <select id="resetType" class="w-full px-3 py-2 rounded text-gray-800" onchange="toggleResetOptions()">
              <option value="season">🆕 New Season (Preserve Data)</option>
              <option value="all">🗑️ All Scores (Delete)</option>
              <option value="top_scores">📊 Top Scores Only</option>
              <option value="user">👤 Specific User</option>
            </select>
          </div>
        </div>

        <!-- Additional Options -->
        <div id="resetOptions" class="space-y-4">
          <!-- Season Option -->
          <div id="seasonOption" class="hidden">
            <label class="block text-sm font-medium mb-2">📅 Season Name (Optional):</label>
            <input type="text" id="seasonName" placeholder="e.g., Summer 2024, Season 2, etc." class="w-full px-3 py-2 rounded text-gray-800">
            <p class="text-xs text-gray-400 mt-1">Leave empty for auto-generated season name. Current data will be preserved as historical data.</p>
          </div>

          <!-- Top Scores Option -->
          <div id="topScoresOption" class="hidden">
            <label class="block text-sm font-medium mb-2">📊 Number of Top Scores to Reset:</label>
            <input type="number" id="topCount" value="10" min="1" max="100" class="w-full px-3 py-2 rounded text-gray-800">
            <p class="text-xs text-gray-400 mt-1">Enter the number of top scores to remove (e.g., 10 = remove top 10 scores)</p>
          </div>

          <!-- User Option -->
          <div id="userOption" class="hidden">
            <label class="block text-sm font-medium mb-2">👤 Discord User ID:</label>
            <input type="text" id="resetUserId" placeholder="Enter Discord ID (e.g., 123456789012345678)" class="w-full px-3 py-2 rounded text-gray-800">
            <p class="text-xs text-gray-400 mt-1">Enter the Discord ID of the user whose scores you want to reset</p>
          </div>
        </div>

        <!-- Reset Button -->
        <div class="mt-6">
          <button onclick="resetGameScores()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded font-semibold">
            ⚠️ Reset Game Scores
          </button>
          <p class="text-xs text-red-400 mt-2">⚠️ This action cannot be undone! For season resets, data is preserved as historical records.</p>
        </div>
      </div>

      <!-- Top Players -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Tetris Top Players -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h4 class="font-semibold text-blue-400 mb-3">🟦 Tetris Top Players</h4>
          <div id="tetrisTopPlayers" class="space-y-2 max-h-64 overflow-y-auto">
            <div class="text-gray-300">Loading top players...</div>
          </div>
        </div>

        <!-- Snake Top Players -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h4 class="font-semibold text-green-400 mb-3">🐍 Snake Top Players</h4>
          <div id="snakeTopPlayers" class="space-y-2 max-h-64 overflow-y-auto">
            <div class="text-gray-300">Loading top players...</div>
          </div>
        </div>
      </div>

      <!-- Season Statistics -->
      <div class="mt-6 bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h4 class="font-semibold text-yellow-400 mb-3">🏆 Season Statistics & Legends</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium mb-2">📅 Select Season:</label>
            <select id="seasonSelector" class="w-full px-3 py-2 rounded text-gray-800" onchange="loadSeasonStats()">
              <option value="current">Current Season</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">🎮 Game Filter:</label>
            <select id="gameFilter" class="w-full px-3 py-2 rounded text-gray-800" onchange="loadSeasonStats()">
              <option value="all">All Games</option>
              <option value="tetris">Tetris Only</option>
              <option value="snake">Snake Only</option>
            </select>
          </div>
        </div>
        <div id="seasonStats" class="space-y-4">
          <div class="text-gray-300">Loading season statistics...</div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="mt-6 bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h4 class="font-semibold text-purple-400 mb-3">📊 Recent Game Activity</h4>
        <div id="recentGameActivity" class="space-y-2 max-h-48 overflow-y-auto">
          <div class="text-gray-300">Loading recent activity...</div>
        </div>
      </div>
    </div>

    <!-- Discord Config Tab -->
    <div class="admin-card mb-6" id="discordTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">🔗 Discord Configuration</h2>
      
      <!-- Current Discord Settings -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <p><strong>Current Invite Code:</strong> <span id="currentCode" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
          <p><strong>Full Discord URL:</strong> <span id="currentUrl" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
        </div>
        <div>
          <p><strong>System Version:</strong> <span id="systemVersion" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
          <p><strong>Last Updated:</strong> <span id="lastUpdated" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
        </div>
      </div>
      
      <!-- Update Discord Settings -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">🔄 Update Discord Settings</h3>
        <div class="flex gap-2">
          <input type="text" id="newInviteCode" placeholder="Enter new invite code" class="flex-1 px-3 py-2 rounded text-gray-800" value="hx4EvgBG">
          <button onclick="updateInviteCode()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Update</button>
        </div>
      </div>
    </div>

    <!-- Admin Activity Log -->
    <div class="admin-card">
      <h2 class="text-xl font-semibold mb-4">📊 Admin Activity Log</h2>
      <div id="statusLog" class="bg-gray-800 p-4 rounded text-sm font-mono h-32 overflow-y-auto">
        <div class="text-green-400">🔄 Admin interface initializing...</div>
      </div>
    </div>

    <!-- Cheese Egg Difficulty Guide Tab -->
    <div class="admin-card mb-6" id="cheeseGuideTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">🧀 Cheese Egg Difficulty Guide</h2>
      
      <!-- Overview Section -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-yellow-400">🎯 Cheese Egg System Overview</h3>
        <p class="text-gray-300 mb-4">
          The cheese egg system is designed to provide an engaging hunting experience while preventing cheating through advanced anti-cheating measures. 
          This guide explains all difficulty settings and their impact on gameplay.
        </p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-green-400 mb-2">✅ Anti-Cheating Features</h4>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>• Session-based randomization</li>
              <li>• Anti-reload protection</li>
              <li>• Time-based difficulty scaling</li>
              <li>• Hidden area preference</li>
              <li>• Visual indicators for hidden eggs</li>
            </ul>
          </div>
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-blue-400 mb-2">🎮 Difficulty Levels</h4>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>• 4 Movement Patterns</li>
              <li>• 3 Speed Settings</li>
              <li>• 1-10 Cheese Count</li>
              <li>• Hidden Areas Toggle</li>
              <li>• Screenshot Requirements</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Movement Patterns Section -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-yellow-400">🔄 Movement Pattern Settings</h3>
        <div class="space-y-4">
          <div class="border-l-4 border-green-500 pl-4">
            <h4 class="font-semibold text-green-400">Random Jump</h4>
            <p class="text-gray-300 text-sm mb-2">Default pattern with enhanced anti-cheating</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• Moves to any random area initially</li>
              <li>• 70% chance to hide after 30 seconds</li>
              <li>• Prefers hidden areas (above/below viewport)</li>
              <li>• Session-based positioning prevents reload cheating</li>
            </ul>
          </div>
          
          <div class="border-l-4 border-blue-500 pl-4">
            <h4 class="font-semibold text-blue-400">Edge Hunter</h4>
            <p class="text-gray-300 text-sm mb-2">Advanced pattern for experienced hunters</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• Always prefers edges and corners</li>
              <li>• Top, bottom, left, or right edges</li>
              <li>• Positions eggs outside viewport boundaries</li>
              <li>• Requires scrolling to find</li>
            </ul>
          </div>
          
          <div class="border-l-4 border-purple-500 pl-4">
            <h4 class="font-semibold text-purple-400">Sneaky (Hidden Areas)</h4>
            <p class="text-gray-300 text-sm mb-2">Expert level - very challenging</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• 70% chance to be completely hidden</li>
              <li>• Far above or below viewport</li>
              <li>• Requires extensive scrolling</li>
              <li>• Visual pulse indicator when hidden</li>
            </ul>
          </div>
          
          <div class="border-l-4 border-red-500 pl-4">
            <h4 class="font-semibold text-red-400">Corner Lurker</h4>
            <p class="text-gray-300 text-sm mb-2">Master level - extremely difficult</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• Always in far corner areas</li>
              <li>• Top-left, top-right, bottom-left, bottom-right</li>
              <li>• Maximum distance from viewport center</li>
              <li>• Requires strategic hunting approach</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Movement Speed Section -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-yellow-400">⚡ Movement Speed Settings</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-gray-700 p-3 rounded text-center">
            <h4 class="font-semibold text-green-400 mb-2">Fast & Sneaky</h4>
            <p class="text-gray-300 text-sm">Quick movements every 2-3 seconds</p>
            <p class="text-xs text-gray-400 mt-2">Best for: Active hunting, time pressure</p>
          </div>
          <div class="bg-gray-700 p-3 rounded text-center">
            <h4 class="font-semibold text-blue-400 mb-2">Normal Hunter</h4>
            <p class="text-gray-300 text-sm">Standard speed every 4-5 seconds</p>
            <p class="text-xs text-gray-400 mt-2">Best for: Balanced gameplay</p>
          </div>
          <div class="bg-gray-700 p-3 rounded text-center">
            <h4 class="font-semibold text-purple-400 mb-2">Slow & Patient</h4>
            <p class="text-gray-300 text-sm">Slow movements every 6-8 seconds</p>
            <p class="text-xs text-gray-400 mt-2">Best for: Strategic hunting</p>
          </div>
        </div>
      </div>

      <!-- Anti-Cheating Features Section -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-yellow-400">🔒 Anti-Cheating Features Explained</h3>
        <div class="space-y-4">
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-red-400 mb-2">Session-Based Randomization</h4>
            <p class="text-gray-300 text-sm mb-2">Each page load gets a unique seed that determines egg positions</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• Prevents reload cheating</li>
              <li>• Consistent positioning within session</li>
              <li>• Unpredictable between sessions</li>
            </ul>
          </div>
          
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-orange-400 mb-2">Time-Based Difficulty Scaling</h4>
            <p class="text-gray-300 text-sm mb-2">Difficulty increases over time to prevent quick wins</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• Gets harder over 5 minutes</li>
              <li>• More hidden area preference</li>
              <li>• Reduced visible positioning</li>
            </ul>
          </div>
          
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-yellow-400 mb-2">Hidden Area Bias</h4>
            <p class="text-gray-300 text-sm mb-2">Eggs prefer to hide in harder-to-find areas</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• 70% chance to hide after 30 seconds</li>
              <li>• Above/below viewport positioning</li>
              <li>• Requires scrolling and exploration</li>
            </ul>
          </div>
          
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-green-400 mb-2">Visual Indicators</h4>
            <p class="text-gray-300 text-sm mb-2">Subtle hints for hidden eggs</p>
            <ul class="text-xs text-gray-400 space-y-1">
              <li>• Pulsing animation for hidden eggs</li>
              <li>• Enhanced glow effects</li>
              <li>• Brightness variations</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Quest Configuration Tips -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-yellow-400">💡 Quest Configuration Tips</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-blue-400 mb-2">Beginner Quests</h4>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>• Movement: Random Jump</li>
              <li>• Speed: Normal Hunter</li>
              <li>• Cheese Count: 1-2</li>
              <li>• Hidden Areas: Disabled</li>
            </ul>
          </div>
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-purple-400 mb-2">Advanced Quests</h4>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>• Movement: Sneaky or Corner Lurker</li>
              <li>• Speed: Fast & Sneaky</li>
              <li>• Cheese Count: 3-5</li>
              <li>• Hidden Areas: Enabled</li>
            </ul>
          </div>
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-red-400 mb-2">Expert Quests</h4>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>• Movement: Corner Lurker</li>
              <li>• Speed: Fast & Sneaky</li>
              <li>• Cheese Count: 5-10</li>
              <li>• Hidden Areas: Enabled</li>
              <li>• Screenshot: Required</li>
            </ul>
          </div>
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-yellow-400 mb-2">Tournament Quests</h4>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>• Movement: Corner Lurker</li>
              <li>• Speed: Fast & Sneaky</li>
              <li>• Cheese Count: 8-10</li>
              <li>• Hidden Areas: Enabled</li>
              <li>• Discord Ticket: Required</li>
              <li>• Screenshot: Required</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Technical Details -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3 text-yellow-400">🔧 Technical Implementation Details</h3>
        <div class="space-y-3">
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-green-400 mb-2">Positioning Algorithm</h4>
            <p class="text-gray-300 text-sm">Uses seeded random number generation with session-based offsets</p>
            <code class="text-xs text-gray-400 block mt-2">seededRandom(min, max) = sessionSeed + timeOffset</code>
          </div>
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-blue-400 mb-2">Movement Area</h4>
            <p class="text-gray-300 text-sm">Extended area: 2x viewport width, 3x viewport height</p>
            <code class="text-xs text-gray-400 block mt-2">maxLeft = viewportWidth * 2, maxTop = documentHeight * 1.5</code>
          </div>
          <div class="bg-gray-700 p-3 rounded">
            <h4 class="font-semibold text-purple-400 mb-2">Difficulty Scaling</h4>
            <p class="text-gray-300 text-sm">Time-based multiplier increases over 5 minutes</p>
            <code class="text-xs text-gray-400 block mt-2">difficultyMultiplier = 1 + (timeSincePageLoad / 300000)</code>
          </div>
        </div>
      </div>
    </div>

    <!-- Holder Verification Tab -->
    <div class="admin-card mb-6" id="holderVerificationTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">🎴 Holder Verification Management</h2>
      
      <!-- Overview Section -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-purple-400">📊 Holder Verification Overview</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-400" id="totalVerifications">-</div>
            <div class="text-sm text-gray-300">Total Verifications</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-400" id="successfulVerifications">-</div>
            <div class="text-sm text-gray-300">Successful</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-400" id="totalNFTs">-</div>
            <div class="text-sm text-gray-300">Total NFTs</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-yellow-400" id="activeRoles">-</div>
            <div class="text-sm text-gray-300">Active Roles</div>
          </div>
        </div>
      </div>

      <!-- Verification Management -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        
        <!-- View Verifications -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3 text-blue-400">🔍 View Verifications</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Filter by Collection:</label>
              <select id="verificationCollectionFilter" class="w-full px-3 py-2 rounded text-gray-800">
                <option value="">All Collections</option>
                <option value="genesis">🧠 Genesis Collection</option>
                <option value="vip">🎴 VIP Collection</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Filter by Status:</label>
              <select id="verificationStatusFilter" class="w-full px-3 py-2 rounded text-gray-800">
                <option value="">All Statuses</option>
                <option value="1">✅ Role Granted</option>
                <option value="0">❌ Role Not Granted</option>
              </select>
            </div>
            <button onclick="loadVerifications()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
              🔍 Load Verifications
            </button>
          </div>
          
          <div class="mt-4">
            <div id="verificationsList" class="space-y-2 max-h-64 overflow-y-auto">
              <div class="text-gray-400 text-center py-4">Click "Load Verifications" to view data</div>
            </div>
          </div>
        </div>

        <!-- NFT Ownership Management -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3 text-green-400">🎴 NFT Ownership Management</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Wallet Address:</label>
              <input type="text" id="nftWalletAddress" placeholder="Enter wallet address" class="w-full px-3 py-2 rounded text-gray-800">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Collection:</label>
              <select id="nftCollection" class="w-full px-3 py-2 rounded text-gray-800">
                <option value="genesis">🧠 Genesis Collection</option>
                <option value="vip">🎴 VIP Collection</option>
              </select>
            </div>
            <button onclick="searchNFTs()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
              🔍 Search NFTs
            </button>
          </div>
          
          <div class="mt-4">
            <div id="nftSearchResults" class="space-y-2 max-h-64 overflow-y-auto">
              <div class="text-gray-400 text-center py-4">Search for NFTs to view ownership</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Role Management -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-yellow-400">🏆 Role Management</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <!-- Role Granting -->
          <div>
            <h4 class="text-md font-semibold mb-3 text-green-400">Grant Roles</h4>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Search User:</label>
                <div class="flex gap-2">
                  <input type="text" id="holderUserSearch" placeholder="Search by Discord ID or username" class="flex-1 px-3 py-2 rounded text-gray-800" oninput="searchHolderUsersInstant(this.value)">
                  <button onclick="searchHolderUsers()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">Search</button>
                </div>
                <div id="holderUserSearchResults" class="mt-2 max-h-32 overflow-y-auto bg-gray-700 rounded p-2 hidden">
                  <div class="text-gray-400 text-sm">Enter at least 2 characters to search...</div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Discord User ID:</label>
                <input type="text" id="roleUserId" placeholder="Enter Discord user ID" class="w-full px-3 py-2 rounded text-gray-800">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Role to Grant:</label>
                <select id="roleToGrant" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="1402668301414563971">🏆 Holder (1402668301414563971)</option>
                  <option value="1332016526848692345">🎴 VIP Holder (1332016526848692345)</option>
                  <option value="1332108350518857842">🧀 Cheese Hunter (1332108350518857842)</option>
                  <option value="1332108350518857843">🎯 Alpha Caller (1332108350518857843)</option>
                  <option value="1332108350518857844">🏅 Champion (1332108350518857844)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Reason:</label>
                <input type="text" id="roleGrantReason" placeholder="Reason for role grant" class="w-full px-3 py-2 rounded text-gray-800">
              </div>
              <button onclick="grantRole()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                ✅ Grant Role
              </button>
            </div>
          </div>

          <!-- Role Revoking -->
          <div>
            <h4 class="text-md font-semibold mb-3 text-red-400">Revoke Roles</h4>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Search User:</label>
                <div class="flex gap-2">
                  <input type="text" id="revokeUserSearch" placeholder="Search by Discord ID or username" class="flex-1 px-3 py-2 rounded text-gray-800" oninput="searchRevokeUsersInstant(this.value)">
                  <button onclick="searchRevokeUsers()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">Search</button>
                </div>
                <div id="revokeUserSearchResults" class="mt-2 max-h-32 overflow-y-auto bg-gray-700 rounded p-2 hidden">
                  <div class="text-gray-400 text-sm">Enter at least 2 characters to search...</div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Discord User ID:</label>
                <input type="text" id="revokeUserId" placeholder="Enter Discord user ID" class="w-full px-3 py-2 rounded text-gray-800">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Role to Revoke:</label>
                <select id="roleToRevoke" class="w-full px-3 py-2 rounded text-gray-800">
                  <option value="1402668301414563971">🏆 Holder (1402668301414563971)</option>
                  <option value="1332016526848692345">🎴 VIP Holder (1332016526848692345)</option>
                  <option value="1332108350518857842">🧀 Cheese Hunter (1332108350518857842)</option>
                  <option value="1332108350518857843">🎯 Alpha Caller (1332108350518857843)</option>
                  <option value="1332108350518857844">🏅 Champion (1332108350518857844)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Reason:</label>
                <input type="text" id="roleRevokeReason" placeholder="Reason for role revocation" class="w-full px-3 py-2 rounded text-gray-800">
              </div>
              <button onclick="revokeRole()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                ❌ Revoke Role
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Verification Log -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3 text-blue-400">📋 Verification Log</h3>
        <div id="verificationLog" class="bg-gray-900 p-4 rounded text-sm font-mono h-32 overflow-y-auto">
          <div class="text-blue-400">🔄 Holder verification system ready...</div>
        </div>
      </div>

      <!-- Role Grant History -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mt-6">
        <h3 class="text-lg font-semibold mb-3 text-purple-400">📊 Role Grant History</h3>
        <div class="space-y-3 mb-4">
          <div class="flex flex-wrap gap-2">
            <button onclick="loadRoleHistory('all')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
              All Actions
            </button>
            <button onclick="loadRoleHistory('granted')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
              ✅ Granted Only
            </button>
            <button onclick="loadRoleHistory('revoked')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
              ❌ Revoked Only
            </button>
          </div>
          <div class="flex gap-2">
            <input type="text" id="historyUserSearch" placeholder="Search by user ID or username" class="flex-1 px-3 py-2 rounded text-gray-800 text-sm">
            <button onclick="searchRoleHistory()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
              Search
            </button>
          </div>
        </div>
        
        <div id="roleHistoryList" class="space-y-2 max-h-64 overflow-y-auto">
          <div class="text-gray-400 text-center py-4">Click "All Actions" to view role grant history</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Global variables
    let currentAdmin = null;
    let currentTab = 'dashboard';
    let searchTimeout = null;

    // Initialize the interface
    document.addEventListener('DOMContentLoaded', async function() {
      setTimeout(async () => {
        updateDisplay();
        
        // Add event listener for quest type input
        const questTypeInput = document.getElementById('newQuestType');
        console.log('🧀 Setting up quest type input listener on:', questTypeInput);
        questTypeInput.addEventListener('input', toggleCheeseQuestConfig);
        console.log('🧀 Event listener attached successfully');
        
        // Check for existing Discord authentication first
        const discordAuthResult = await checkDiscordAuth();
        
        if (!discordAuthResult) {
          // Only load dashboard data if not auto-authenticated
          loadDashboardData();
          addLog('🎯 Admin interface loaded successfully');
          addLog('🔐 Please authenticate to access admin features');
        }
      }, 100);
    });

    // Update Discord display
    function updateDisplay() {
      document.getElementById('currentCode').textContent = DISCORD_CONFIG.inviteCode;
      document.getElementById('currentUrl').textContent = DISCORD_CONFIG.getCurrentUrl();
      document.getElementById('systemVersion').textContent = DISCORD_CONFIG.version;
      document.getElementById('lastUpdated').textContent = DISCORD_CONFIG.lastUpdated;
    }

    // Load dashboard data
    async function loadDashboardData() {
      try {
        // Load basic stats (always visible)
        const statsResponse = await fetch('/api/admin/get-stats.php');
        const stats = await statsResponse.json();
        
        if (stats.success) {
          document.getElementById('totalUsers').textContent = stats.totalUsers;
          document.getElementById('totalScores').textContent = stats.totalScores;
          document.getElementById('totalItems').textContent = stats.totalItems;
          document.getElementById('activeQuests').textContent = stats.activeQuests;
          
          // Update detailed stats (only for authenticated users)
          if (currentAdmin) {
            document.getElementById('totalUsersDetail').textContent = stats.totalUsers;
            document.getElementById('totalScoresDetail').textContent = stats.totalScores;
            document.getElementById('totalItemsDetail').textContent = stats.totalItems;
            document.getElementById('activeQuestsDetail').textContent = stats.activeQuests;
          } else {
            // Hide sensitive stats for non-authenticated users
            document.getElementById('totalUsersDetail').textContent = '🔒';
            document.getElementById('totalScoresDetail').textContent = '🔒';
            document.getElementById('totalItemsDetail').textContent = stats.totalItems; // Keep visible
            document.getElementById('activeQuestsDetail').textContent = stats.activeQuests; // Keep visible
          }
        }

        // Load cheese click statistics (only for authenticated users)
        if (currentAdmin) {
          const cheeseStatsResponse = await fetch('/api/admin/get-cheese-stats.php');
          const cheeseStats = await cheeseStatsResponse.json();
          
          if (cheeseStats.success) {
            const stats = cheeseStats.stats;
            
            // Update cheese click stats
            document.getElementById('totalCheeseClicks').textContent = stats.total_clicks;
            document.getElementById('recentCheeseClicks').textContent = stats.recent_clicks_24h;
            
            // Top cheese clicker
            const topClicker = stats.top_clicker;
            const topClickerElement = document.getElementById('topCheeseUser');
            
            if (topClicker) {
              const username = topClicker.username || 'Anonymous Mouse';
              const displayName = username.length > 15 ? username.substring(0, 15) + '...' : username;
              const walletShort = topClicker.user_wallet.substring(0, 8) + '...';
              
              topClickerElement.innerHTML = `
                <a href="/profile.html?user_id=${encodeURIComponent(topClicker.user_wallet)}" 
                   class="text-orange-400 hover:text-orange-300 underline cursor-pointer" 
                   title="View ${username}'s profile">
                  ${displayName} (${walletShort})
                </a>
              `;
            } else {
              topClickerElement.textContent = 'None';
            }
            
            // Most clicked cheese
            const mostClicked = stats.clicks_by_egg.length > 0 ? stats.clicks_by_egg[0] : null;
            document.getElementById('mostClickedCheese').textContent = mostClicked ? 
              mostClicked.egg_id : 'None';
            
            // Display detailed cheese stats
            displayCheeseClicksByType(stats.clicks_by_egg);
            displayTopCheeseClickers(stats.top_users);
          }
        } else {
          // Hide cheese stats for non-authenticated users
          document.getElementById('totalCheeseClicks').textContent = '🔒';
          document.getElementById('recentCheeseClicks').textContent = '🔒';
          document.getElementById('topCheeseUser').textContent = '🔒';
          document.getElementById('mostClickedCheese').textContent = '🔒';
          document.getElementById('cheeseClicksByType').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
          document.getElementById('topCheeseClickers').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
        }

        // Load quest and role statistics (only for authenticated users)
        if (currentAdmin) {
          const questStatsResponse = await fetch('/api/admin/get-quest-stats.php');
          const questStats = await questStatsResponse.json();
          
          if (questStats.success) {
            const stats = questStats.stats;
            
            // Update quest stats
            document.getElementById('openQuests').textContent = stats.open_quests;
            document.getElementById('pendingClaims').textContent = stats.pending_claims;
            document.getElementById('completedQuests').textContent = stats.completed_quests;
            document.getElementById('rolesGranted').textContent = stats.roles_granted;
            
            // Display detailed quest stats
            displayRecentQuestClaims(stats.recent_claims);
            displayActiveQuestsByType(stats.active_quests_by_type);
          }
        } else {
          // Hide quest stats for non-authenticated users
          document.getElementById('openQuests').textContent = '🔒';
          document.getElementById('pendingClaims').textContent = '🔒';
          document.getElementById('completedQuests').textContent = '🔒';
          document.getElementById('rolesGranted').textContent = '🔒';
          document.getElementById('recentQuestClaims').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
          document.getElementById('activeQuestsByType').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
        }

        // Load recent adjustments (only for authenticated users)
        if (currentAdmin) {
          const adjustmentsResponse = await fetch('/api/admin/get-recent-adjustments.php');
          const adjustments = await adjustmentsResponse.json();
          
          if (adjustments.success) {
            displayRecentAdjustments(adjustments.adjustments);
          }
        } else {
          document.getElementById('recentAdjustments').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
        }

        // Load top users (only for authenticated users)
        if (currentAdmin) {
          const topUsersResponse = await fetch('/api/admin/get-top-users.php');
          const topUsers = await topUsersResponse.json();
          
          if (topUsers.success) {
            displayTopUsers(topUsers.users);
          }
        } else {
          document.getElementById('topUsers').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
        }

        // Load enhanced statistics (only for authenticated users)
        if (currentAdmin) {
          try {
            const enhancedStatsResponse = await fetch('/api/admin/get-enhanced-stats.php');
            const enhancedStats = await enhancedStatsResponse.json();
            
            if (enhancedStats.success) {
              const stats = enhancedStats;
              
              // Update immediate stats
              document.getElementById('avgClicksPerUser').textContent = stats.immediate_stats.average_clicks_per_user;
              document.getElementById('totalDSPOINC').textContent = stats.immediate_stats.total_dspoinc_circulation.toLocaleString();
              document.getElementById('questCompletionRate').textContent = stats.immediate_stats.quest_completion_rate + '%';
              document.getElementById('avgQuestReward').textContent = stats.immediate_stats.average_quest_reward.toLocaleString();
              
              // Update daily stats
              document.getElementById('clicksLast24h').textContent = stats.daily_stats.clicks_last_24h;
              document.getElementById('newUsersToday').textContent = stats.daily_stats.new_users_today;
              document.getElementById('questsClaimedToday').textContent = stats.daily_stats.quests_claimed_today;
              document.getElementById('rolesGrantedToday').textContent = stats.daily_stats.roles_granted_today;
              
              // Display engagement stats
              displayEngagementStats(stats.engagement_stats);
              
              // Display wealth stats
              displayWealthStats(stats.wealth_distribution);
            } else {
              addLog(`❌ Enhanced stats error: ${enhancedStats.error}`);
              // Set default values on error
              setDefaultEnhancedStats();
            }
          } catch (error) {
            addLog(`❌ Enhanced stats loading error: ${error.message}`);
            // Set default values on error
            setDefaultEnhancedStats();
          }
        } else {
          // Hide enhanced stats for non-authenticated users
          document.getElementById('avgClicksPerUser').textContent = '🔒';
          document.getElementById('totalDSPOINC').textContent = '🔒';
          document.getElementById('questCompletionRate').textContent = '🔒';
          document.getElementById('avgQuestReward').textContent = '🔒';
          document.getElementById('clicksLast24h').textContent = '🔒';
          document.getElementById('newUsersToday').textContent = '🔒';
          document.getElementById('questsClaimedToday').textContent = '🔒';
          document.getElementById('rolesGrantedToday').textContent = '🔒';
          document.getElementById('engagementStats').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
          document.getElementById('wealthStats').innerHTML = '<div class="text-gray-400">🔒 Authentication required</div>';
        }
      } catch (error) {
        addLog(`❌ Error loading dashboard data: ${error.message}`);
      }
    }

    // Display cheese clicks by type
    function displayCheeseClicksByType(clicksByEgg) {
      const container = document.getElementById('cheeseClicksByType');
      
      if (clicksByEgg.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No cheese clicks recorded</div>';
        return;
      }

      container.innerHTML = clicksByEgg.map(click => `
        <div class="flex justify-between items-center py-1">
          <span class="text-orange-300">${click.egg_id}</span>
          <span class="text-white font-semibold">${click.click_count}</span>
        </div>
      `).join('');
    }

    // Display top cheese clickers
    function displayTopCheeseClickers(topUsers) {
      const container = document.getElementById('topCheeseClickers');
      
      if (topUsers.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No cheese clickers found</div>';
        return;
      }

      container.innerHTML = topUsers.slice(0, 5).map((user, index) => {
        const username = user.username || 'Anonymous Mouse';
        const displayName = username.length > 12 ? username.substring(0, 12) + '...' : username;
        const walletShort = user.user_wallet.substring(0, 8) + '...';
        
        return `
          <div class="flex justify-between items-center py-1">
            <span class="text-orange-300">
              #${index + 1} 
              <a href="/profile.html?user_id=${encodeURIComponent(user.user_wallet)}" 
                 class="hover:text-orange-200 underline cursor-pointer" 
                 title="View ${username}'s profile">
                ${displayName} (${walletShort})
              </a>
            </span>
            <span class="text-white font-semibold">${user.click_count}</span>
          </div>
        `;
      }).join('');
    }

    // Display recent adjustments
    function displayRecentAdjustments(adjustments) {
      const container = document.getElementById('recentAdjustments');
      
      if (adjustments.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No recent adjustments</div>';
        return;
      }

      container.innerHTML = adjustments.map(adj => {
        const amount = parseInt(adj.amount);
        const isPositive = amount > 0;
        const timestamp = new Date(adj.timestamp).toLocaleString();
        
        return `
          <div class="history-item ${isPositive ? 'positive' : 'negative'}">
            <div class="flex justify-between items-start">
              <div>
                <strong>${isPositive ? '+' : ''}${amount.toLocaleString()} $DSPOINC</strong>
                <span class="text-sm text-gray-300 ml-2">(${adj.action})</span>
              </div>
              <div class="text-xs text-gray-400">${timestamp}</div>
            </div>
            <div class="text-sm text-gray-300 mt-1">User: ${adj.user_id}</div>
            <div class="text-sm text-gray-300">Reason: ${adj.reason || 'No reason'}</div>
          </div>
        `;
      }).join('');
    }

    // Display top users
    function displayTopUsers(users) {
      const container = document.getElementById('topUsers');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No users found</div>';
        return;
      }

      container.innerHTML = users.map((user, index) => `
        <div class="user-card">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold">#${index + 1} ${user.username || 'Unknown User'}</h4>
              <p class="text-sm text-gray-300">ID: ${user.user_id}</p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold text-yellow-400">${user.total_score?.toLocaleString() || 0} $DSPOINC</p>
            </div>
          </div>
          <button onclick="selectUser('${user.user_id}', '${user.username || 'Unknown'}')" 
                  class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm w-full">
            Select User
          </button>
        </div>
      `).join('');
    }

    // Display engagement stats
    function displayEngagementStats(engagementStats) {
      const container = document.getElementById('engagementStats');
      
      if (!engagementStats) {
        container.innerHTML = '<div class="text-gray-400">No engagement data available</div>';
        return;
      }

      container.innerHTML = `
        <div class="space-y-2">
          <div class="flex justify-between">
            <span class="text-cyan-300">Power Users (>100 clicks):</span>
            <span class="text-white font-semibold">${engagementStats.power_users}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-cyan-300">Active Users (7 days):</span>
            <span class="text-white font-semibold">${engagementStats.active_users_7_days}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-cyan-300">Retention Rate:</span>
            <span class="text-white font-semibold">${engagementStats.user_retention_rate}%</span>
          </div>
        </div>
      `;
    }

    // Display wealth stats
    function displayWealthStats(wealthStats) {
      const container = document.getElementById('wealthStats');
      
      if (!wealthStats) {
        container.innerHTML = '<div class="text-gray-400">No wealth data available</div>';
        return;
      }

      container.innerHTML = `
        <div class="space-y-2">
          <div class="flex justify-between">
            <span class="text-emerald-300">Highest Balance:</span>
            <span class="text-white font-semibold">${wealthStats.max_balance?.toLocaleString() || 0}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-emerald-300">Lowest Balance:</span>
            <span class="text-white font-semibold">${wealthStats.min_balance?.toLocaleString() || 0}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-emerald-300">Average Balance:</span>
            <span class="text-white font-semibold">${wealthStats.avg_balance?.toLocaleString() || 0}</span>
          </div>
        </div>
      `;
    }

    // Set default enhanced stats on error
    function setDefaultEnhancedStats() {
      document.getElementById('avgClicksPerUser').textContent = '0';
      document.getElementById('totalDSPOINC').textContent = '0';
      document.getElementById('questCompletionRate').textContent = '0%';
      document.getElementById('avgQuestReward').textContent = '0';
      document.getElementById('clicksLast24h').textContent = '0';
      document.getElementById('newUsersToday').textContent = '0';
      document.getElementById('questsClaimedToday').textContent = '0';
      document.getElementById('rolesGrantedToday').textContent = '0';
      document.getElementById('engagementStats').innerHTML = '<div class="text-gray-400">Error loading data</div>';
      document.getElementById('wealthStats').innerHTML = '<div class="text-gray-400">Error loading data</div>';
    }

    // Admin authentication
    async function loginAdmin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        addLog('❌ Please enter username and password');
        return;
      }

      try {
        const response = await fetch('/api/admin/auth.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'login',
            username: username,
            password: password
          })
        });

        const data = await response.json();
        
        if (data.success) {
          currentAdmin = data.user;
          document.getElementById('authPanel').style.display = 'none';
          document.getElementById('navPanel').style.display = 'block';
          
          // Show database unlock section for all authenticated users (but keep options hidden initially)
          document.getElementById('databaseUnlockSection').style.display = 'block';
          document.getElementById('databaseOptions').style.display = 'none';
          document.getElementById('databaseQuickActions').style.display = 'none';
          
          addLog(`✅ Authenticated: ${username} (${data.user.role}) - Database access available with password`);
        } else {
          addLog(`❌ Login failed: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Login error: ${error.message}`);
      }
    }

    // Show user management panel
    function showUserManagement() {
      const panel = document.getElementById('userManagementPanel');
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        loadCurrentUsers();
      } else {
        panel.classList.add('hidden');
      }
    }

    // Load current users
    async function loadCurrentUsers() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        addLog('❌ Please enter your credentials first');
        return;
      }

      try {
        const response = await fetch('/api/admin/auth.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'list_users',
            admin_username: username
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayCurrentUsers(data.users);
        } else {
          addLog(`❌ Failed to load users: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Load users error: ${error.message}`);
      }
    }

    // Display current users
    function displayCurrentUsers(users) {
      const container = document.getElementById('currentUsersList');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="flex justify-between items-center p-2 bg-gray-700 rounded">
          <div>
            <span class="font-semibold">${user.username}</span>
            <span class="text-sm text-gray-300 ml-2">(${user.role})</span>
            ${user.discord_id ? `<span class="text-xs text-gray-400 ml-2">Discord: ${user.discord_id}</span>` : ''}
          </div>
          ${user.username !== 'narrrf' ? `
            <button onclick="removeUser('${user.username}')" 
                    class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm">
              Remove
            </button>
          ` : '<span class="text-xs text-gray-400">Super Admin</span>'}
        </div>
      `).join('');
    }

    // Add new user
    async function addUser() {
      const adminUsername = document.getElementById('loginUsername').value.trim();
      const adminPassword = document.getElementById('loginPassword').value;
      const newUsername = document.getElementById('newUsername').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      const newRole = document.getElementById('newRole').value;
      const newDiscordId = document.getElementById('newDiscordId').value.trim();
      
      if (!adminUsername || !adminPassword || !newUsername || !newPassword) {
        addLog('❌ Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch('/api/admin/auth.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'add_user',
            admin_username: adminUsername,
            new_username: newUsername,
            new_password: newPassword,
            new_role: newRole,
            new_discord_id: newDiscordId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ ${data.message}`);
          // Clear form
          document.getElementById('newUsername').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('newDiscordId').value = '';
          // Reload users list
          loadCurrentUsers();
        } else {
          addLog(`❌ Failed to add user: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Add user error: ${error.message}`);
      }
    }

    // Remove user
    async function removeUser(username) {
      const adminUsername = document.getElementById('loginUsername').value.trim();
      const adminPassword = document.getElementById('loginPassword').value;
      
      if (!confirm(`Are you sure you want to remove user '${username}'?`)) {
        return;
      }

      try {
        const response = await fetch('/api/admin/auth.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'remove_user',
            admin_username: adminUsername,
            remove_username: username
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ ${data.message}`);
          loadCurrentUsers();
        } else {
          addLog(`❌ Failed to remove user: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Remove user error: ${error.message}`);
      }
    }

    // Tab navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const tab = this.dataset.tab;
        
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Hide all tabs
        document.querySelectorAll('[id$="Tab"]').forEach(t => t.style.display = 'none');
        
        // Show selected tab
        document.getElementById(tab + 'Tab').style.display = 'block';
        
        currentTab = tab;
        addLog(`📋 Switched to ${tab} tab`);
        
        // Load tab-specific data
        if (tab === 'store') loadStoreItems();
        if (tab === 'quests') loadQuests();
        if (tab === 'games') {
          loadGameStatistics();
          loadSeasonStats();
          loadGameSettings();
        }
        if (tab === 'holderVerification') loadHolderVerificationData();
      });
    });

    // Instant user search
    function searchUsersInstant(searchTerm) {
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        document.getElementById('userResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/admin/point-management.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'searchuser',
              search: searchTerm
            })
          });

          const data = await response.json();
          
          if (data.success) {
            displayUserResults(data.users);
            addLog(`🔍 Found ${data.users.length} users matching "${searchTerm}"`);
          } else {
            addLog(`❌ Search failed: ${data.error}`);
          }
        } catch (error) {
          addLog(`❌ Search error: ${error.message}`);
        }
      }, 300);
    }

    // Quick instant user search for point management
    function quickSearchUsersInstant(searchTerm) {
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        document.getElementById('quickUserResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/admin/point-management.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'searchuser',
              search: searchTerm
            })
          });

          const data = await response.json();
          
          if (data.success) {
            displayQuickUserResults(data.users);
            addLog(`🔍 Found ${data.users.length} users matching "${searchTerm}"`);
          } else {
            addLog(`❌ Search failed: ${data.error}`);
          }
        } catch (error) {
          addLog(`❌ Search error: ${error.message}`);
        }
      }, 300);
    }

    // User search
    async function searchUsers() {
      const searchTerm = document.getElementById('userSearch').value.trim();
      if (!searchTerm) {
        addLog('❌ Please enter a search term');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'searchuser',
            search: searchTerm
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayUserResults(data.users);
          addLog(`🔍 Found ${data.users.length} users matching "${searchTerm}"`);
        } else {
          addLog(`❌ Search failed: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Search error: ${error.message}`);
      }
    }

    // Display user search results
    function displayUserResults(users) {
      const container = document.getElementById('userResults');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="user-card">
          <h4 class="font-semibold mb-2">${user.username || 'Unknown User'}</h4>
          <p class="text-sm text-gray-300 mb-2">ID: ${user.user_id}</p>
          <p class="text-sm text-yellow-400 mb-3">Balance: ${user.score?.toLocaleString() || 0} $DSPOINC</p>
          <div class="flex gap-2">
            <button onclick="selectUser('${user.user_id}', '${user.username || 'Unknown'}')" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
              Select User
            </button>
            <button onclick="loadUserAdjustments('${user.user_id}', '${user.username || 'Unknown'}')" 
                    class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
              View Adjustments
            </button>
          </div>
        </div>
      `).join('');
    }

    // Display quick user search results for point management
    function displayQuickUserResults(users) {
      const container = document.getElementById('quickUserResults');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="user-card mb-2">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold">${user.username || 'Unknown User'}</h4>
              <p class="text-sm text-gray-300">ID: ${user.user_id}</p>
              <p class="text-sm text-yellow-400">Balance: ${user.score?.toLocaleString() || 0} $DSPOINC</p>
            </div>
            <button onclick="quickSelectUserFromResults('${user.user_id}', '${user.username || 'Unknown'}', ${user.score || 0})" 
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
              Select
            </button>
          </div>
        </div>
      `).join('');
    }

    // Quick user selection from search results
    function quickSelectUserFromResults(userId, username, balance) {
      selectUser(userId, username);
      
      const infoDiv = document.getElementById('selectedUserInfo');
      infoDiv.innerHTML = `
        <div class="text-green-400">
          <strong>Selected User:</strong> ${username}<br>
          <strong>Balance:</strong> ${balance.toLocaleString()} $DSPOINC
        </div>
      `;
      infoDiv.classList.remove('hidden');
      
      // Clear the search results
      document.getElementById('quickUserResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
      
      addLog(`👤 Selected user: ${username} (${balance.toLocaleString()} $DSPOINC)`);
    }

    // Give Item user search functionality
    function giveItemSearchUsersInstant(searchTerm) {
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        document.getElementById('giveItemUserResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
        document.getElementById('giveItemUserResults').style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/admin/point-management.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'searchuser',
              search: searchTerm
            })
          });

          const data = await response.json();
          
          if (data.success) {
            displayGiveItemUserResults(data.users);
            document.getElementById('giveItemUserResults').style.display = 'block';
          } else {
            document.getElementById('giveItemUserResults').innerHTML = '<div class="text-gray-300">Search failed</div>';
            document.getElementById('giveItemUserResults').style.display = 'block';
          }
        } catch (error) {
          document.getElementById('giveItemUserResults').innerHTML = '<div class="text-gray-300">Search error</div>';
          document.getElementById('giveItemUserResults').style.display = 'block';
        }
      }, 300);
    }

    // Display Give Item user search results
    function displayGiveItemUserResults(users) {
      const container = document.getElementById('giveItemUserResults');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300 p-2">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="p-2 hover:bg-gray-600 cursor-pointer border-b border-gray-600" onclick="selectGiveItemUser('${user.user_id}', '${user.username || 'Unknown'}')">
          <div class="font-semibold text-white">${user.username || 'Unknown User'}</div>
          <div class="text-sm text-gray-300">ID: ${user.user_id}</div>
          <div class="text-sm text-yellow-400">Balance: ${user.score?.toLocaleString() || 0} $DSPOINC</div>
        </div>
      `).join('');
    }

    // Select user for Give Item
    function selectGiveItemUser(userId, username) {
      document.getElementById('giveItemUserId').value = userId;
      document.getElementById('giveItemUserResults').style.display = 'none';
      addLog(`✅ Selected user for Give Item: ${username} (${userId})`);
    }

    // View Inventory user search functionality
    function viewInventorySearchUsersInstant(searchTerm) {
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        document.getElementById('viewInventoryUserResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
        document.getElementById('viewInventoryUserResults').style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/admin/point-management.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'searchuser',
              search: searchTerm
            })
          });

          const data = await response.json();
          
          if (data.success) {
            displayViewInventoryUserResults(data.users);
            document.getElementById('viewInventoryUserResults').style.display = 'block';
          } else {
            document.getElementById('viewInventoryUserResults').innerHTML = '<div class="text-gray-300">Search failed</div>';
            document.getElementById('viewInventoryUserResults').style.display = 'block';
          }
        } catch (error) {
          document.getElementById('viewInventoryUserResults').innerHTML = '<div class="text-gray-300">Search error</div>';
          document.getElementById('viewInventoryUserResults').style.display = 'block';
        }
      }, 300);
    }

    // Display View Inventory user search results
    function displayViewInventoryUserResults(users) {
      const container = document.getElementById('viewInventoryUserResults');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300 p-2">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="p-2 hover:bg-gray-600 cursor-pointer border-b border-gray-600" onclick="selectViewInventoryUser('${user.user_id}', '${user.username || 'Unknown'}')">
          <div class="font-semibold text-white">${user.username || 'Unknown User'}</div>
          <div class="text-sm text-gray-300">ID: ${user.user_id}</div>
          <div class="text-sm text-yellow-400">Balance: ${user.score?.toLocaleString() || 0} $DSPOINC</div>
        </div>
      `).join('');
    }

    // Select user for View Inventory
    function selectViewInventoryUser(userId, username) {
      document.getElementById('viewInventoryUserId').value = userId;
      document.getElementById('viewInventoryUserResults').style.display = 'none';
      addLog(`✅ Selected user for View Inventory: ${username} (${userId})`);
    }

    // Quick user selection
    async function quickSelectUser() {
      const userId = document.getElementById('quickUserId').value.trim();
      
      if (!userId) {
        addLog('❌ Please enter a user ID');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getbalance',
            user_id: userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          selectUser(userId, `User ${userId}`);
          const infoDiv = document.getElementById('selectedUserInfo');
          infoDiv.innerHTML = `
            <div class="text-green-400">
              <strong>Selected User:</strong> ${userId}<br>
              <strong>Balance:</strong> ${data.balance.toLocaleString()} $DSPOINC
            </div>
          `;
          infoDiv.classList.remove('hidden');
          addLog(`👤 Selected user: ${userId} (${data.balance.toLocaleString()} $DSPOINC)`);
        } else {
          addLog(`❌ User not found: ${userId}`);
        }
      } catch (error) {
        addLog(`❌ Error selecting user: ${error.message}`);
      }
    }

    // Select user for point operations
    function selectUser(userId, username) {
      // Fill all point operation forms with this user
      document.getElementById('addUserId').value = userId;
      document.getElementById('setUserId').value = userId;
      document.getElementById('removeUserId').value = userId;
      document.getElementById('balanceUserId').value = userId;
      document.getElementById('historyUserId').value = userId;
      document.getElementById('quickUserId').value = userId;
      
      // Clear search results
      if (document.getElementById('quickUserResults')) {
        document.getElementById('quickUserResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
      }
      
      addLog(`👤 Selected user: ${username} (${userId})`);
    }

    // Add points
    async function addPoints() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate as admin first');
        return;
      }

      const userId = document.getElementById('addUserId').value.trim();
      const amount = parseInt(document.getElementById('addAmount').value);
      const reason = document.getElementById('addReason').value.trim() || 'Manual admin adjustment';

      if (!userId || !amount || amount <= 0) {
        addLog('❌ Please enter valid user ID and amount');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'addpoints',
            admin_id: currentAdmin.discord_id,
            user_id: userId,
            amount: amount,
            reason: reason
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ ${data.message} - New balance: ${data.new_balance.toLocaleString()} $DSPOINC`);
          // Clear form
          document.getElementById('addAmount').value = '';
          document.getElementById('addReason').value = '';
          // Reload dashboard data
          loadDashboardData();
        } else {
          addLog(`❌ Failed to add points: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Add points error: ${error.message}`);
      }
    }

    // Set points
    async function setPoints() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate as admin first');
        return;
      }

      const userId = document.getElementById('setUserId').value.trim();
      const amount = parseInt(document.getElementById('setAmount').value);
      const reason = document.getElementById('setReason').value.trim() || 'Manual set by admin';

      if (!userId || amount < 0) {
        addLog('❌ Please enter valid user ID and amount');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'setpoints',
            admin_id: currentAdmin.discord_id,
            user_id: userId,
            amount: amount,
            reason: reason
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ ${data.message}`);
          // Clear form
          document.getElementById('setAmount').value = '';
          document.getElementById('setReason').value = '';
          // Reload dashboard data
          loadDashboardData();
        } else {
          addLog(`❌ Failed to set points: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Set points error: ${error.message}`);
      }
    }

    // Remove points
    async function removePoints() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate as admin first');
        return;
      }

      const userId = document.getElementById('removeUserId').value.trim();
      const amount = parseInt(document.getElementById('removeAmount').value);
      const reason = document.getElementById('removeReason').value.trim() || 'Manual admin adjustment';

      if (!userId || !amount || amount <= 0) {
        addLog('❌ Please enter valid user ID and amount');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'removepoints',
            admin_id: currentAdmin.discord_id,
            user_id: userId,
            amount: amount,
            reason: reason
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ ${data.message} - New balance: ${data.new_balance.toLocaleString()} $DSPOINC`);
          // Clear form
          document.getElementById('removeAmount').value = '';
          document.getElementById('removeReason').value = '';
          // Reload dashboard data
          loadDashboardData();
        } else {
          addLog(`❌ Failed to remove points: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Remove points error: ${error.message}`);
      }
    }

    // Check balance
    async function checkBalance() {
      const userId = document.getElementById('balanceUserId').value.trim();
      
      if (!userId) {
        addLog('❌ Please enter a user ID');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getbalance',
            user_id: userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          const resultDiv = document.getElementById('balanceResult');
          resultDiv.innerHTML = `
            <div class="text-green-400">
              <strong>User ID:</strong> ${data.user_id}<br>
              <strong>Balance:</strong> ${data.balance.toLocaleString()} $DSPOINC
            </div>
          `;
          resultDiv.classList.remove('hidden');
          addLog(`💳 Balance for ${userId}: ${data.balance.toLocaleString()} $DSPOINC`);
        } else {
          addLog(`❌ Failed to get balance: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Check balance error: ${error.message}`);
      }
    }

    // Get transaction history
    async function getHistory() {
      const userId = document.getElementById('historyUserId').value.trim();
      
      if (!userId) {
        addLog('❌ Please enter a user ID');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'gethistory',
            user_id: userId,
            limit: 20
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayHistory(data.history);
          addLog(`📋 Retrieved ${data.history.length} transactions for ${userId}`);
        } else {
          addLog(`❌ Failed to get history: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Get history error: ${error.message}`);
      }
    }

    // Display transaction history
    function displayHistory(history) {
      const container = document.getElementById('historyResult');
      
      if (history.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No transaction history found.</div>';
        return;
      }

      container.innerHTML = history.map(item => {
        const amount = parseInt(item.amount);
        const isPositive = amount > 0;
        const timestamp = new Date(item.timestamp).toLocaleString();
        
        return `
          <div class="history-item ${isPositive ? 'positive' : 'negative'}">
            <div class="flex justify-between items-start">
              <div>
                <strong>${isPositive ? '+' : ''}${amount.toLocaleString()} $DSPOINC</strong>
                <span class="text-sm text-gray-300 ml-2">(${item.action})</span>
              </div>
              <div class="text-xs text-gray-400">${timestamp}</div>
            </div>
            <div class="text-sm text-gray-300 mt-1">Reason: ${item.reason || 'No reason provided'}</div>
            <div class="text-xs text-gray-500">Admin: ${item.admin_id}</div>
          </div>
        `;
      }).join('');
    }

    // Load store items
    async function loadStoreItems() {
      try {
        const response = await fetch('/api/store/items.php');
        const data = await response.json();
        
        if (data.success) {
          displayStoreItems(data.items);
          addLog(`🏪 Loaded ${data.items.length} store items`);
        } else {
          addLog(`❌ Failed to load store items: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Store items error: ${error.message}`);
      }
    }

    // Display store items
    function displayStoreItems(items) {
      const container = document.getElementById('storeItems');
      
      if (items.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No store items found</div>';
        return;
      }

      container.innerHTML = items.map(item => `
        <div class="user-card">
          <h4 class="font-semibold mb-2">${item.item_name}</h4>
          <p class="text-sm text-gray-300 mb-2">${item.description || 'No description'}</p>
          <p class="text-lg font-bold text-yellow-400 mb-3">${item.price?.toLocaleString() || 0} $DSPOINC</p>
          <div class="flex gap-2">
            <button onclick="editStoreItem(${item.item_id})" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
              Edit
            </button>
            <button onclick="deleteStoreItem(${item.item_id})" 
                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
              Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // Edit store item (placeholder for future implementation)
    function editStoreItem(itemId) {
      addLog(`🔄 Edit store item functionality coming soon! Item ID: ${itemId}`);
      // TODO: Implement edit store item modal/form
    }

    // Delete store item
    async function deleteStoreItem(itemId) {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      if (!confirm('Are you sure you want to delete this store item?')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/store-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'delete_item',
            item_id: itemId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ Store item deleted successfully!`);
          loadStoreItems();
        } else {
          addLog(`❌ Failed to delete store item: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Store item deletion error: ${error.message}`);
      }
    }

    // Load quests
    async function loadQuests() {
      try {
        const response = await fetch('/api/admin/get-quests.php');
        const data = await response.json();
        
        if (data.success) {
          displayQuests(data.quests);
          addLog(`🏆 Loaded ${data.quests.length} quests`);
        } else {
          addLog(`❌ Failed to load quests: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Quests error: ${error.message}`);
      }
    }

    // Display quests
    function displayQuests(quests) {
      const container = document.getElementById('activeQuestsList');
      
      if (quests.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No active quests found</div>';
        return;
      }

      container.innerHTML = quests.map(quest => `
        <div class="user-card">
          <h4 class="font-semibold mb-2">${quest.type}</h4>
          <p class="text-sm text-gray-300 mb-2">${quest.description || 'No description'}</p>
          <p class="text-lg font-bold text-yellow-400 mb-3">${quest.reward?.toLocaleString() || 0} $DSPOINC</p>
          <div class="flex gap-2">
            <button onclick="editQuest(${quest.quest_id})" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
              Edit
            </button>
            <button onclick="deleteQuest(${quest.quest_id})" 
                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
              Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // Create quest - REMOVED OLD VERSION, using enhanced version below
    
    // Show/hide cheese quest configuration based on quest type
    function toggleCheeseQuestConfig() {
      const questType = document.getElementById('newQuestType').value.trim();
      const cheeseConfig = document.getElementById('cheeseQuestConfig');
      
      console.log('🧀 toggleCheeseQuestConfig called with:', questType);
      console.log('🧀 cheeseConfig element:', cheeseConfig);
      
      if (questType === 'cheese_hunt') {
        cheeseConfig.style.display = 'block';
        addLog('🧀 Cheese hunt configuration enabled');
        console.log('🧀 Cheese config should now be visible');
      } else {
        cheeseConfig.style.display = 'none';
        console.log('🧀 Cheese config hidden');
      }
    }

    // Edit quest (placeholder for future implementation)
    function editQuest(questId) {
      addLog(`🔄 Edit quest functionality coming soon! Quest ID: ${questId}`);
      // TODO: Implement edit quest modal/form
    }

    // Delete quest
    async function deleteQuest(questId) {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      if (!confirm('Are you sure you want to delete this quest?')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/create-quest.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'delete',
            quest_id: questId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ Quest deleted successfully!`);
          loadQuests();
        } else {
          addLog(`❌ Failed to delete quest: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Quest deletion error: ${error.message}`);
      }
    }

    // Store Management Functions
    async function loadStoreItems() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      try {
        const response = await fetch('/api/store/items.php');
        const data = await response.json();
        
        if (data.success) {
          displayStoreItems(data.items);
        } else {
          addLog(`❌ Failed to load store items: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Store items loading error: ${error.message}`);
      }
    }

    function displayStoreItems(items) {
      const container = document.getElementById('storeItems');
      
      if (!items || items.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No store items found.</div>';
        return;
      }

      container.innerHTML = items.map(item => `
        <div class="bg-gray-700 p-4 rounded-lg">
          <h4 class="font-semibold text-white mb-2">${item.item_name}</h4>
          <p class="text-gray-300 text-sm mb-2">${item.description || 'No description'}</p>
          <p class="text-yellow-400 font-semibold">${item.price.toLocaleString()} $DSPOINC</p>
          <div class="flex gap-2 mt-3">
            <button onclick="editStoreItem(${item.item_id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Edit</button>
            <button onclick="deleteStoreItem(${item.item_id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">Delete</button>
          </div>
        </div>
      `).join('');
    }

    async function createStoreItem() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const name = document.getElementById('newItemName').value.trim();
      const description = document.getElementById('newItemDescription').value.trim();
      const price = parseInt(document.getElementById('newItemPrice').value);
      const imageUrl = document.getElementById('newItemImageUrl').value.trim();

      if (!name || !description || !price || price <= 0) {
        addLog('❌ Please fill in all required fields: Name, Description, and Price (must be positive)');
        return;
      }

      try {
        const response = await fetch('/api/admin/store-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create_item',
            name: name,
            description: description,
            price: price,
            image_url: imageUrl,
            created_by: currentAdmin.discord_id
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ Store item created successfully! ID: ${data.item_id}`);
          
          // Clear form
          document.getElementById('newItemName').value = '';
          document.getElementById('newItemDescription').value = '';
          document.getElementById('newItemPrice').value = '';
          document.getElementById('newItemImageUrl').value = '';
          
          // Reload store items
          loadStoreItems();
        } else {
          addLog(`❌ Failed to create store item: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Store item creation error: ${error.message}`);
      }
    }

    async function giveItemToUser() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const userId = document.getElementById('giveItemUserId').value.trim();
      const itemName = document.getElementById('giveItemName').value.trim();
      const quantity = parseInt(document.getElementById('giveItemQuantity').value);

      if (!userId || !itemName || !quantity || quantity <= 0) {
        addLog('❌ Please fill in all required fields: User ID, Item Name, and Quantity (must be positive)');
        return;
      }

      try {
        const response = await fetch('/api/admin/store-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'give_item',
            user_id: userId,
            item_name: itemName,
            quantity: quantity,
            given_by: currentAdmin.discord_id
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ Successfully gave ${quantity}x ${itemName} to user ${userId}`);
          
          // Clear form
          document.getElementById('giveItemUserId').value = '';
          document.getElementById('giveItemName').value = '';
          document.getElementById('giveItemQuantity').value = '1';
        } else {
          addLog(`❌ Failed to give item: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Give item error: ${error.message}`);
      }
    }

    async function viewUserInventory() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const userId = document.getElementById('viewInventoryUserId').value.trim();

      if (!userId) {
        addLog('❌ Please enter a user ID or username');
        return;
      }

      try {
        const response = await fetch(`/api/admin/store-management.php?action=get_user_inventory&user_id=${encodeURIComponent(userId)}`);
        const data = await response.json();
        
        if (data.success) {
          displayUserInventory(data.items, userId);
        } else {
          addLog(`❌ Failed to load user inventory: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ User inventory loading error: ${error.message}`);
      }
    }

    function displayUserInventory(items, userId) {
      const container = document.getElementById('userInventoryList');
      
      if (!items || items.length === 0) {
        container.innerHTML = `<div class="text-gray-300">No items found for user ${userId}.</div>`;
        return;
      }

      container.innerHTML = `
        <div class="bg-gray-700 p-4 rounded-lg">
          <h4 class="font-semibold text-white mb-3">Inventory for ${userId}</h4>
          <div class="space-y-2">
            ${items.map(item => `
              <div class="flex justify-between items-center bg-gray-600 p-2 rounded">
                <div>
                  <span class="font-semibold text-white">${item.item_name}</span>
                  <span class="text-gray-300 text-sm ml-2">x${item.quantity}</span>
                </div>
                <span class="text-gray-300 text-sm">${item.description || ''}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Edit store item (placeholder for future implementation)
    function editStoreItem(itemId) {
      addLog(`🔄 Edit store item functionality coming soon! Item ID: ${itemId}`);
      // TODO: Implement edit store item modal/form
    }

    // Delete store item functionality is already implemented above

    // Update invite code
    async function updateInviteCode() {
      const newCode = document.getElementById('newInviteCode').value.trim();
      if (!newCode) {
        addLog('❌ Please enter a valid invite code');
        return;
      }

      if (!currentAdmin) {
        addLog('❌ Please authenticate as admin first');
        return;
      }

      try {
        const response = await fetch('/api/admin/update-discord-invite.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            admin_username: currentAdmin.username,
            new_invite_code: newCode
          })
        });

        const data = await response.json();
        
        if (data.success) {
          // Update the Discord config locally
          DISCORD_CONFIG.updateInviteCode(newCode);
          updateDisplay();
          addLog(`✅ ${data.message}`);
          
          // Refresh all Discord links on the page
          DISCORD_CONFIG.updateAllLinks();
        } else {
          addLog(`❌ Failed to update invite code: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Update error: ${error.message}`);
      }
    }

    // Add log entry
    function addLog(message) {
      const log = document.getElementById('statusLog');
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `<div class="text-blue-400">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    // Check for existing Discord authentication on page load
    async function checkDiscordAuth() {
      try {
        // Check if user is already authenticated via Discord
        const res = await fetch('https://narrrfs.world/api/user/profile.php', { 
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });

        if (res.ok) {
          const user = await res.json();
          
          // Check if user has admin/moderator roles
          if (user.roles && (
              user.roles.includes("Moderator") || 
              user.roles.includes("Admin") || 
              user.roles.includes("super_admin") ||
              user.roles.includes("Founder") ||
              user.roles.includes("Bot Master") ||
              user.discord_id === "328601656659017732" // narrrf's Discord ID
          )) {
            // Auto-login as Discord moderator
            currentAdmin = {
              username: user.discord_name || 'Discord Moderator',
              discord_id: user.discord_id,
              role: 'moderator',
              auth_type: 'discord'
            };
            
            // Hide auth panel and show admin interface
            document.getElementById('authPanel').style.display = 'none';
            document.getElementById('navPanel').style.display = 'block';
            
            // Load dashboard data
            loadDashboardData();
            
            addLog(`✅ Auto-authenticated as Discord moderator: ${user.discord_name}`);
            return true;
          }
        }
      } catch (error) {
        console.log('No existing Discord session found');
      }
      return false;
    }

    // Discord Authentication for Moderators
    async function authenticateDiscord() {
      const discordAuthStatus = document.getElementById('discordAuthStatus');
      discordAuthStatus.textContent = 'Redirecting to Discord OAuth...';
      
      // Redirect to Discord OAuth URL as specified by user
      const oauthUrl = "https://discord.com/oauth2/authorize?client_id=1357927342265204858&response_type=code&redirect_uri=https%3A%2F%2Fnarrrfs.world%2Fapi%2Fauth%2Fcallback.php&scope=identify+guilds+guilds.members.read";
      
      // Store the intended destination for after OAuth redirect
      localStorage.setItem('adminRedirect', 'true');
      
      // Redirect to Discord OAuth
      window.location.href = oauthUrl;
    }

    // === DATABASE FUNCTIONS ===
    
    // Show database unlock modal
    function showDatabaseUnlock() {
      const modal = document.getElementById('unlockModal');
      modal.classList.remove('hidden');
      document.getElementById('databasePassword').focus();
    }
    
    // Hide database unlock modal
    function hideDatabaseUnlock() {
      const modal = document.getElementById('unlockModal');
      modal.classList.add('hidden');
      document.getElementById('databasePassword').value = '';
      document.getElementById('unlockStatus').innerHTML = '';
    }
    
    // Unlock database access
    function unlockDatabase() {
      const password = document.getElementById('databasePassword').value;
      const statusDiv = document.getElementById('unlockStatus');
      
      // Simple internal password (you can change this)
      const internalPassword = 'cheese2024';
      
      if (password === internalPassword) {
        // Show database options
        document.getElementById('databaseOptions').style.display = 'block';
        document.getElementById('databaseQuickActions').style.display = 'block';
        document.getElementById('databaseUnlockSection').style.display = 'none';
        
        statusDiv.innerHTML = '<div class="text-green-600">✅ Database access unlocked!</div>';
        addLog('🔓 Database access unlocked successfully');
        
        // Hide modal after 1 second
        setTimeout(() => {
          hideDatabaseUnlock();
        }, 1000);
      } else {
        statusDiv.innerHTML = '<div class="text-red-600">❌ Incorrect password</div>';
        addLog('❌ Database unlock failed: Incorrect password');
      }
    }
    
    // Show upload modal
    function showUploadModal() {
      const modal = document.getElementById('uploadModal');
      modal.classList.remove('hidden');
    }
    
    // Hide upload modal
    function hideUploadModal() {
      const modal = document.getElementById('uploadModal');
      modal.classList.add('hidden');
      document.getElementById('uploadForm').reset();
      document.getElementById('uploadStatus').innerHTML = '';
    }
    
    // Upload database
    async function uploadDatabase() {
      const fileInput = document.getElementById('dbFile');
      const statusDiv = document.getElementById('uploadStatus');
      
      if (!fileInput.files[0]) {
        statusDiv.innerHTML = '<div class="text-red-600">❌ Please select a database file</div>';
        return;
      }
      
      const formData = new FormData();
      formData.append('sqlite', fileInput.files[0]);
      
      statusDiv.innerHTML = '<div class="text-blue-600">⏳ Uploading database...</div>';
      
      try {
        const response = await fetch('/api/dev/upload-db.php?secret=MyUltraSecretKey123', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.text();
        
        if (result.includes('successfully')) {
          statusDiv.innerHTML = '<div class="text-green-600">✅ Database uploaded successfully!</div>';
          addLog('📤 Database uploaded successfully');
          setTimeout(() => {
            hideUploadModal();
          }, 2000);
        } else {
          statusDiv.innerHTML = '<div class="text-red-600">❌ Upload failed: ' + result + '</div>';
          addLog('❌ Database upload failed: ' + result);
        }
      } catch (error) {
        statusDiv.innerHTML = '<div class="text-red-600">❌ Upload error: ' + error.message + '</div>';
        addLog('❌ Database upload error: ' + error.message);
      }
    }
    
    // Show database viewer
    function showDatabaseViewer() {
      const modal = document.getElementById('viewerModal');
      modal.classList.remove('hidden');
      loadDatabaseViewer();
    }
    
    // Hide database viewer
    function hideDatabaseViewer() {
      const modal = document.getElementById('viewerModal');
      modal.classList.add('hidden');
    }
    
    // Load database viewer content
    async function loadDatabaseViewer() {
      const contentDiv = document.getElementById('viewerContent');
      contentDiv.innerHTML = '<div class="text-blue-400">⏳ Loading database viewer...</div>';
      
      try {
        // Load initial database viewer structure
        const response = await fetch('/api/dev/db-viewer.php');
        const html = await response.text();
        contentDiv.innerHTML = html;
        
        // Load initial table data
        await loadTableData();
      } catch (error) {
        contentDiv.innerHTML = '<div class="text-red-400">❌ Failed to load database viewer: ' + error.message + '</div>';
      }
    }

    // Load table data via AJAX
    async function loadTableData() {
      const tableSelect = document.getElementById('tableSelect');
      const tableContent = document.getElementById('tableContent');
      const tableStats = document.getElementById('tableStats');
      
      if (!tableSelect || !tableContent || !tableStats) {
        console.error('Database viewer elements not found');
        return;
      }
      
      const selectedTable = tableSelect.value;
      
      try {
        tableContent.innerHTML = '<div class="text-blue-400">⏳ Loading table data...</div>';
        
        const response = await fetch(`/api/dev/db-viewer-data.php?table=${encodeURIComponent(selectedTable)}`);
        const data = await response.json();
        
        if (data.success) {
          tableContent.innerHTML = data.html;
          tableStats.innerHTML = `
            <div class="text-green-400">📊 Table: ${data.tableName}</div>
            <div class="text-blue-400">📈 Rows: ${data.rowCount.toLocaleString()}</div>
            <div class="text-purple-400">📋 Columns: ${data.columnCount}</div>
            <div class="text-yellow-400">🗂️ Total Tables: ${data.totalTables}</div>
          `;
        } else {
          tableContent.innerHTML = '<div class="text-red-400">❌ Error: ' + data.error + '</div>';
        }
      } catch (error) {
        tableContent.innerHTML = '<div class="text-red-400">❌ Failed to load table data: ' + error.message + '</div>';
      }
    }

    // === QUICK ACTIONS ===
    
    // Refresh dashboard data
    async function refreshDashboard() {
      addLog('🔄 Refreshing dashboard data...');
      await loadDashboardData();
      addLog('✅ Dashboard data refreshed');
    }
    
    // Trigger database backup
    async function triggerBackup() {
      addLog('💾 Triggering database backup...');
      
      try {
        const response = await fetch('/api/admin/db-persistence.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          addLog('✅ Database backup completed successfully');
          // Refresh dashboard after backup
          setTimeout(() => {
            loadDashboardData();
          }, 2000);
        } else {
          addLog('❌ Database backup failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        addLog('❌ Database backup error: ' + error.message);
      }
    }

    // Quest Claims Management Functions
    let showUserHistory = false;

    async function loadQuestClaims() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const statusFilter = document.getElementById('claimStatusFilter').value;
      addLog(`🔄 Loading quest claims (${statusFilter})...`);

      try {
        const response = await fetch(`/api/admin/quest-claims.php?action=get_claims&status=${statusFilter}`);
        const data = await response.json();
        
        if (data.success) {
          displayQuestClaims(data.claims);
          addLog(`✅ Loaded ${data.total} quest claims`);
        } else {
          addLog(`❌ Failed to load quest claims: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Quest claims loading error: ${error.message}`);
      }
    }

    async function loadEnhancedQuestClaims() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const statusFilter = document.getElementById('claimStatusFilter').value;
      addLog(`🔄 Loading enhanced quest claims (${statusFilter})...`);

      try {
        const response = await fetch(`/api/admin/get-enhanced-quest-claims.php?status=${statusFilter}&limit=50`);
        const data = await response.json();
        
        if (data.success) {
          displayEnhancedQuestClaims(data.claims);
          addLog(`✅ Loaded ${data.claims.length} enhanced quest claims`);
        } else {
          addLog(`❌ Failed to load enhanced quest claims: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Enhanced quest claims loading error: ${error.message}`);
      }
    }

    function toggleUserHistoryView() {
      showUserHistory = !showUserHistory;
      const button = event.target;
      button.textContent = showUserHistory ? '👤 Hide User History' : '👤 Show User History';
      button.className = showUserHistory ? 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded ml-2' : 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded ml-2';
      
      // Reload claims with current view
      if (showUserHistory) {
        loadEnhancedQuestClaims();
      } else {
        loadQuestClaims();
      }
    }

    function displayQuestClaims(claims) {
      const container = document.getElementById('questClaimsList');
      
      if (!claims || claims.length === 0) {
        container.innerHTML = `<div class="text-gray-300">No quest claims found.</div>`;
        return;
      }

      container.innerHTML = claims.map(claim => `
        <div class="bg-gray-700 p-4 rounded-lg border-l-4 ${getStatusBorderColor(claim.status)}">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h4 class="font-semibold text-white">${claim.quest_title || `Quest #${claim.quest_id}`}</h4>
              <p class="text-gray-300 text-sm">Claim ID: ${claim.claim_id}</p>
            </div>
            <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusBadgeColor(claim.status)}">
              ${claim.status || 'pending'}
            </span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div>
              <p class="text-sm text-gray-300"><strong>User:</strong> ${claim.username || 'Unknown'} (${claim.user_id})</p>
              <p class="text-sm text-gray-300"><strong>Reward:</strong> ${claim.quest_reward || 0} $DSPOINC</p>
              <p class="text-sm text-gray-300"><strong>Claimed:</strong> ${formatDate(claim.claimed_at)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-300"><strong>Role ID:</strong> ${claim.quest_role_id || 'None'}</p>
              ${claim.reviewed_at ? `<p class="text-sm text-gray-300"><strong>Reviewed:</strong> ${formatDate(claim.reviewed_at)}</p>` : ''}
              ${claim.proof ? `<p class="text-sm text-gray-300"><strong>Proof:</strong> <a href="${claim.proof}" target="_blank" class="text-blue-400 hover:underline">View Proof</a></p>` : ''}
            </div>
          </div>
          
          ${claim.status === 'pending' ? `
            <div class="flex gap-2">
              <button onclick="approveQuestClaim(${claim.claim_id})" 
                      class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                ✅ Approve & Pay
              </button>
              <button onclick="rejectQuestClaim(${claim.claim_id})" 
                      class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                ❌ Reject
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function getStatusBorderColor(status) {
      switch (status) {
        case 'approved': return 'border-green-500';
        case 'rejected': return 'border-red-500';
        default: return 'border-yellow-500';
      }
    }

    function getStatusBadgeColor(status) {
      switch (status) {
        case 'approved': return 'bg-green-600 text-white';
        case 'rejected': return 'bg-red-600 text-white';
        default: return 'bg-yellow-600 text-white';
      }
    }

    function displayEnhancedQuestClaims(claims) {
      const container = document.getElementById('questClaimsList');
      
      if (!claims || claims.length === 0) {
        container.innerHTML = `<div class="text-gray-300">No quest claims found.</div>`;
        return;
      }

      container.innerHTML = claims.map(claim => `
        <div class="bg-gray-700 p-4 rounded-lg border-l-4 ${getStatusBorderColor(claim.status)}">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h4 class="font-semibold text-white">${claim.quest_title || `Quest #${claim.quest_id}`}</h4>
              <p class="text-gray-300 text-sm">Claim ID: ${claim.claim_id}</p>
            </div>
            <div class="text-right">
              <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusBadgeColor(claim.status)}">
                ${claim.status || 'pending'}
              </span>
              <div class="mt-1">
                <span class="px-2 py-1 rounded text-xs font-semibold ${getRiskBadgeColor(claim.risk_assessment.level)}">
                  ${claim.risk_assessment.level} RISK
                </span>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div>
              <p class="text-sm text-gray-300"><strong>User:</strong> ${claim.username || 'Unknown'} (${claim.user_id})</p>
              <p class="text-sm text-gray-300"><strong>Reward:</strong> ${claim.quest_reward || 0} $DSPOINC</p>
              <p class="text-sm text-gray-300"><strong>Claimed:</strong> ${formatDate(claim.claimed_at)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-300"><strong>Role ID:</strong> ${claim.quest_role_id || 'None'}</p>
              ${claim.reviewed_at ? `<p class="text-sm text-gray-300"><strong>Reviewed:</strong> ${formatDate(claim.reviewed_at)}</p>` : ''}
              ${claim.proof ? `<p class="text-sm text-gray-300"><strong>Proof:</strong> <a href="${claim.proof}" target="_blank" class="text-blue-400 hover:underline">View Proof</a></p>` : ''}
            </div>
          </div>

          <!-- User Statistics -->
          <div class="bg-gray-800 p-3 rounded mb-3">
            <h5 class="font-semibold text-blue-400 mb-2">👤 User Activity History</h5>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
              <div>
                <span class="text-gray-400">🧀 Cheese Clicks:</span>
                <span class="text-white font-semibold">${claim.user_stats.cheese_clicks.total}</span>
              </div>
              <div>
                <span class="text-gray-400">📊 Quest Claims:</span>
                <span class="text-white font-semibold">${claim.user_stats.quests.total_claims}</span>
              </div>
              <div>
                <span class="text-gray-400">✅ Approved:</span>
                <span class="text-green-400 font-semibold">${claim.user_stats.quests.approved}</span>
              </div>
              <div>
                <span class="text-gray-400">❌ Rejected:</span>
                <span class="text-red-400 font-semibold">${claim.user_stats.quests.rejected}</span>
              </div>
              <div>
                <span class="text-gray-400">💰 Balance:</span>
                <span class="text-yellow-400 font-semibold">${claim.user_stats.balance.toLocaleString()}</span>
              </div>
              <div>
                <span class="text-gray-400">📈 Success Rate:</span>
                <span class="text-blue-400 font-semibold">${claim.user_stats.quests.completion_rate}%</span>
              </div>
              <div>
                <span class="text-gray-400">🕒 Last Cheese:</span>
                <span class="text-white font-semibold">${claim.user_stats.cheese_clicks.last_click ? formatDate(claim.user_stats.cheese_clicks.last_click) : 'Never'}</span>
              </div>
              <div>
                <span class="text-gray-400">🎯 Recent Activity:</span>
                <span class="text-white font-semibold">${claim.user_stats.cheese_clicks.clicks_24h} (24h)</span>
              </div>
            </div>
            
            <!-- Risk Factors -->
            ${claim.risk_assessment.factors.length > 0 ? `
              <div class="mt-2">
                <span class="text-red-400 text-xs">⚠️ Risk Factors:</span>
                <div class="text-xs text-gray-300 mt-1">
                  ${claim.risk_assessment.factors.map(factor => `• ${factor}`).join('<br>')}
                </div>
              </div>
            ` : ''}
          </div>
          
          ${claim.status === 'pending' ? `
            <div class="flex gap-2">
              <button onclick="approveQuestClaim(${claim.claim_id})" 
                      class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                ✅ Approve & Pay
              </button>
              <button onclick="rejectQuestClaim(${claim.claim_id})" 
                      class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                ❌ Reject
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function getRiskBadgeColor(riskLevel) {
      switch (riskLevel) {
        case 'HIGH': return 'bg-red-600 text-white';
        case 'MEDIUM': return 'bg-yellow-600 text-white';
        case 'LOW': return 'bg-green-600 text-white';
        default: return 'bg-gray-600 text-white';
      }
    }

    async function loadUserQuestHistory() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const userId = document.getElementById('questHistoryUserId').value.trim();
      if (!userId) {
        addLog('❌ Please enter a user ID or username');
        return;
      }

      addLog(`🔄 Loading quest history for user: ${userId}...`);

      try {
        const response = await fetch(`/api/admin/get-user-quest-history.php?user_id=${encodeURIComponent(userId)}`);
        const data = await response.json();
        
        if (data.success) {
          displayUserQuestHistory(data);
          addLog(`✅ Loaded quest history for ${data.user.username || userId}`);
        } else {
          addLog(`❌ Failed to load quest history: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Quest history loading error: ${error.message}`);
      }
    }

    function displayUserQuestHistory(data) {
      const container = document.getElementById('userQuestHistory');
      
      container.innerHTML = `
        <div class="bg-gray-700 p-4 rounded-lg">
          <!-- User Info -->
          <div class="mb-4">
            <h4 class="text-lg font-semibold text-white mb-2">👤 ${data.user.username || 'Unknown User'} (${data.user.discord_id})</h4>
            <p class="text-sm text-gray-300">User ID: ${data.user.discord_id}</p>
            <p class="text-sm text-gray-300">Current Balance: <span class="text-yellow-400 font-semibold">${data.balance.toLocaleString()} $DSPOINC</span></p>
          </div>

          <!-- Statistics Overview -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Cheese Click Stats -->
            <div class="bg-gray-800 p-3 rounded">
              <h5 class="font-semibold text-blue-400 mb-2">🧀 Cheese Click Activity</h5>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">Total Clicks:</span>
                  <span class="text-white font-semibold">${data.cheese_stats.total_clicks}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Last 24h:</span>
                  <span class="text-green-400 font-semibold">${data.cheese_stats.clicks_24h}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Last 7 days:</span>
                  <span class="text-blue-400 font-semibold">${data.cheese_stats.clicks_7d}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Last 30 days:</span>
                  <span class="text-purple-400 font-semibold">${data.cheese_stats.clicks_30d}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">First Click:</span>
                  <span class="text-white font-semibold">${data.cheese_stats.first_click ? formatDate(data.cheese_stats.first_click) : 'Never'}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Last Click:</span>
                  <span class="text-white font-semibold">${data.cheese_stats.last_click ? formatDate(data.cheese_stats.last_click) : 'Never'}</span>
                </div>
              </div>
            </div>

            <!-- Egg Type Breakdown -->
            <div class="bg-gray-800 p-3 rounded">
              <h5 class="font-semibold text-yellow-400 mb-2">🥚 Egg Type Breakdown</h5>
              <div class="space-y-1 text-sm">
                ${data.cheese_stats.clicks_by_egg && data.cheese_stats.clicks_by_egg.length > 0 ? 
                  data.cheese_stats.clicks_by_egg.map(egg => `
                    <div class="flex justify-between">
                      <span class="text-gray-400">${getEggDisplayName(egg.egg_id)}:</span>
                      <span class="text-white font-semibold">${egg.click_count}</span>
                    </div>
                  `).join('') : 
                  '<div class="text-gray-500 italic">No egg clicks recorded</div>'
                }
              </div>
            </div>

            <!-- Quest Stats -->
            <div class="bg-gray-800 p-3 rounded">
              <h5 class="font-semibold text-green-400 mb-2">🏆 Quest Activity</h5>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">Total Claims:</span>
                  <span class="text-white font-semibold">${data.quest_stats.total_claims}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Approved:</span>
                  <span class="text-green-400 font-semibold">${data.quest_stats.approved_claims}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Rejected:</span>
                  <span class="text-red-400 font-semibold">${data.quest_stats.rejected_claims}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Pending:</span>
                  <span class="text-yellow-400 font-semibold">${data.quest_stats.pending_claims}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Success Rate:</span>
                  <span class="text-blue-400 font-semibold">${data.quest_stats.completion_rate}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Total Rewards:</span>
                  <span class="text-yellow-400 font-semibold">${data.quest_stats.total_rewards_earned.toLocaleString()}</span>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-gray-800 p-3 rounded">
              <h5 class="font-semibold text-purple-400 mb-2">📊 Recent Activity (30d)</h5>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">Quest Claims:</span>
                  <span class="text-white font-semibold">${data.quest_stats.recent_activity.claims_30d}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Approved:</span>
                  <span class="text-green-400 font-semibold">${data.quest_stats.recent_activity.approved_30d}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Rejected:</span>
                  <span class="text-red-400 font-semibold">${data.quest_stats.recent_activity.rejected_30d}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Pending:</span>
                  <span class="text-yellow-400 font-semibold">${data.quest_stats.recent_activity.pending_30d}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Quest Claims History -->
          <div class="mb-4">
            <h5 class="font-semibold text-white mb-2">📋 Quest Claims History</h5>
            <div class="space-y-2 max-h-64 overflow-y-auto">
              ${data.quest_claims.length > 0 ? data.quest_claims.map(claim => `
                <div class="bg-gray-800 p-3 rounded border-l-4 ${getStatusBorderColor(claim.status)}">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="text-sm font-semibold text-white">${claim.quest_title || `Quest #${claim.quest_id}`}</p>
                      <p class="text-xs text-gray-400">${formatDate(claim.claimed_at)} - ${claim.quest_type || 'Unknown Type'}</p>
                    </div>
                    <div class="text-right">
                      <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusBadgeColor(claim.status)}">
                        ${claim.status}
                      </span>
                      <p class="text-xs text-gray-400 mt-1">${claim.quest_reward || 0} $DSPOINC</p>
                    </div>
                  </div>
                </div>
              `).join('') : '<p class="text-gray-400 text-sm">No quest claims found.</p>'}
            </div>
          </div>

          <!-- Cheese Click Breakdown -->
          ${data.cheese_stats.clicks_by_egg.length > 0 ? `
            <div class="mb-4">
              <h5 class="font-semibold text-white mb-2">🧀 Cheese Click Breakdown</h5>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                ${data.cheese_stats.clicks_by_egg.map(egg => `
                  <div class="bg-gray-800 p-2 rounded text-center">
                    <p class="text-xs text-gray-400">${getEggDisplayName(egg.egg_id)}</p>
                    <p class="text-sm font-semibold text-white">${egg.click_count}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Recent Cheese Clicks -->
          ${data.cheese_stats.recent_clicks.length > 0 ? `
            <div class="mb-4">
              <h5 class="font-semibold text-white mb-2">🕒 Recent Cheese Clicks</h5>
              <div class="space-y-1 max-h-32 overflow-y-auto">
                ${data.cheese_stats.recent_clicks.slice(0, 10).map(click => `
                  <div class="bg-gray-800 p-2 rounded text-sm">
                    <span class="text-gray-400">${getEggDisplayName(click.egg_id)}</span>
                    <span class="text-gray-500 mx-2">•</span>
                    <span class="text-gray-300">${formatDate(click.timestamp)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleString();
    }

    function getEggDisplayName(eggId) {
      const eggNames = {
        'cheese-egg-blue': '🔵 Blue Egg',
        'cheese-egg-red': '🔴 Red Egg', 
        'cheese-egg-green': '🟢 Green Egg',
        'cheese-egg': '🧀 Cheese Egg',
        'cheese-egg-finance': '💰 Finance Egg'
      };
      return eggNames[eggId] || eggId;
    }

    async function approveQuestClaim(claimId) {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      if (!confirm('Are you sure you want to approve this quest claim? This will award points and grant the Discord role if specified.')) {
        return;
      }

      addLog(`🔄 Approving quest claim ${claimId}...`);

      try {
        const response = await fetch('/api/admin/quest-claims.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'approve_claim',
            claim_id: claimId,
            admin_id: currentAdmin.discord_id
          })
        });

        const data = await response.json();
        
        if (data.success) {
          const roleMessage = data.role_granted ? 
            `✅ Role granted: ${data.role_id}` : 
            data.role_error ? 
            `⚠️ Role grant failed: ${data.role_error}` : 
            'ℹ️ No role to grant';
          
          addLog(`✅ Quest claim approved! Points added: ${data.points_added}, ${roleMessage}`);
          // Refresh the claims list
          loadQuestClaims();
        } else {
          addLog(`❌ Failed to approve claim: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Approve claim error: ${error.message}`);
      }
    }

    async function rejectQuestClaim(claimId) {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const reason = prompt('Enter rejection reason (optional):') || 'Rejected by admin';

      if (!confirm(`Are you sure you want to reject this quest claim?\nReason: ${reason}`)) {
        return;
      }

      addLog(`🔄 Rejecting quest claim ${claimId}...`);

      try {
        const response = await fetch('/api/admin/quest-claims.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'reject_claim',
            claim_id: claimId,
            admin_id: currentAdmin.discord_id,
            reason: reason
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ Quest claim rejected successfully`);
          // Refresh the claims list
          loadQuestClaims();
        } else {
          addLog(`❌ Failed to reject claim: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Reject claim error: ${error.message}`);
      }
    }

    function filterQuestClaims() {
      loadQuestClaims();
    }

    // Game Management Functions
    async function loadGameStatistics() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      addLog('🔄 Loading game statistics...');

      try {
        const response = await fetch('/api/admin/get-game-statistics.php');
        const data = await response.json();
        
        if (data.success) {
          displayGameStatistics(data);
          addLog('✅ Game statistics loaded successfully');
        } else {
          addLog(`❌ Failed to load game statistics: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Game statistics loading error: ${error.message}`);
      }
    }

    function displayGameStatistics(data) {
      // Update Tetris statistics
      document.getElementById('tetrisTotalScores').textContent = data.tetris.total_scores.toLocaleString();
      document.getElementById('tetrisUniquePlayers').textContent = data.tetris.unique_players.toLocaleString();
      document.getElementById('tetrisMaxScore').textContent = data.tetris.max_score ? data.tetris.max_score.toLocaleString() : '0';
      document.getElementById('tetrisRecent24h').textContent = data.tetris.recent_24h.toLocaleString();

      // Update Snake statistics
      document.getElementById('snakeTotalScores').textContent = data.snake.total_scores.toLocaleString();
      document.getElementById('snakeUniquePlayers').textContent = data.snake.unique_players.toLocaleString();
      document.getElementById('snakeMaxScore').textContent = data.snake.max_score ? data.snake.max_score.toLocaleString() : '0';
      document.getElementById('snakeRecent24h').textContent = data.snake.recent_24h.toLocaleString();

      // Update combined statistics
      document.getElementById('totalGameScores').textContent = data.total.total_scores.toLocaleString();
      document.getElementById('totalGamePlayers').textContent = data.total.total_players.toLocaleString();
      document.getElementById('totalGameRecent24h').textContent = data.total.recent_24h.toLocaleString();
      document.getElementById('totalGameRecent7d').textContent = data.total.recent_7d.toLocaleString();

      // Display top players
      displayTopPlayers('tetris', data.tetris_top_players);
      displayTopPlayers('snake', data.snake_top_players);

      // Display recent activity
      displayRecentActivity(data.recent_activity);
    }

    // Season Statistics Functions
    async function loadSeasonStats() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const season = document.getElementById('seasonSelector').value;
      const gameType = document.getElementById('gameFilter').value;

      addLog(`🔄 Loading season statistics for ${season}...`);

      try {
        const response = await fetch(`/api/admin/get-season-stats.php?season=${season}&game_type=${gameType}`);
        const data = await response.json();
        
        if (data.success) {
          displaySeasonStats(data.data);
          updateSeasonSelector(data.data.available_seasons);
          addLog('✅ Season statistics loaded successfully');
        } else {
          addLog(`❌ Failed to load season statistics: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Season statistics loading error: ${error.message}`);
      }
    }

    function displaySeasonStats(data) {
      const container = document.getElementById('seasonStats');
      
      let html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="bg-gray-700 p-3 rounded">
            <h5 class="font-semibold text-blue-400 mb-2">🟦 Tetris Statistics</h5>
            ${data.season_stats.tetris ? `
              <p class="text-sm text-gray-300">Total Scores: ${data.season_stats.tetris.total_scores.toLocaleString()}</p>
              <p class="text-sm text-gray-300">Unique Players: ${data.season_stats.tetris.unique_players.toLocaleString()}</p>
              <p class="text-sm text-gray-300">Max Score: ${data.season_stats.tetris.max_score ? data.season_stats.tetris.max_score.toLocaleString() : '0'}</p>
              <p class="text-sm text-gray-300">Avg Score: ${Math.round(data.season_stats.tetris.avg_score || 0).toLocaleString()}</p>
              <p class="text-sm text-yellow-400">Top Performers: ${data.season_stats.tetris.top_performers}</p>
            ` : '<p class="text-sm text-gray-400">No data available</p>'}
          </div>
          <div class="bg-gray-700 p-3 rounded">
            <h5 class="font-semibold text-green-400 mb-2">🐍 Snake Statistics</h5>
            ${data.season_stats.snake ? `
              <p class="text-sm text-gray-300">Total Scores: ${data.season_stats.snake.total_scores.toLocaleString()}</p>
              <p class="text-sm text-gray-300">Unique Players: ${data.season_stats.snake.unique_players.toLocaleString()}</p>
              <p class="text-sm text-gray-300">Max Score: ${data.season_stats.snake.max_score ? data.season_stats.snake.max_score.toLocaleString() : '0'}</p>
              <p class="text-sm text-gray-300">Avg Score: ${Math.round(data.season_stats.snake.avg_score || 0).toLocaleString()}</p>
              <p class="text-sm text-yellow-400">Top Performers: ${data.season_stats.snake.top_performers}</p>
            ` : '<p class="text-sm text-gray-400">No data available</p>'}
          </div>
        </div>
      `;

      // Add top performers section
      if (data.top_performers) {
        html += `
          <div class="bg-gray-700 p-3 rounded mb-4">
            <h5 class="font-semibold text-yellow-400 mb-2">🏆 Current Season Top Performers</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        `;

        if (data.top_performers.tetris && data.top_performers.tetris.length > 0) {
          html += `
            <div>
              <h6 class="text-blue-400 font-semibold mb-2">🟦 Tetris</h6>
              ${data.top_performers.tetris.map((player, index) => `
                <div class="flex justify-between items-center mb-1 ${player.is_top_performer ? 'bg-yellow-600 bg-opacity-30 p-1 rounded' : ''}">
                  <span class="text-sm text-white">${index + 1}. ${player.discord_name || 'Unknown'}</span>
                  <span class="text-sm text-green-400">${player.score.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          `;
        }

        if (data.top_performers.snake && data.top_performers.snake.length > 0) {
          html += `
            <div>
              <h6 class="text-green-400 font-semibold mb-2">🐍 Snake</h6>
              ${data.top_performers.snake.map((player, index) => `
                <div class="flex justify-between items-center mb-1 ${player.is_top_performer ? 'bg-yellow-600 bg-opacity-30 p-1 rounded' : ''}">
                  <span class="text-sm text-white">${index + 1}. ${player.discord_name || 'Unknown'}</span>
                  <span class="text-sm text-green-400">${player.score.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          `;
        }

        html += `
            </div>
          </div>
        `;
      }

      // Add all-time legends section
      if (data.all_time_legends) {
        html += `
          <div class="bg-gray-700 p-3 rounded">
            <h5 class="font-semibold text-purple-400 mb-2">👑 All-Time Legends (Top Performers)</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        `;

        if (data.all_time_legends.tetris && data.all_time_legends.tetris.length > 0) {
          html += `
            <div>
              <h6 class="text-blue-400 font-semibold mb-2">🟦 Tetris Legends</h6>
              ${data.all_time_legends.tetris.map((legend, index) => `
                <div class="flex justify-between items-center mb-1 bg-purple-600 bg-opacity-30 p-1 rounded">
                  <div>
                    <span class="text-sm text-white">${index + 1}. ${legend.discord_name || 'Unknown'}</span>
                    <span class="text-xs text-gray-400 block">${legend.season}</span>
                  </div>
                  <span class="text-sm text-green-400">${legend.score.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          `;
        }

        if (data.all_time_legends.snake && data.all_time_legends.snake.length > 0) {
          html += `
            <div>
              <h6 class="text-green-400 font-semibold mb-2">🐍 Snake Legends</h6>
              ${data.all_time_legends.snake.map((legend, index) => `
                <div class="flex justify-between items-center mb-1 bg-purple-600 bg-opacity-30 p-1 rounded">
                  <div>
                    <span class="text-sm text-white">${index + 1}. ${legend.discord_name || 'Unknown'}</span>
                    <span class="text-xs text-gray-400 block">${legend.season}</span>
                  </div>
                  <span class="text-sm text-green-400">${legend.score.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          `;
        }

        html += `
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function updateSeasonSelector(availableSeasons) {
      const selector = document.getElementById('seasonSelector');
      const currentOptions = selector.innerHTML;
      
      // Keep the "Current Season" option and add available seasons
      selector.innerHTML = '<option value="current">Current Season</option>';
      
      availableSeasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = season;
        selector.appendChild(option);
      });
    }

    function displayTopPlayers(gameType, players) {
      const container = document.getElementById(`${gameType}TopPlayers`);
      
      if (!players || players.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-sm">No players found</div>';
        return;
      }

      container.innerHTML = players.map((player, index) => `
        <div class="bg-gray-700 p-2 rounded flex justify-between items-center">
          <div class="flex items-center">
            <span class="text-sm font-semibold text-gray-300 mr-2">#${index + 1}</span>
            <div>
              <p class="text-sm font-semibold text-white">${player.discord_name || 'Unknown'}</p>
              <p class="text-xs text-gray-400">${player.discord_id}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm font-semibold text-green-400">${player.best_score.toLocaleString()}</p>
            <p class="text-xs text-gray-400">${player.total_games} games</p>
          </div>
        </div>
      `).join('');
    }

    function displayRecentActivity(activity) {
      const container = document.getElementById('recentGameActivity');
      
      if (!activity || activity.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-sm">No recent activity</div>';
        return;
      }

      container.innerHTML = activity.map(item => `
        <div class="bg-gray-700 p-2 rounded flex justify-between items-center">
          <div class="flex items-center">
            <span class="text-sm mr-2">${item.game === 'tetris' ? '🟦' : '🐍'}</span>
            <div>
              <p class="text-sm font-semibold text-white">${item.discord_name || 'Unknown'}</p>
              <p class="text-xs text-gray-400">${formatDate(item.timestamp)}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm font-semibold text-green-400">${item.score.toLocaleString()}</p>
          </div>
        </div>
      `).join('');
    }

    function toggleResetOptions() {
      const resetType = document.getElementById('resetType').value;
      const seasonOption = document.getElementById('seasonOption');
      const topScoresOption = document.getElementById('topScoresOption');
      const userOption = document.getElementById('userOption');

      // Hide all options first
      seasonOption.classList.add('hidden');
      topScoresOption.classList.add('hidden');
      userOption.classList.add('hidden');

      // Show relevant option
      if (resetType === 'season') {
        seasonOption.classList.remove('hidden');
      } else if (resetType === 'top_scores') {
        topScoresOption.classList.remove('hidden');
      } else if (resetType === 'user') {
        userOption.classList.remove('hidden');
      }
    }

    async function resetGameScores() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const gameType = document.getElementById('resetGameType').value;
      const resetType = document.getElementById('resetType').value;
      const topCount = document.getElementById('topCount').value;
      const userId = document.getElementById('resetUserId').value.trim();
      const seasonName = document.getElementById('seasonName').value.trim();

      // Validate inputs
      if (resetType === 'user' && !userId) {
        addLog('❌ Please enter a Discord User ID for user-specific reset');
        return;
      }

      if (resetType === 'top_scores' && (!topCount || topCount < 1 || topCount > 100)) {
        addLog('❌ Please enter a valid number of top scores (1-100)');
        return;
      }

      // Create confirmation message
      let confirmationMessage = `Are you sure you want to reset ${gameType === 'all' ? 'all games' : gameType} scores?\n\n`;
      confirmationMessage += `Reset Type: ${resetType}\n`;
      
      if (resetType === 'season') {
        confirmationMessage += `New Season: ${seasonName || 'auto-generated'}\n`;
        confirmationMessage += `📊 Current season data will be preserved as historical data\n`;
        confirmationMessage += `🏆 Top 2 performers will be marked as legends\n`;
      } else if (resetType === 'top_scores') {
        confirmationMessage += `Top Scores: ${topCount}\n`;
      } else if (resetType === 'user') {
        confirmationMessage += `User ID: ${userId}\n`;
      }
      
      confirmationMessage += '\n⚠️ This action cannot be undone!';

      if (!confirm(confirmationMessage)) {
        return;
      }

      addLog(`🔄 Resetting game scores...`);

      try {
        const response = await fetch('/api/admin/reset-game-scores-v2.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            admin_username: currentAdmin.username,
            game_type: gameType,
            reset_type: resetType,
            top_count: parseInt(topCount),
            user_id: userId,
            season_name: seasonName || null
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ Game scores reset successfully!`);
          addLog(`📊 Records affected: ${data.details.records_affected}`);
          addLog(`🎮 Game type: ${data.details.game_type}`);
          addLog(`🔄 Reset type: ${data.details.reset_type}`);
          addLog(`📅 Current season: ${data.details.current_season}`);
          addLog(`🆕 New season: ${data.details.new_season}`);
          
          // Show top performers if any
          if (data.details.top_performers) {
            addLog(`🏆 Top performers marked as legends:`);
            Object.keys(data.details.top_performers).forEach(game => {
              data.details.top_performers[game].forEach(performer => {
                addLog(`  ${game}: ${performer.discord_name} (${performer.score})`);
              });
            });
          }
          
          // Refresh statistics
          loadGameStatistics();
          loadSeasonStats();
        } else {
          addLog(`❌ Failed to reset game scores: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Reset game scores error: ${error.message}`);
      }
    }

    // Game Settings Management
    async function loadGameSettings() {
      try {
        const response = await fetch('/api/admin/game-settings.php?action=get_settings');
        const data = await response.json();
        
        if (data.success) {
          const settings = data.settings;
          
                       // Populate Tetris settings
             document.getElementById('tetrisWlEnabled').checked = settings.tetris_wl_enabled == 1;
             document.getElementById('tetrisWlThreshold').value = settings.tetris_wl_threshold || 4000;
             document.getElementById('tetrisWlRoleId').value = settings.tetris_wl_role_id || '';
             document.getElementById('tetrisWlBonus').value = settings.tetris_wl_bonus || 1000;
             
             // Populate Snake settings
             document.getElementById('snakeWlEnabled').checked = settings.snake_wl_enabled == 1;
             document.getElementById('snakeWlThreshold').value = settings.snake_wl_threshold || 4000;
             document.getElementById('snakeWlRoleId').value = settings.snake_wl_role_id || '';
             document.getElementById('snakeWlBonus').value = settings.snake_wl_bonus || 1000;
          
          addLog('✅ Game settings loaded successfully');
        } else {
          addLog('❌ Failed to load game settings');
        }
      } catch (error) {
        addLog(`❌ Load game settings error: ${error.message}`);
      }
    }

    async function saveGameSettings() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

               const tetrisWlEnabled = document.getElementById('tetrisWlEnabled').checked ? 1 : 0;
         const tetrisWlThreshold = parseInt(document.getElementById('tetrisWlThreshold').value);
         const tetrisWlRoleId = document.getElementById('tetrisWlRoleId').value;
         const tetrisWlBonus = parseInt(document.getElementById('tetrisWlBonus').value);
         const snakeWlEnabled = document.getElementById('snakeWlEnabled').checked ? 1 : 0;
         const snakeWlThreshold = parseInt(document.getElementById('snakeWlThreshold').value);
         const snakeWlRoleId = document.getElementById('snakeWlRoleId').value;
         const snakeWlBonus = parseInt(document.getElementById('snakeWlBonus').value);

      // Validate inputs
               if ((tetrisWlEnabled && !tetrisWlRoleId) || (snakeWlEnabled && !snakeWlRoleId)) {
           addLog('❌ Please select a WL role when enabling WL grants');
           return;
         }
       
         if (tetrisWlThreshold < 1000 || tetrisWlThreshold > 10000 || 
             snakeWlThreshold < 1000 || snakeWlThreshold > 10000) {
           addLog('❌ Score threshold must be between 1000 and 10000');
           return;
         }
       
         if (tetrisWlBonus < 100 || tetrisWlBonus > 10000 || 
             snakeWlBonus < 100 || snakeWlBonus > 10000) {
           addLog('❌ Bonus points must be between 100 and 10000');
           return;
         }

      addLog('💾 Saving game settings...');

      try {
        const response = await fetch('/api/admin/game-settings.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
                       body: JSON.stringify({
               action: 'update_settings',
               tetris_wl_enabled: tetrisWlEnabled,
               tetris_wl_threshold: tetrisWlThreshold,
               tetris_wl_role_id: tetrisWlRoleId,
               tetris_wl_bonus: tetrisWlBonus,
               snake_wl_enabled: snakeWlEnabled,
               snake_wl_threshold: snakeWlThreshold,
               snake_wl_role_id: snakeWlRoleId,
               snake_wl_bonus: snakeWlBonus
             })
        });

        const data = await response.json();
        
        if (data.success) {
                       addLog('✅ Game settings saved successfully!');
             addLog(`🟦 Tetris WL: ${tetrisWlEnabled ? 'Enabled' : 'Disabled'} (${tetrisWlThreshold} DSPOINC, +${tetrisWlBonus} bonus)`);
             addLog(`🐍 Snake WL: ${snakeWlEnabled ? 'Enabled' : 'Disabled'} (${snakeWlThreshold} DSPOINC, +${snakeWlBonus} bonus)`);
        } else {
          addLog(`❌ Failed to save game settings: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Save game settings error: ${error.message}`);
      }
    }

    // Enhanced quest creation with role granting
    async function createQuest() {
      if (!currentAdmin) {
        addLog('❌ Please authenticate first');
        return;
      }

      const questType = document.getElementById('newQuestType').value;
      const questReward = parseInt(document.getElementById('newQuestReward').value);
      const questUrl = document.getElementById('newQuestUrl').value;
      const questDescription = document.getElementById('newQuestDescription').value;
      const grantRole = document.getElementById('grantRoleCheckbox').checked;
      const roleId = document.getElementById('questRoleId').value;

      if (!questType || !questDescription || questReward <= 0) {
        addLog('❌ Please fill in all required fields (type, description, reward)');
        return;
      }

      if (grantRole && !roleId) {
        addLog('❌ Please enter a Discord role ID when granting roles');
        return;
      }

      addLog('🔄 Creating new quest...');

      try {
        const questData = {
          action: 'create',
          type: questType,
          description: questDescription,
          link: questUrl,
          reward: questReward,
          created_by: currentAdmin.discord_id,
          grant_role: grantRole,
          role_id: roleId
        };

        // Add cheese quest specific fields if it's a cheese hunt
        if (questType === 'cheese_hunt') {
          questData.movement_pattern = document.getElementById('cheeseMovementPattern').value;
          questData.movement_speed = document.getElementById('cheeseMovementSpeed').value;
          questData.hidden_areas = document.getElementById('cheeseHiddenAreas').value === 'true';
          questData.cheese_count = parseInt(document.getElementById('cheeseCount').value);
          questData.discord_ticket = document.getElementById('cheeseDiscordTicket').value === 'true';
          questData.screenshot_required = document.getElementById('cheeseScreenshotRequired').value === 'true';
          questData.winner_message = document.getElementById('cheeseWinnerMessage').value;
        }

        const response = await fetch('/api/admin/create-quest.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(questData)
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`✅ Quest created successfully! ID: ${data.quest_id}${grantRole ? `, Role ID: ${roleId}` : ''}`);
          
          // Clear form
          document.getElementById('newQuestType').value = '';
          document.getElementById('newQuestReward').value = '';
          document.getElementById('newQuestUrl').value = '';
          document.getElementById('newQuestDescription').value = '';
          document.getElementById('grantRoleCheckbox').checked = false;
          document.getElementById('questRoleId').value = '';
          
          // Refresh active quests
          loadActiveQuests();
        } else {
          addLog(`❌ Failed to create quest: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Create quest error: ${error.message}`);
      }
    }

    // Load active quests
    async function loadActiveQuests() {
      if (!currentAdmin) return;

      try {
        const response = await fetch('/api/user/quests.php?user_id=' + currentAdmin.discord_id);
        const data = await response.json();
        
        if (data.success) {
          displayActiveQuests(data.quests);
        }
      } catch (error) {
        console.error('Error loading active quests:', error);
      }
    }

    function displayActiveQuests(quests) {
      const container = document.getElementById('activeQuestsList');
      
      if (!quests || quests.length === 0) {
        container.innerHTML = `<div class="text-gray-300">No active quests found.</div>`;
        return;
      }

      container.innerHTML = quests.map(quest => `
        <div class="bg-gray-700 p-4 rounded-lg">
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-semibold text-white">${quest.title || `Quest #${quest.quest_id}`}</h4>
            <span class="px-2 py-1 bg-green-600 text-white text-xs rounded">Active</span>
          </div>
          <p class="text-gray-300 text-sm mb-2">${quest.description}</p>
          <div class="flex justify-between items-center">
            <span class="text-yellow-400 font-semibold">${quest.reward} $DSPOINC</span>
            ${quest.role_id ? `<span class="text-blue-400 text-sm">🎭 Role: ${quest.role_id}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    // Display recent quest claims
    function displayRecentQuestClaims(claims) {
      const container = document.getElementById('recentQuestClaims');
      
      if (claims.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No quest claims found</div>';
        return;
      }

      container.innerHTML = claims.map(claim => {
        const username = claim.username || 'Anonymous Mouse';
        const displayName = username.length > 12 ? username.substring(0, 12) + '...' : username;
        const statusColor = claim.status === 'approved' ? 'text-green-400' : 
                           claim.status === 'rejected' ? 'text-red-400' : 'text-yellow-400';
        const statusText = claim.status === 'approved' ? '✅ Approved' : 
                          claim.status === 'rejected' ? '❌ Rejected' : '⏳ Pending';
        const date = new Date(claim.claimed_at).toLocaleDateString();
        
        return `
          <div class="flex justify-between items-center py-1">
            <span class="text-green-300">
              <a href="/profile.html?user_id=${encodeURIComponent(claim.user_id)}" 
                 class="hover:text-green-200 underline cursor-pointer" 
                 title="View ${username}'s profile">
                ${displayName}
              </a>
            </span>
            <span class="${statusColor} text-xs">${statusText}</span>
            <span class="text-gray-400 text-xs">${date}</span>
          </div>
        `;
      }).join('');
    }

    // Display active quests by type
    function displayActiveQuestsByType(questsByType) {
      const container = document.getElementById('activeQuestsByType');
      
      if (questsByType.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No active quests found</div>';
        return;
      }

      container.innerHTML = questsByType.map(quest => {
        const questTypeEmoji = quest.type === 'cheese_hunt' ? '🧀' : 
                              quest.type === 'tweet' ? '🐦' : 
                              quest.type === 'tetris' ? '🟦' : 
                              quest.type === 'snake' ? '🐍' : 
                              quest.type === 'hytopia_game' ? '🎮' : 
                              quest.type === 'invite' ? '👥' : 
                              quest.type === 'Custom' ? '📝' : '🎯';
        const questTypeName = quest.type === 'cheese_hunt' ? 'Cheese Hunt' : 
                             quest.type === 'tweet' ? 'Twitter' : 
                             quest.type === 'tetris' ? 'Tetris' : 
                             quest.type === 'snake' ? 'Snake' : 
                             quest.type === 'hytopia_game' ? 'Hytopia Game' : 
                             quest.type === 'invite' ? 'Invite' : 
                             quest.type === 'Custom' ? 'Custom' : quest.type;
        
        return `
          <div class="flex justify-between items-center py-1">
            <span class="text-purple-300">${questTypeEmoji} ${questTypeName}</span>
            <span class="text-white font-semibold">${quest.count}</span>
          </div>
        `;
      }).join('');
    }

    // Load and display user adjustments
    async function loadUserAdjustments(userId, username) {
      try {
        const response = await fetch('/api/admin/get-user-adjustments.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'get_user_adjustments',
            user_id: userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayUserAdjustments(data.adjustments, username);
        } else {
          addLog(`❌ Failed to load adjustments for ${username}: ${data.error}`);
        }
      } catch (error) {
        addLog(`❌ Error loading adjustments for ${username}: ${error.message}`);
      }
    }

    // Display user adjustments in a modal
    function displayUserAdjustments(adjustments, username) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">📊 Adjustments for ${username}</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">&times;</button>
          </div>
          <div class="space-y-2">
            ${adjustments.length === 0 ? 
              '<div class="text-gray-400">No adjustments found for this user.</div>' :
              adjustments.map(adj => {
                const amount = parseInt(adj.amount);
                const isPositive = amount > 0;
                const timestamp = new Date(adj.timestamp).toLocaleString();
                
                return `
                  <div class="bg-gray-700 p-3 rounded ${isPositive ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}">
                    <div class="flex justify-between items-start">
                      <div>
                        <strong class="${isPositive ? 'text-green-400' : 'text-red-400'}">
                          ${isPositive ? '+' : ''}${amount.toLocaleString()} $DSPOINC
                        </strong>
                        <span class="text-sm text-gray-300 ml-2">(${adj.action})</span>
                      </div>
                      <div class="text-xs text-gray-400">${timestamp}</div>
                    </div>
                    <div class="text-sm text-gray-300 mt-1">Reason: ${adj.reason || 'No reason'}</div>
                    ${adj.admin_id ? `<div class="text-xs text-gray-400">Admin: ${adj.admin_id}</div>` : ''}
                  </div>
                `;
              }).join('')
            }
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // Display engagement statistics
    function displayEngagementStats(stats) {
      const container = document.getElementById('engagementStats');
      container.innerHTML = `
        <div class="space-y-1">
          <div class="flex justify-between">
            <span class="text-cyan-300">Power Users (>100 clicks):</span>
            <span class="text-white font-semibold">${stats.power_users}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-cyan-300">Active Users (7 days):</span>
            <span class="text-white font-semibold">${stats.active_users_7_days}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-cyan-300">Retention Rate:</span>
            <span class="text-white font-semibold">${stats.user_retention_rate}%</span>
          </div>
        </div>
      `;
    }

    // Display wealth distribution statistics
    function displayWealthStats(stats) {
      const container = document.getElementById('wealthStats');
      container.innerHTML = `
        <div class="space-y-1">
          <div class="flex justify-between">
            <span class="text-emerald-300">Highest Balance:</span>
            <span class="text-white font-semibold">${stats.max_balance.toLocaleString()}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-emerald-300">Lowest Balance:</span>
            <span class="text-white font-semibold">${stats.min_balance.toLocaleString()}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-emerald-300">Average Balance:</span>
            <span class="text-white font-semibold">${stats.avg_balance.toLocaleString()}</span>
          </div>
        </div>
      `;
    }

    // ========================================
    // HOLDER VERIFICATION FUNCTIONS
    // ========================================

    // Load holder verification statistics
    async function loadHolderVerificationStats() {
      try {
        const response = await fetch('/api/admin/get-holder-verification-stats.php');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('totalVerifications').textContent = data.stats.total_verifications || 0;
          document.getElementById('successfulVerifications').textContent = data.stats.successful_verifications || 0;
          document.getElementById('totalNFTs').textContent = data.stats.total_nfts || 0;
          document.getElementById('activeRoles').textContent = data.stats.active_roles || 0;
        } else {
          addVerificationLog(`❌ Failed to load verification stats: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Error loading verification stats: ${error.message}`);
      }
    }

    // Load verifications with filters
    async function loadVerifications() {
      try {
        const collectionFilter = document.getElementById('verificationCollectionFilter').value;
        const statusFilter = document.getElementById('verificationStatusFilter').value;
        
        const response = await fetch('/api/admin/get-holder-verifications.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            collection: collectionFilter,
            status: statusFilter
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayVerifications(data.verifications);
          addVerificationLog(`✅ Loaded ${data.verifications.length} verifications`);
        } else {
          addVerificationLog(`❌ Failed to load verifications: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Error loading verifications: ${error.message}`);
      }
    }

    // Display verifications in the list
    function displayVerifications(verifications) {
      const container = document.getElementById('verificationsList');
      
      if (verifications.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-center py-4">No verifications found</div>';
        return;
      }

      container.innerHTML = verifications.map(verification => {
        const statusIcon = verification.role_granted ? '✅' : '❌';
        const statusColor = verification.role_granted ? 'text-green-400' : 'text-red-400';
        const date = new Date(verification.verified_at).toLocaleString();
        
        return `
          <div class="bg-gray-700 p-3 rounded border-l-4 border-gray-600">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold text-white">${verification.username}</div>
                <div class="text-sm text-gray-300">${verification.wallet.substring(0, 8)}...${verification.wallet.substring(verification.wallet.length - 8)}</div>
                <div class="text-sm text-gray-400">Collection: ${verification.collection}</div>
              </div>
              <div class="text-right">
                <div class="${statusColor} font-semibold">${statusIcon} ${verification.role_granted ? 'Role Granted' : 'No Role'}</div>
                <div class="text-xs text-gray-400">${date}</div>
                <div class="text-xs text-gray-400">NFTs: ${verification.nft_count}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Search NFTs by wallet and collection
    async function searchNFTs() {
      try {
        const wallet = document.getElementById('nftWalletAddress').value.trim();
        const collection = document.getElementById('nftCollection').value;
        
        if (!wallet) {
          addVerificationLog('❌ Please enter a wallet address');
          return;
        }

        const response = await fetch('/api/admin/search-nft-ownership.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet: wallet,
            collection: collection
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayNFTSearchResults(data.nfts, wallet);
          addVerificationLog(`✅ Found ${data.nfts.length} NFTs for wallet ${wallet.substring(0, 8)}...`);
        } else {
          addVerificationLog(`❌ NFT search failed: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Error searching NFTs: ${error.message}`);
      }
    }

    // Display NFT search results
    function displayNFTSearchResults(nfts, wallet) {
      const container = document.getElementById('nftSearchResults');
      
      if (nfts.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-center py-4">No NFTs found for this wallet</div>';
        return;
      }

      container.innerHTML = nfts.map(nft => {
        const rarityColor = nft.rarity === 'Legendary' ? 'text-yellow-400' : 
                           nft.rarity === 'Epic' ? 'text-purple-400' : 
                           nft.rarity === 'Rare' ? 'text-blue-400' : 'text-gray-400';
        
        return `
          <div class="bg-gray-700 p-3 rounded border-l-4 border-gray-600">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold text-white">Token #${nft.token_id}</div>
                <div class="text-sm ${rarityColor}">${nft.rarity || 'Common'}</div>
                <div class="text-sm text-gray-400">Collection: ${nft.collection}</div>
              </div>
              <div class="text-right">
                <div class="text-xs text-gray-400">${new Date(nft.acquired_at).toLocaleDateString()}</div>
                ${nft.traits ? `<div class="text-xs text-gray-400">Has Traits</div>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Grant role to user
    async function grantRole() {
      try {
        const userId = document.getElementById('roleUserId').value.trim();
        const roleId = document.getElementById('roleToGrant').value;
        const reason = document.getElementById('roleGrantReason').value.trim();
        
        if (!userId) {
          addVerificationLog('❌ Please enter a Discord user ID');
          return;
        }

        const response = await fetch('/api/admin/grant-discord-role.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            role_id: roleId,
            reason: reason || 'Manual role grant via admin interface'
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addVerificationLog(`✅ Role granted to user ${userId}`);
          document.getElementById('roleUserId').value = '';
          document.getElementById('roleGrantReason').value = '';
        } else {
          addVerificationLog(`❌ Failed to grant role: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Error granting role: ${error.message}`);
      }
    }

    // Revoke role from user
    async function revokeRole() {
      try {
        const userId = document.getElementById('revokeUserId').value.trim();
        const roleId = document.getElementById('roleToRevoke').value;
        const reason = document.getElementById('roleRevokeReason').value.trim();
        
        if (!userId) {
          addVerificationLog('❌ Please enter a Discord user ID');
          return;
        }

        const response = await fetch('/api/admin/revoke-discord-role.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            role_id: roleId,
            reason: reason || 'Manual role revocation via admin interface'
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addVerificationLog(`✅ Role revoked from user ${userId}`);
          document.getElementById('revokeUserId').value = '';
          document.getElementById('roleRevokeReason').value = '';
        } else {
          addVerificationLog(`❌ Failed to revoke role: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Error revoking role: ${error.message}`);
      }
    }

    // Add log to verification log
    function addVerificationLog(message) {
      const log = document.getElementById('verificationLog');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'text-blue-400';
      logEntry.textContent = `[${timestamp}] ${message}`;
      log.appendChild(logEntry);
      log.scrollTop = log.scrollHeight;
    }

    // Load holder verification data when tab is opened
    function loadHolderVerificationData() {
      loadHolderVerificationStats();
      addVerificationLog('🔄 Holder verification system initialized');
    }

    // Search holder users with instant search
    function searchHolderUsersInstant(searchTerm) {
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        document.getElementById('holderUserSearchResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
        document.getElementById('holderUserSearchResults').classList.add('hidden');
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/admin/point-management.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'searchuser',
              search: searchTerm
            })
          });

          const data = await response.json();
          
          if (data.success) {
            displayHolderUserSearchResults(data.users);
            document.getElementById('holderUserSearchResults').classList.remove('hidden');
          } else {
            addVerificationLog(`❌ Search failed: ${data.error}`);
          }
        } catch (error) {
          addVerificationLog(`❌ Search error: ${error.message}`);
        }
      }, 300);
    }

    // Display holder user search results
    function displayHolderUserSearchResults(users) {
      const container = document.getElementById('holderUserSearchResults');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="user-card mb-2 p-2 bg-gray-600 rounded">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold text-white">${user.username || 'Unknown User'}</h4>
              <p class="text-sm text-gray-300">ID: ${user.user_id}</p>
              <p class="text-sm text-yellow-400">Balance: ${user.score?.toLocaleString() || 0} $DSPOINC</p>
            </div>
            <button onclick="selectHolderUser('${user.user_id}', '${user.username || 'Unknown'}')" 
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
              Select
            </button>
          </div>
        </div>
      `).join('');
    }

    // Select user from holder search results
    function selectHolderUser(userId, username) {
      document.getElementById('roleUserId').value = userId;
      document.getElementById('holderUserSearchResults').classList.add('hidden');
      document.getElementById('holderUserSearch').value = username;
      addVerificationLog(`✅ Selected user: ${username} (${userId})`);
    }

    // Search holder users (manual search)
    async function searchHolderUsers() {
      const searchTerm = document.getElementById('holderUserSearch').value.trim();
      if (!searchTerm) {
        addVerificationLog('❌ Please enter a search term');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'searchuser',
            search: searchTerm
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayHolderUserSearchResults(data.users);
          document.getElementById('holderUserSearchResults').classList.remove('hidden');
          addVerificationLog(`🔍 Found ${data.users.length} users matching "${searchTerm}"`);
        } else {
          addVerificationLog(`❌ Search failed: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Search error: ${error.message}`);
      }
    }

    // Search revoke users with instant search
    function searchRevokeUsersInstant(searchTerm) {
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        document.getElementById('revokeUserSearchResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
        document.getElementById('revokeUserSearchResults').classList.add('hidden');
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/admin/point-management.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'searchuser',
              search: searchTerm
            })
          });

          const data = await response.json();
          
          if (data.success) {
            displayRevokeUserSearchResults(data.users);
            document.getElementById('revokeUserSearchResults').classList.remove('hidden');
          } else {
            addVerificationLog(`❌ Search failed: ${data.error}`);
          }
        } catch (error) {
          addVerificationLog(`❌ Search error: ${error.message}`);
        }
      }, 300);
    }

    // Display revoke user search results
    function displayRevokeUserSearchResults(users) {
      const container = document.getElementById('revokeUserSearchResults');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="user-card mb-2 p-2 bg-gray-600 rounded">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold text-white">${user.username || 'Unknown User'}</h4>
              <p class="text-sm text-gray-300">ID: ${user.user_id}</p>
              <p class="text-sm text-yellow-400">Balance: ${user.score?.toLocaleString() || 0} $DSPOINC</p>
            </div>
            <button onclick="selectRevokeUser('${user.user_id}', '${user.username || 'Unknown'}')" 
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
              Select
            </button>
          </div>
        </div>
      `).join('');
    }

    // Select user from revoke search results
    function selectRevokeUser(userId, username) {
      document.getElementById('revokeUserId').value = userId;
      document.getElementById('revokeUserSearchResults').classList.add('hidden');
      document.getElementById('revokeUserSearch').value = username;
      addVerificationLog(`✅ Selected user: ${username} (${userId})`);
    }

    // Search revoke users (manual search)
    async function searchRevokeUsers() {
      const searchTerm = document.getElementById('revokeUserSearch').value.trim();
      if (!searchTerm) {
        addVerificationLog('❌ Please enter a search term');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'searchuser',
            search: searchTerm
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayRevokeUserSearchResults(data.users);
          document.getElementById('revokeUserSearchResults').classList.remove('hidden');
          addVerificationLog(`🔍 Found ${data.users.length} users matching "${searchTerm}"`);
        } else {
          addVerificationLog(`❌ Search failed: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Search error: ${error.message}`);
      }
    }

    // Load role history
    async function loadRoleHistory(action) {
      try {
        const response = await fetch(`/api/admin/get-role-grant-history.php?action=${action}&limit=50`);
        const data = await response.json();
        
        if (data.success) {
          displayRoleHistory(data.history);
          addVerificationLog(`✅ Loaded ${data.history.length} role history entries`);
        } else {
          addVerificationLog(`❌ Failed to load role history: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Error loading role history: ${error.message}`);
      }
    }

    // Display role history
    function displayRoleHistory(history) {
      const container = document.getElementById('roleHistoryList');
      
      if (history.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-center py-4">No role history found.</div>';
        return;
      }

      container.innerHTML = history.map(entry => {
        const isRevoked = entry.revoked_at !== null;
        const statusColor = isRevoked ? 'border-red-500' : 'border-green-500';
        const statusIcon = isRevoked ? '❌' : '✅';
        const statusText = isRevoked ? 'Revoked' : 'Granted';
        const date = new Date(entry.granted_at).toLocaleString();
        
        return `
          <div class="bg-gray-700 p-3 rounded border-l-4 ${statusColor}">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold text-white">${statusIcon} ${statusText}</div>
                <div class="text-gray-300 text-sm">User: ${entry.username || 'Unknown'} (${entry.user_id})</div>
                <div class="text-gray-300 text-sm">Role: ${entry.role_name || entry.role_id}</div>
                <div class="text-gray-300 text-sm">Date: ${date}</div>
                <div class="text-gray-300 text-sm">Reason: ${entry.reason || 'No reason provided'}</div>
                ${isRevoked ? `<div class="text-gray-300 text-sm">Revoked: ${new Date(entry.revoked_at).toLocaleString()}</div>` : ''}
              </div>
              <div class="text-right">
                <span class="px-2 py-1 rounded text-xs font-semibold ${isRevoked ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}">
                  ${statusText}
                </span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Search role history
    async function searchRoleHistory() {
      const searchTerm = document.getElementById('historyUserSearch').value.trim();
      if (!searchTerm) {
        addVerificationLog('❌ Please enter a search term');
        return;
      }

      try {
        const response = await fetch(`/api/admin/get-role-grant-history.php?user_id=${encodeURIComponent(searchTerm)}&limit=50`);
        const data = await response.json();
        
        if (data.success) {
          displayRoleHistory(data.history);
          addVerificationLog(`🔍 Found ${data.history.length} matching role history entries`);
        } else {
          addVerificationLog(`❌ Search failed: ${data.error}`);
        }
      } catch (error) {
        addVerificationLog(`❌ Search error: ${error.message}`);
      }
    }

  </script>

  <!-- Database Upload Modal -->
  <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">📤 Upload Database</h3>
        <button onclick="hideUploadModal()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="uploadForm" onsubmit="event.preventDefault(); uploadDatabase();">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select SQLite Database File:</label>
          <input type="file" id="dbFile" accept=".sqlite,.db" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div id="uploadStatus" class="mb-4"></div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="hideUploadModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Upload Database
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Database Viewer Modal -->
  <div id="viewerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">👁️ Database Viewer</h3>
        <button onclick="hideDatabaseViewer()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div id="viewerContent" class="overflow-y-auto max-h-[calc(90vh-120px)]">
        <!-- Database viewer content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Database Unlock Modal -->
  <div id="unlockModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">🔓 Unlock Database Access</h3>
        <button onclick="hideDatabaseUnlock()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <p class="text-sm text-gray-600 mb-3">Enter the internal password to access database operations:</p>
        <input type="password" id="databasePassword" placeholder="Enter database password..." 
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div id="unlockStatus" class="mb-4"></div>
      
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="hideDatabaseUnlock()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300">
          Cancel
        </button>
        <button onclick="unlockDatabase()" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">
          🔓 Unlock Access
        </button>
      </div>
    </div>
  </div>

</body>
</html> 