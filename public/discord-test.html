<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Narrrf's World Admin Interface</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- üîó Discord Token of Render System -->
  <script src="discord-config.js"></script>
  
  <style>
    .admin-card {
      background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
      border-radius: 15px;
      padding: 20px;
      margin: 10px;
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .stats-card {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      border-radius: 12px;
      padding: 15px;
      margin: 8px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .user-card {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 8px;
      border-left: 4px solid #f0c92c;
      transition: all 0.3s ease;
    }
    .user-card:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    .tab-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
    }
    .tab-btn.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }
    .history-item {
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin: 5px 0;
      border-left: 4px solid #f0c92c;
    }
    .positive { border-left-color: #10b981; }
    .negative { border-left-color: #ef4444; }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-purple-50 to-pink-100 min-h-screen p-4">
  
  <div class="max-w-7xl mx-auto">
    
    <!-- Header -->
    <div class="text-center mb-6">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">üéÆ Narrrf's World Admin Interface</h1>
      <p class="text-gray-600">Complete Discord Bot Management System</p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="stats-card">
        <h3 class="text-lg font-semibold">üë• Total Users</h3>
        <p class="text-2xl font-bold" id="totalUsers">Loading...</p>
      </div>
      <div class="stats-card">
        <h3 class="text-lg font-semibold">üí∞ Total Scores</h3>
        <p class="text-2xl font-bold" id="totalScores">Loading...</p>
      </div>
      <div class="stats-card">
        <h3 class="text-lg font-semibold">üè™ Store Items</h3>
        <p class="text-2xl font-bold" id="totalItems">Loading...</p>
      </div>
      <div class="stats-card">
        <h3 class="text-lg font-semibold">üèÜ Active Quests</h3>
        <p class="text-2xl font-bold" id="activeQuests">Loading...</p>
      </div>
    </div>

    <!-- Admin Authentication -->
    <div class="admin-card mb-6" id="authPanel">
      <h2 class="text-xl font-semibold mb-4">üîê Admin Authentication</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">Discord ID:</label>
          <input type="text" id="adminDiscordId" placeholder="Your Discord ID" class="w-full px-3 py-2 rounded text-gray-800">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Admin Role:</label>
          <select id="adminRole" class="w-full px-3 py-2 rounded text-gray-800">
            <option value="moderator">Moderator</option>
            <option value="admin">Admin</option>
            <option value="super_admin">Super Admin</option>
          </select>
        </div>
        <div class="flex items-end">
          <button onclick="authenticateAdmin()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">Login</button>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="admin-card mb-6" id="navPanel" style="display: none;">
      <div class="flex flex-wrap gap-2 mb-4">
        <button class="tab-btn active px-4 py-2 rounded" data-tab="dashboard">üìä Dashboard</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="users">üë• User Management</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="points">üí∞ Point Management</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="store">üè™ Store Management</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="quests">üèÜ Quest System</button>
        <button class="tab-btn px-4 py-2 rounded" data-tab="discord">üîó Discord Config</button>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="admin-card mb-6" id="dashboardTab">
      <h2 class="text-xl font-semibold mb-4">üìä System Dashboard</h2>
      
      <!-- Recent Activity -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-3">üîÑ Recent Point Adjustments</h3>
          <div id="recentAdjustments" class="max-h-64 overflow-y-auto">
            <div class="text-gray-300">Loading recent adjustments...</div>
          </div>
        </div>
        
        <div>
          <h3 class="text-lg font-semibold mb-3">üèÜ Top Users by Balance</h3>
          <div id="topUsers" class="max-h-64 overflow-y-auto">
            <div class="text-gray-300">Loading top users...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Management Tab -->
    <div class="admin-card mb-6" id="usersTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">üë• User Management</h2>
      
      <!-- Instant User Search -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">üîç Instant User Search:</label>
        <div class="flex gap-2">
          <input type="text" id="userSearch" placeholder="Search by Discord ID or username..." 
                 class="flex-1 px-3 py-2 rounded text-gray-800" 
                 oninput="searchUsersInstant(this.value)">
          <button onclick="searchUsers()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Search</button>
        </div>
      </div>

      <!-- User Results -->
      <div id="userResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="text-gray-300">Search for users to see results...</div>
      </div>
    </div>

    <!-- Point Management Tab -->
    <div class="admin-card mb-6" id="pointsTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">üí∞ Point Management</h2>
      
      <!-- Quick User Selection -->
      <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">üéØ Quick User Selection</h3>
        <div class="flex gap-2">
          <input type="text" id="quickUserId" placeholder="Enter Discord User ID" 
                 class="flex-1 px-3 py-2 rounded text-gray-800">
          <button onclick="quickSelectUser()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Select User</button>
        </div>
        <div id="selectedUserInfo" class="mt-3 p-3 bg-gray-700 rounded hidden">
          <!-- Selected user info will appear here -->
        </div>
      </div>

      <!-- Point Operations -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <!-- Add Points -->
        <div class="bg-green-900 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">‚ûï Add Points</h3>
          <div class="space-y-3">
            <input type="text" id="addUserId" placeholder="Discord User ID" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="number" id="addAmount" placeholder="Amount to add" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="text" id="addReason" placeholder="Reason (optional)" class="w-full px-3 py-2 rounded text-gray-800">
            <button onclick="addPoints()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Points</button>
          </div>
        </div>

        <!-- Set Points -->
        <div class="bg-blue-900 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">üéØ Set Points</h3>
          <div class="space-y-3">
            <input type="text" id="setUserId" placeholder="Discord User ID" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="number" id="setAmount" placeholder="New total amount" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="text" id="setReason" placeholder="Reason (optional)" class="w-full px-3 py-2 rounded text-gray-800">
            <button onclick="setPoints()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Set Points</button>
          </div>
        </div>

        <!-- Remove Points -->
        <div class="bg-red-900 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">‚ûñ Remove Points</h3>
          <div class="space-y-3">
            <input type="text" id="removeUserId" placeholder="Discord User ID" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="number" id="removeAmount" placeholder="Amount to remove" class="w-full px-3 py-2 rounded text-gray-800">
            <input type="text" id="removeReason" placeholder="Reason (optional)" class="w-full px-3 py-2 rounded text-gray-800">
            <button onclick="removePoints()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Remove Points</button>
          </div>
        </div>
      </div>

      <!-- Balance & History -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Quick Balance Check -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">üí≥ Quick Balance Check</h3>
          <div class="flex gap-2">
            <input type="text" id="balanceUserId" placeholder="Discord User ID" class="flex-1 px-3 py-2 rounded text-gray-800">
            <button onclick="checkBalance()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Check Balance</button>
          </div>
          <div id="balanceResult" class="mt-3 p-3 bg-gray-700 rounded hidden">
            <!-- Balance result will be shown here -->
          </div>
        </div>

        <!-- Transaction History -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">üìã Transaction History</h3>
          <div class="flex gap-2 mb-3">
            <input type="text" id="historyUserId" placeholder="Discord User ID" class="flex-1 px-3 py-2 rounded text-gray-800">
            <button onclick="getHistory()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">Get History</button>
          </div>
          <div id="historyResult" class="max-h-64 overflow-y-auto">
            <!-- History will be shown here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Store Management Tab -->
    <div class="admin-card mb-6" id="storeTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">üè™ Store Management</h2>
      
      <!-- Store Items -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">üì¶ Available Store Items</h3>
        <div id="storeItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="text-gray-300">Loading store items...</div>
        </div>
      </div>

      <!-- Add New Item -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">‚ûï Add New Store Item</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="newItemName" placeholder="Item Name" class="px-3 py-2 rounded text-gray-800">
          <input type="number" id="newItemPrice" placeholder="Price in $DSPOINC" class="px-3 py-2 rounded text-gray-800">
          <textarea id="newItemDescription" placeholder="Item Description" class="px-3 py-2 rounded text-gray-800 md:col-span-2"></textarea>
          <button onclick="addStoreItem()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Item</button>
        </div>
      </div>
    </div>

    <!-- Quest System Tab -->
    <div class="admin-card mb-6" id="questsTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">üèÜ Quest System</h2>
      
      <!-- Active Quests -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">üéØ Active Quests</h3>
        <div id="activeQuestsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="text-gray-300">Loading active quests...</div>
        </div>
      </div>

      <!-- Create New Quest -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">‚ûï Create New Quest</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="newQuestType" placeholder="Quest Type" class="px-3 py-2 rounded text-gray-800">
          <input type="number" id="newQuestReward" placeholder="Reward in $DSPOINC" class="px-3 py-2 rounded text-gray-800">
          <input type="text" id="newQuestUrl" placeholder="Quest URL" class="px-3 py-2 rounded text-gray-800">
          <textarea id="newQuestDescription" placeholder="Quest Description" class="px-3 py-2 rounded text-gray-800 md:col-span-2"></textarea>
          <button onclick="createQuest()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Create Quest</button>
        </div>
      </div>
    </div>

    <!-- Discord Config Tab -->
    <div class="admin-card mb-6" id="discordTab" style="display: none;">
      <h2 class="text-xl font-semibold mb-4">üîó Discord Configuration</h2>
      
      <!-- Current Discord Settings -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <p><strong>Current Invite Code:</strong> <span id="currentCode" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
          <p><strong>Full Discord URL:</strong> <span id="currentUrl" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
        </div>
        <div>
          <p><strong>System Version:</strong> <span id="systemVersion" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
          <p><strong>Last Updated:</strong> <span id="lastUpdated" class="font-mono bg-gray-800 px-2 py-1 rounded">Loading...</span></p>
        </div>
      </div>
      
      <!-- Update Discord Settings -->
      <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-3">üîÑ Update Discord Settings</h3>
        <div class="flex gap-2">
          <input type="text" id="newInviteCode" placeholder="Enter new invite code" class="flex-1 px-3 py-2 rounded text-gray-800" value="rHc4Jg5Q">
          <button onclick="updateInviteCode()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Update</button>
        </div>
      </div>
    </div>

    <!-- Admin Activity Log -->
    <div class="admin-card">
      <h2 class="text-xl font-semibold mb-4">üìä Admin Activity Log</h2>
      <div id="statusLog" class="bg-gray-800 p-4 rounded text-sm font-mono h-32 overflow-y-auto">
        <div class="text-green-400">üîÑ Admin interface initializing...</div>
      </div>
    </div>

  </div>

  <script>
    // Global variables
    let currentAdmin = null;
    let currentTab = 'dashboard';
    let searchTimeout = null;

    // Initialize the interface
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        updateDisplay();
        loadDashboardData();
        addLog('üéØ Admin interface loaded successfully');
        addLog('üîê Please authenticate to access admin features');
      }, 100);
    });

    // Update Discord display
    function updateDisplay() {
      document.getElementById('currentCode').textContent = DISCORD_CONFIG.inviteCode;
      document.getElementById('currentUrl').textContent = DISCORD_CONFIG.getCurrentUrl();
      document.getElementById('systemVersion').textContent = DISCORD_CONFIG.version;
      document.getElementById('lastUpdated').textContent = DISCORD_CONFIG.lastUpdated;
    }

    // Load dashboard data
    async function loadDashboardData() {
      try {
        // Load stats
        const statsResponse = await fetch('/api/admin/get-stats.php');
        const stats = await statsResponse.json();
        
        if (stats.success) {
          document.getElementById('totalUsers').textContent = stats.totalUsers;
          document.getElementById('totalScores').textContent = stats.totalScores;
          document.getElementById('totalItems').textContent = stats.totalItems;
          document.getElementById('activeQuests').textContent = stats.activeQuests;
        }

        // Load recent adjustments
        const adjustmentsResponse = await fetch('/api/admin/get-recent-adjustments.php');
        const adjustments = await adjustmentsResponse.json();
        
        if (adjustments.success) {
          displayRecentAdjustments(adjustments.adjustments);
        }

        // Load top users
        const topUsersResponse = await fetch('/api/admin/get-top-users.php');
        const topUsers = await topUsersResponse.json();
        
        if (topUsers.success) {
          displayTopUsers(topUsers.users);
        }

      } catch (error) {
        addLog(`‚ùå Error loading dashboard data: ${error.message}`);
      }
    }

    // Display recent adjustments
    function displayRecentAdjustments(adjustments) {
      const container = document.getElementById('recentAdjustments');
      
      if (adjustments.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No recent adjustments</div>';
        return;
      }

      container.innerHTML = adjustments.map(adj => {
        const amount = parseInt(adj.amount);
        const isPositive = amount > 0;
        const timestamp = new Date(adj.timestamp).toLocaleString();
        
        return `
          <div class="history-item ${isPositive ? 'positive' : 'negative'}">
            <div class="flex justify-between items-start">
              <div>
                <strong>${isPositive ? '+' : ''}${amount.toLocaleString()} $DSPOINC</strong>
                <span class="text-sm text-gray-300 ml-2">(${adj.action})</span>
              </div>
              <div class="text-xs text-gray-400">${timestamp}</div>
            </div>
            <div class="text-sm text-gray-300 mt-1">User: ${adj.user_id}</div>
            <div class="text-sm text-gray-300">Reason: ${adj.reason || 'No reason'}</div>
          </div>
        `;
      }).join('');
    }

    // Display top users
    function displayTopUsers(users) {
      const container = document.getElementById('topUsers');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No users found</div>';
        return;
      }

      container.innerHTML = users.map((user, index) => `
        <div class="user-card">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold">#${index + 1} ${user.username || 'Unknown User'}</h4>
              <p class="text-sm text-gray-300">ID: ${user.user_id}</p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold text-yellow-400">${user.total_score?.toLocaleString() || 0} $DSPOINC</p>
            </div>
          </div>
          <button onclick="selectUser('${user.user_id}', '${user.username || 'Unknown'}')" 
                  class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm w-full">
            Select User
          </button>
        </div>
      `).join('');
    }

    // Admin authentication
    function authenticateAdmin() {
      const discordId = document.getElementById('adminDiscordId').value.trim();
      const role = document.getElementById('adminRole').value;
      
      if (!discordId) {
        addLog('‚ùå Please enter your Discord ID');
        return;
      }

      currentAdmin = {
        discordId: discordId,
        role: role
      };

      document.getElementById('authPanel').style.display = 'none';
      document.getElementById('navPanel').style.display = 'block';
      addLog(`‚úÖ Admin authenticated: ${discordId} (${role})`);
    }

    // Tab navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const tab = this.dataset.tab;
        
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Hide all tabs
        document.querySelectorAll('[id$="Tab"]').forEach(t => t.style.display = 'none');
        
        // Show selected tab
        document.getElementById(tab + 'Tab').style.display = 'block';
        
        currentTab = tab;
        addLog(`üìã Switched to ${tab} tab`);
        
        // Load tab-specific data
        if (tab === 'store') loadStoreItems();
        if (tab === 'quests') loadQuests();
      });
    });

    // Instant user search
    function searchUsersInstant(searchTerm) {
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        document.getElementById('userResults').innerHTML = '<div class="text-gray-300">Enter at least 2 characters to search...</div>';
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/admin/point-management.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'searchuser',
              search: searchTerm
            })
          });

          const data = await response.json();
          
          if (data.success) {
            displayUserResults(data.users);
            addLog(`üîç Found ${data.users.length} users matching "${searchTerm}"`);
          } else {
            addLog(`‚ùå Search failed: ${data.error}`);
          }
        } catch (error) {
          addLog(`‚ùå Search error: ${error.message}`);
        }
      }, 300);
    }

    // User search
    async function searchUsers() {
      const searchTerm = document.getElementById('userSearch').value.trim();
      if (!searchTerm) {
        addLog('‚ùå Please enter a search term');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'searchuser',
            search: searchTerm
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayUserResults(data.users);
          addLog(`üîç Found ${data.users.length} users matching "${searchTerm}"`);
        } else {
          addLog(`‚ùå Search failed: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Search error: ${error.message}`);
      }
    }

    // Display user search results
    function displayUserResults(users) {
      const container = document.getElementById('userResults');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No users found</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="user-card">
          <h4 class="font-semibold mb-2">${user.username || 'Unknown User'}</h4>
          <p class="text-sm text-gray-300 mb-2">ID: ${user.user_id}</p>
          <p class="text-sm text-yellow-400 mb-3">Balance: ${user.score?.toLocaleString() || 0} $DSPOINC</p>
          <button onclick="selectUser('${user.user_id}', '${user.username || 'Unknown'}')" 
                  class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm w-full">
            Select User
          </button>
        </div>
      `).join('');
    }

    // Quick user selection
    async function quickSelectUser() {
      const userId = document.getElementById('quickUserId').value.trim();
      
      if (!userId) {
        addLog('‚ùå Please enter a user ID');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getbalance',
            user_id: userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          selectUser(userId, `User ${userId}`);
          const infoDiv = document.getElementById('selectedUserInfo');
          infoDiv.innerHTML = `
            <div class="text-green-400">
              <strong>Selected User:</strong> ${userId}<br>
              <strong>Balance:</strong> ${data.balance.toLocaleString()} $DSPOINC
            </div>
          `;
          infoDiv.classList.remove('hidden');
          addLog(`üë§ Selected user: ${userId} (${data.balance.toLocaleString()} $DSPOINC)`);
        } else {
          addLog(`‚ùå User not found: ${userId}`);
        }
      } catch (error) {
        addLog(`‚ùå Error selecting user: ${error.message}`);
      }
    }

    // Select user for point operations
    function selectUser(userId, username) {
      // Fill all point operation forms with this user
      document.getElementById('addUserId').value = userId;
      document.getElementById('setUserId').value = userId;
      document.getElementById('removeUserId').value = userId;
      document.getElementById('balanceUserId').value = userId;
      document.getElementById('historyUserId').value = userId;
      document.getElementById('quickUserId').value = userId;
      
      addLog(`üë§ Selected user: ${username} (${userId})`);
    }

    // Add points
    async function addPoints() {
      if (!currentAdmin) {
        addLog('‚ùå Please authenticate as admin first');
        return;
      }

      const userId = document.getElementById('addUserId').value.trim();
      const amount = parseInt(document.getElementById('addAmount').value);
      const reason = document.getElementById('addReason').value.trim() || 'Manual admin adjustment';

      if (!userId || !amount || amount <= 0) {
        addLog('‚ùå Please enter valid user ID and amount');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'addpoints',
            admin_id: currentAdmin.discordId,
            user_id: userId,
            amount: amount,
            reason: reason
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`‚úÖ ${data.message} - New balance: ${data.new_balance.toLocaleString()} $DSPOINC`);
          // Clear form
          document.getElementById('addAmount').value = '';
          document.getElementById('addReason').value = '';
          // Reload dashboard data
          loadDashboardData();
        } else {
          addLog(`‚ùå Failed to add points: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Add points error: ${error.message}`);
      }
    }

    // Set points
    async function setPoints() {
      if (!currentAdmin) {
        addLog('‚ùå Please authenticate as admin first');
        return;
      }

      const userId = document.getElementById('setUserId').value.trim();
      const amount = parseInt(document.getElementById('setAmount').value);
      const reason = document.getElementById('setReason').value.trim() || 'Manual set by admin';

      if (!userId || amount < 0) {
        addLog('‚ùå Please enter valid user ID and amount');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'setpoints',
            admin_id: currentAdmin.discordId,
            user_id: userId,
            amount: amount,
            reason: reason
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`‚úÖ ${data.message}`);
          // Clear form
          document.getElementById('setAmount').value = '';
          document.getElementById('setReason').value = '';
          // Reload dashboard data
          loadDashboardData();
        } else {
          addLog(`‚ùå Failed to set points: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Set points error: ${error.message}`);
      }
    }

    // Remove points
    async function removePoints() {
      if (!currentAdmin) {
        addLog('‚ùå Please authenticate as admin first');
        return;
      }

      const userId = document.getElementById('removeUserId').value.trim();
      const amount = parseInt(document.getElementById('removeAmount').value);
      const reason = document.getElementById('removeReason').value.trim() || 'Manual admin adjustment';

      if (!userId || !amount || amount <= 0) {
        addLog('‚ùå Please enter valid user ID and amount');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'removepoints',
            admin_id: currentAdmin.discordId,
            user_id: userId,
            amount: amount,
            reason: reason
          })
        });

        const data = await response.json();
        
        if (data.success) {
          addLog(`‚úÖ ${data.message} - New balance: ${data.new_balance.toLocaleString()} $DSPOINC`);
          // Clear form
          document.getElementById('removeAmount').value = '';
          document.getElementById('removeReason').value = '';
          // Reload dashboard data
          loadDashboardData();
        } else {
          addLog(`‚ùå Failed to remove points: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Remove points error: ${error.message}`);
      }
    }

    // Check balance
    async function checkBalance() {
      const userId = document.getElementById('balanceUserId').value.trim();
      
      if (!userId) {
        addLog('‚ùå Please enter a user ID');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getbalance',
            user_id: userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          const resultDiv = document.getElementById('balanceResult');
          resultDiv.innerHTML = `
            <div class="text-green-400">
              <strong>User ID:</strong> ${data.user_id}<br>
              <strong>Balance:</strong> ${data.balance.toLocaleString()} $DSPOINC
            </div>
          `;
          resultDiv.classList.remove('hidden');
          addLog(`üí≥ Balance for ${userId}: ${data.balance.toLocaleString()} $DSPOINC`);
        } else {
          addLog(`‚ùå Failed to get balance: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Check balance error: ${error.message}`);
      }
    }

    // Get transaction history
    async function getHistory() {
      const userId = document.getElementById('historyUserId').value.trim();
      
      if (!userId) {
        addLog('‚ùå Please enter a user ID');
        return;
      }

      try {
        const response = await fetch('/api/admin/point-management.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'gethistory',
            user_id: userId,
            limit: 20
          })
        });

        const data = await response.json();
        
        if (data.success) {
          displayHistory(data.history);
          addLog(`üìã Retrieved ${data.history.length} transactions for ${userId}`);
        } else {
          addLog(`‚ùå Failed to get history: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Get history error: ${error.message}`);
      }
    }

    // Display transaction history
    function displayHistory(history) {
      const container = document.getElementById('historyResult');
      
      if (history.length === 0) {
        container.innerHTML = '<div class="text-gray-400">No transaction history found.</div>';
        return;
      }

      container.innerHTML = history.map(item => {
        const amount = parseInt(item.amount);
        const isPositive = amount > 0;
        const timestamp = new Date(item.timestamp).toLocaleString();
        
        return `
          <div class="history-item ${isPositive ? 'positive' : 'negative'}">
            <div class="flex justify-between items-start">
              <div>
                <strong>${isPositive ? '+' : ''}${amount.toLocaleString()} $DSPOINC</strong>
                <span class="text-sm text-gray-300 ml-2">(${item.action})</span>
              </div>
              <div class="text-xs text-gray-400">${timestamp}</div>
            </div>
            <div class="text-sm text-gray-300 mt-1">Reason: ${item.reason || 'No reason provided'}</div>
            <div class="text-xs text-gray-500">Admin: ${item.admin_id}</div>
          </div>
        `;
      }).join('');
    }

    // Load store items
    async function loadStoreItems() {
      try {
        const response = await fetch('/api/store/items.php');
        const data = await response.json();
        
        if (data.success) {
          displayStoreItems(data.items);
          addLog(`üè™ Loaded ${data.items.length} store items`);
        } else {
          addLog(`‚ùå Failed to load store items: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Store items error: ${error.message}`);
      }
    }

    // Display store items
    function displayStoreItems(items) {
      const container = document.getElementById('storeItems');
      
      if (items.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No store items found</div>';
        return;
      }

      container.innerHTML = items.map(item => `
        <div class="user-card">
          <h4 class="font-semibold mb-2">${item.item_name}</h4>
          <p class="text-sm text-gray-300 mb-2">${item.description || 'No description'}</p>
          <p class="text-lg font-bold text-yellow-400 mb-3">${item.price?.toLocaleString() || 0} $DSPOINC</p>
          <div class="flex gap-2">
            <button onclick="editStoreItem(${item.item_id})" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
              Edit
            </button>
            <button onclick="deleteStoreItem(${item.item_id})" 
                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
              Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // Load quests
    async function loadQuests() {
      try {
        const response = await fetch('/api/admin/get-quests.php');
        const data = await response.json();
        
        if (data.success) {
          displayQuests(data.quests);
          addLog(`üèÜ Loaded ${data.quests.length} quests`);
        } else {
          addLog(`‚ùå Failed to load quests: ${data.error}`);
        }
      } catch (error) {
        addLog(`‚ùå Quests error: ${error.message}`);
      }
    }

    // Display quests
    function displayQuests(quests) {
      const container = document.getElementById('activeQuestsList');
      
      if (quests.length === 0) {
        container.innerHTML = '<div class="text-gray-300">No active quests found</div>';
        return;
      }

      container.innerHTML = quests.map(quest => `
        <div class="user-card">
          <h4 class="font-semibold mb-2">${quest.type}</h4>
          <p class="text-sm text-gray-300 mb-2">${quest.description || 'No description'}</p>
          <p class="text-lg font-bold text-yellow-400 mb-3">${quest.reward?.toLocaleString() || 0} $DSPOINC</p>
          <div class="flex gap-2">
            <button onclick="editQuest(${quest.quest_id})" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
              Edit
            </button>
            <button onclick="deleteQuest(${quest.quest_id})" 
                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
              Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // Update invite code
    function updateInviteCode() {
      const newCode = document.getElementById('newInviteCode').value.trim();
      if (newCode) {
        DISCORD_CONFIG.updateInviteCode(newCode);
        updateDisplay();
        addLog(`‚úÖ Updated invite code to: ${newCode}`);
      }
    }

    // Add log entry
    function addLog(message) {
      const log = document.getElementById('statusLog');
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `<div class="text-blue-400">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

  </script>

</body>
</html> 