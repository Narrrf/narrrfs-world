<?php
session_start();
$discordId = $_SESSION['discord_id'] ?? '';

// Include Discord invite configuration
require_once 'discord-invite.php';
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ§  Your Narrrf Profile</title>
  <script>
  window.sessionDiscordId = "<?= htmlspecialchars($discordId) ?>";
</script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- ğŸ”— Discord Token of Render System -->
  <script src="discord-config.js"></script>
  
  <meta name="theme-color" content="#fcd34d">
  <link rel="icon" href="favicon-phantom.png" type="image/png">

  <style>
    /* ğŸ¨ Style Card Elements */
    .card {
      background: #36393f;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    /* ğŸ–¼ï¸ Avatar */
    .avatar {
      border-radius: 50%;
      width: 100px;
      height: 100px;
      margin-bottom: 15px;
    }

    /* ğŸ§  Username */
    .username {
      font-size: 1.5em;
      margin-bottom: 5px;
    }

    /* ğŸ§¬ Tagline + Guild Info */
    .tagline {
      font-size: 0.95em;
      color: #b9bbbe;
      margin-bottom: 20px;
    }
    .guilds {
      margin-top: 15px;
      font-size: 0.9em;
    }

    /* ğŸ§€ Highlight Text */
    .cheese {
      margin-top: 25px;
      font-style: italic;
      color: #fcd34d;
    }
    @keyframes pop {
  0% { transform: scale(0.9); opacity: 0.3; }
  100% { transform: scale(1); opacity: 1; }
}
.animate-pop {
  animation: pop 0.4s ease-out;
}
@keyframes fade-in {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-fade-in {
  animation: fade-in 0.3s ease-out;
}
@keyframes glow {
  0% {
    text-shadow: 0 0 5px #f472b6, 0 0 10px #f472b6, 0 0 15px #f472b6;
  }
  50% {
    text-shadow: 0 0 10px #f472b6, 0 0 20px #f472b6, 0 0 25px #f472b6;
  }
  100% {
    text-shadow: 0 0 5px #f472b6, 0 0 10px #f472b6, 0 0 15px #f472b6;
  }
}

.animate-glow {
  animation: glow 1s ease-in-out infinite;
}

@keyframes sparkle {
  0%, 100% { opacity: 0.8; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}
.star-flash {
  position: absolute;
  width: 30px;
  height: 30px;
  background-image: url('/img/star-sparkle.png');
  background-size: contain;
  animation: sparkle 2s infinite ease-in-out;
}
@keyframes wiggle {
  0%, 100% { transform: rotate(-1deg); }
  50% { transform: rotate(1deg); }
}
.wiggle-text {
  animation: wiggle 1s infinite ease-in-out;
}
  </style>
</head>


<!-- âœ… Profile Scroll DOM Zone - Enhanced for Future-Proofing and Mobile Optimization -->
<!-- 
  Narrrfs World Profile Page
  Genesis 11.0 Certified Responsive Update
  ========================================
  - Responsive enhancements for mobile and desktop
  - Preserved original Tailwind CSS and JS hooks
  - Comprehensive dev-friendly comments for long-term maintainability
  ========================================
-->

<body class="bg-[#2f3136] text-white font-sans min-h-screen">

<!-- ğŸ”° Header with App Context -->
<header class="w-full bg-black py-4 px-6 text-yellow-400 shadow-md">
  <div class="max-w-6xl mx-auto flex justify-between items-center">
    <h1 class="text-xl font-bold tracking-wide">ğŸ§  Narrrf's Lab â€“ Phase 5 Portal</h1>
    <nav class="space-x-4 text-sm md:text-base flex items-center">
      <a href="index.html" class="hover:text-pink-400">Home</a>
      <a href="mint.html" class="hover:text-pink-400">Mint</a>
      <a href="whitepaper.html" class="hover:text-pink-400">Whitepaper</a>
      <a href="get-roles.html" class="hover:text-pink-400">Get Roles</a>
      <a href="project-updates.html" class="hover:text-pink-400">Updates</a>
      <a href="faq.html" class="hover:text-pink-400">FAQ</a>
      <button id="connect-wallet-btn" onclick="connectWallet()" 
        class="ml-2 mt-2 md:mt-0 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1 px-4 rounded-xl shadow text-xs">
        ğŸ”Œ Connect
      </button>
      <img id="user-avatar" src="img/cheese.png" alt="PFP" class="hidden w-8 h-8 rounded-full border-2 border-white ml-2 shadow-lg" />
      <button id="wallet-disconnect" onclick="disconnectWallet()" class="hidden ml-2 text-sm bg-red-500 hover:bg-red-600 text-white rounded-full px-3 py-1 shadow">
        âŒ
      </button>
    </nav>
  </div>
</header>

<!-- ğŸª Cookie Consent Banner - GDPR Compliant -->
<div id="cookie-consent-banner" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-blue-900 via-purple-900 to-indigo-900 text-white p-4 shadow-2xl z-50 border-b-2 border-blue-400 transform transition-transform duration-500 ease-out">
  <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
    <div class="flex-1 text-center md:text-left">
      <div class="flex items-center justify-center md:justify-start gap-2 mb-2">
        <span class="text-2xl">ğŸª</span>
        <h3 class="text-lg font-semibold">Cookie Policy</h3>
      </div>
      <p class="text-sm text-blue-100 leading-relaxed">
        We use cookies and similar technologies to provide you with the best experience on our website. 
        This includes essential cookies for authentication, session management, and website functionality. 
        By clicking "Accept All", you consent to our use of cookies as described in our 
        <a href="/privacy-policy.html" class="text-yellow-300 hover:text-yellow-200 underline font-semibold">Privacy Policy</a>.
      </p>
      <div class="mt-2">
        <a href="/privacy-policy.html" class="text-xs text-blue-200 hover:text-blue-100 underline">
          ğŸ“– Read Full Privacy Policy
        </a>
      </div>
    </div>
    
    <div class="flex flex-col sm:flex-row gap-3 items-center">
      <button id="cookie-decline" 
              class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium text-sm transition-colors duration-200 border border-gray-500">
        Decline Non-Essential
      </button>
      <button id="cookie-accept" 
              class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg font-semibold text-sm transition-all duration-200 transform hover:scale-105 shadow-lg">
        Accept All Cookies
      </button>
    </div>
  </div>
</div>

<!-- â« Spacer to offset fixed banner height -->
<div id="cookie-banner-spacer" class="h-24 md:h-20"></div>

<!-- VIP Section: Grouped and spaced -->
<div id="vipSection" class="flex flex-col items-center gap-3 mb-6 mt-4 hidden">
  <div class="bg-yellow-100 border-2 border-yellow-300 px-6 py-3 rounded-xl font-bold text-yellow-900 shadow mb-1 text-center">
    ğŸ§€ Welcome, VIP! You found the Golden Cheese
  </div>
  <a href="/api/user/download-vip-art.php"
     class="bg-yellow-300 hover:bg-yellow-400 text-black font-bold px-6 py-2 rounded-xl shadow-md border-2 border-yellow-400 transition"
     download>
    ğŸ“¸ Download Your HD VIP NFT
  </a>
</div>

<!-- ğŸ§‚ VIP Absence Fallback -->
<div id="noCheeseJoke" class="hidden mt-4 text-sm italic text-gray-500">
  ğŸ˜… ... no VIP pass? That's nacho cheese!
</div>

<!-- Spacer for top nav offset -->
<div class="h-4 md:h-6"></div>


<!-- ğŸ”” PROFESSIONAL BINGO CHECKER BANNER -->
<div id="bingoBanner" class="hidden mt-6 relative p-5 mb-6 rounded-lg shadow-lg bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 text-white text-center overflow-hidden border-4 border-yellow-300 animate-pulse">
  <div class="absolute inset-0 opacity-25 bg-[url('/img/cheese-texture.png')] bg-cover bg-center pointer-events-none"></div>
  <a href="/Bingo.html" class="relative z-10 text-2xl sm:text-3xl font-extrabold tracking-wide drop-shadow hover:underline">
    ğŸ¯ Try the New <span class="underline decoration-wavy decoration-white">Professional Bingo Checker</span> Now!
  </a>
</div>


<!-- ğŸ‘¤ User Profile Card -->
<main class="container mx-auto px-4 py-8 max-w-6xl">
  <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full text-center border-4 border-yellow-400">

    <!-- ğŸ‘‹ Welcome Message -->
<span id="welcome-name"></span>
    <p id="welcome-msg" class="text-yellow-300 text-sm italic mb-2">
      Welcome back, <span id="welcome-name">loading...</span>
    </p>

<!-- ğŸ–¼ï¸ User Avatar or Discord Login -->
<div class="w-24 h-24 mx-auto mb-4">
  <a id="login-link" href="https://discord.com/oauth2/authorize?client_id=1357927342265204858&response_type=code&redirect_uri=https%3A%2F%2Fnarrrfs.world%2Fapi%2Fauth%2Fcallback.php&scope=guilds+identify+guilds.members.read">
    <img id="avatar"
         class="rounded-full border-4 border-yellow-500 shadow animate-bounce cursor-pointer transition hover:scale-105"
         src="img/grumpy-cheese.png"
         alt="Grumpy Guest Avatar"
         title="Click to login via Discord"
         width="96"
         height="96" />
  </a>
</div>

    <!-- ğŸ“› Username Display -->
    <h1 id="username" class="text-2xl font-bold text-yellow-300">Loading...</h1>
    <p id="email" class="text-sm text-gray-400">...</p>
    <p id="guilds" class="mt-2 text-sm text-yellow-100 italic">Guilds loading...</p>

    <!-- ğŸ¯ Check WL Button -->
    <div class="mt-4">
      <button id="checkWLButton" 
              onclick="checkWLRoleAndShowButton()"
              class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg shadow-lg border-2 border-blue-500 transition-all duration-300 transform hover:scale-105">
        ğŸ¯ Check WL Status
      </button>
      <div id="wlStatusMessage" class="text-xs text-gray-400 mt-2 italic hidden max-w-md mx-auto">
        <!-- Status message will be populated here -->
      </div>
    </div>

    <!-- ğŸ§ª Traits + Wallet View -->
    <div class="mt-6 bg-yellow-100 text-gray-900 rounded-lg p-4 shadow-inner">
      <h2 class="font-semibold text-lg mb-2">ğŸ’ Wallet & Traits</h2>
      <p id="wallet-address">ğŸ”— Linked wallet: <em class="text-sm">coming soon</em></p>
      <p>ğŸ§¬ Traits: <span id="traits">pending sync</span></p>
    </div>

    <!-- ğŸ“Š User Stats Section -->
    <div class="mt-6 bg-gray-700 rounded-lg p-4 shadow-inner">
      <h2 class="font-semibold text-lg mb-2 text-yellow-300">ğŸ“Š User Statistics</h2>
      <ul class="text-sm space-y-1">
        <li>ğŸ’° Total DSPOINC Balance: <strong id="user-spoinc" class="text-yellow-400">Loading...</strong></li>
        <li>ğŸ¯ Score Adjustments: <strong id="stats-adjustments">Loading...</strong></li>
        <li>ğŸ® Score Sources: <strong id="stats-sources">Loading...</strong></li>
        <li>â­ Active Roles: <strong id="stats-roles">Loading...</strong></li>
        <li>ğŸ“… Member Since: <strong id="stats-member-since">Loading...</strong></li>
      </ul>
    </div>

    <!-- ğŸ¯ Skills Section -->
    <div class="mt-6 bg-gray-700 rounded-lg p-4 shadow-inner">
      <h2 class="font-semibold text-lg mb-2 text-yellow-300">ğŸ¯ Skills & Roles</h2>
      <div class="skills-list">
        <!-- Skills will be populated by JavaScript -->
      </div>
    </div>

    <!-- ğŸšª Access Levels Section -->
    <div class="mt-6 bg-gray-700 rounded-lg p-4 shadow-inner">
      <h2 class="font-semibold text-lg mb-2 text-yellow-300">ğŸšª Access Levels</h2>
      <div class="access-levels-list">
        <!-- Access levels will be populated by JavaScript -->
      </div>
    </div>

    <!-- âœ… Session Note -->
    <div class="mt-4 text-xs text-gray-300 italic">
      OAuth session live Â· Verified via Discord
    </div>

    <!-- ğŸ”§ Admin Access Button (only visible to admins/moderators) -->
    <div id="adminAccessButton" class="mt-4 hidden">
      <button onclick="goToAdminInterface()" 
         class="inline-block bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-3 rounded-xl shadow-lg border-2 border-red-500 transition-all duration-300 transform hover:scale-105 cursor-pointer">
        ğŸ”§ ADMIN INTERFACE
      </button>
      <p class="text-xs text-gray-400 mt-2 italic">Access granted for administrators and moderators</p>
    </div>

    <!-- ğŸ¯ WL Role Mint Access Button (only visible to WL role users) -->
    <div id="wlMintButton" class="mt-4 hidden">
      <a href="/mint.html" 
         class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 rounded-xl shadow-lg border-2 border-green-500 transition-all duration-300 transform hover:scale-105">
        ğŸ§  Go to Mint (WL Access)
      </a>
      <p class="text-xs text-gray-400 mt-2 italic">You have Discord WL role access for minting</p>
    </div>

    <!-- ğŸ‘£ Footer Note -->
    <div class="mt-6 text-yellow-400 text-sm">
      ğŸ§  Profile powered by Cheese Architect 12.0 Â· Phase 5 Bridge Online
    </div>
	

<!-- ğŸ§€ Trophy Shelf Zone -->
<section id="trophy-shelf" class="my-16 px-4">
  <h2 class="text-center text-2xl sm:text-3xl font-extrabold text-yellow-400 mb-6 drop-shadow">
    ğŸ† Role Trophy Shelf
  </h2>

  <div id="cheeseShelf" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 justify-items-center">
    <!-- Dynamic trophies will appear here -->
  </div>

  <p class="text-center mt-6 text-xs italic text-yellow-200">Collect all the cheese pokals... or be forgotten.</p>
</section>

<!-- ğŸ´ Web3 Wallet Verification Section -->
<section id="nft-verification" class="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl p-6 shadow-2xl my-20 relative">
  <!-- âœ… Fully Functional Badge -->
  <div class="absolute -top-4 -right-4 rotate-6 bg-green-400 text-black text-xs font-extrabold px-3 py-1 rounded-full shadow-lg z-10 animate-pulse ring-2 ring-green-300">
    âœ… Fully Functional
  </div>
  
  <div class="text-center">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center justify-center gap-2">
      ğŸ´ NFT Holder Verification
    </h2>
         <p class="text-gray-300 mb-6">
       Connect your Phantom wallet to verify NFT ownership and get automatic Discord roles!
       <br><span class="text-green-400 text-sm">ğŸ” Secure: Requires cryptographic signature to prove wallet ownership</span>
     </p>
     
     <!-- ğŸ” Verification Process Info -->
     <div class="bg-gray-800/50 rounded-lg p-4 mb-6 text-left">
       <h3 class="text-lg font-semibold text-blue-300 mb-3 flex items-center gap-2">
         ğŸ” How NFT Verification Works
       </h3>
       <div class="space-y-3 text-sm">
         <div class="flex items-start gap-3">
           <span class="text-blue-400 font-bold">1.</span>
           <div>
             <strong class="text-blue-200">Wallet Connection:</strong> Connect your Phantom wallet securely
           </div>
         </div>
         <div class="flex items-start gap-3">
           <span class="text-blue-400 font-bold">2.</span>
           <div>
             <strong class="text-blue-200">Helius API Check:</strong> We use <a href="https://www.helius.dev/docs" target="_blank" class="text-yellow-400 hover:text-yellow-300 underline">Helius APIs</a> to efficiently search your wallet for our specific NFT collections
           </div>
         </div>
         <div class="flex items-start gap-3">
           <span class="text-blue-400 font-bold">3.</span>
           <div>
             <strong class="text-blue-200">Cryptographic Proof:</strong> Sign a message with your wallet to prove ownership
           </div>
         </div>
         <div class="flex items-start gap-3">
           <span class="text-blue-400 font-bold">4.</span>
           <div>
             <strong class="text-blue-200">Automatic Role Grant:</strong> Get Discord roles instantly based on your NFT holdings
           </div>
         </div>
       </div>
       
       <div class="mt-4 p-3 bg-blue-900/30 rounded-lg border border-blue-700">
         <div class="flex items-center gap-2 text-blue-200 mb-2">
           <span class="text-lg">ğŸ”—</span>
           <strong>Powered by Helius</strong>
         </div>
         <p class="text-xs text-blue-300">
           We use Helius' high-performance Solana infrastructure for fast, reliable NFT verification. 
           <a href="https://www.helius.dev/docs" target="_blank" class="text-yellow-400 hover:text-yellow-300 underline">Learn more about Helius APIs</a>
         </p>
       </div>
     </div>
    
    <!-- Wallet Connection Status -->
    <div id="wallet-status" class="hidden bg-gray-800 rounded-lg p-4 mb-4">
      <div class="text-green-400 font-semibold">âœ… Wallet Connected</div>
      <div id="wallet-address" class="text-gray-300 text-sm mt-1"></div>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <button id="connect-wallet-btn" onclick="connectWallet()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all">
        <span>ğŸ”—</span> Connect Wallet
      </button>
      <button id="verify-nfts-btn" onclick="verifyNFTs()" class="hidden bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all">
        <span>ğŸ”</span> Verify NFTs
      </button>
    </div>
    
    <!-- Loading Spinner -->
    <div id="verification-loading" class="hidden mt-4">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto"></div>
      <p class="text-gray-300 mt-2">Verifying NFTs...</p>
    </div>
    
    <!-- Error Display -->
    <div id="verification-error" class="hidden mt-4 bg-red-900 border border-red-500 rounded-lg p-4">
      <div class="text-red-300 font-semibold">âŒ Error</div>
      <div id="error-message" class="text-red-200 text-sm mt-1"></div>
    </div>
    
    <!-- Results Display -->
    <div id="verification-results" class="hidden mt-4 bg-green-900 border border-green-500 rounded-lg p-4">
      <div class="text-green-300 font-semibold">âœ… Verification Results</div>
      <div id="results-content" class="text-green-200 text-sm mt-1"></div>
    </div>
  </div>
</section>



<!-- ğŸ§€ Official Cheese Stamp -->
<div class="mt-6 flex justify-center">
  <div class="bg-yellow-400 text-white px-4 py-2 rounded-full border-4 border-white shadow-md">
    ğŸ§€ Official Cheese Stamp 2806
  </div>
</div>

<!-- DSPOINC Graph & Score Changes - Only Visible When Logged In -->
<div id="dspoincJourneySection" class="bg-gray-900 rounded-2xl shadow-2xl p-6 max-w-lg w-full text-center mt-10 mb-4 border-2 border-yellow-300 mx-auto hidden">
  <h2 class="text-xl font-bold text-yellow-300 mb-4 flex items-center gap-2">
    <img src="img/cheese-egg.png" class="w-6 h-6" alt=""> 
    Your $DSPOINC Journey
  </h2>
  <div>
    <span class="font-mono text-yellow-300">Balance:</span>
    <span id="user-dspoinc-journey" class="font-mono text-yellow-100 text-lg">0</span>
  </div>
  
  <div class="relative">
    <canvas id="pointsGraph" width="400" height="180"></canvas>
    <div id="pointsGraphMsg" class="absolute inset-0 flex items-center justify-center text-yellow-200 text-lg font-semibold bg-gray-900 bg-opacity-80 hidden"></div>
  </div>
  <div class="bg-gray-800 rounded-xl shadow p-4 mt-6 max-w-lg w-full mx-auto">
    <h3 class="text-yellow-300 font-semibold mb-2">Recent Score Changes</h3>
    <ul id="recentAdjustments" class="text-sm text-yellow-100 space-y-1">
      <!-- Populated by JS -->
    </ul>
  </div>
</div>

<!-- Login Prompt for DSPOINC Journey -->
<div id="dspoincLoginPrompt" class="bg-gray-900 rounded-2xl shadow-2xl p-6 max-w-lg w-full text-center mt-10 mb-4 border-2 border-yellow-300 mx-auto">
  <h2 class="text-xl font-bold text-yellow-300 mb-4 flex items-center gap-2">
    <img src="img/cheese-egg.png" class="w-6 h-6" alt=""> 
    $DSPOINC Journey
  </h2>
  <p class="text-gray-400 mb-4">Login with Discord to view your DSPOINC balance and history</p>
  <a href="https://discord.com/oauth2/authorize?client_id=1357927342265204858&response_type=code&redirect_uri=https%3A%2F%2Fnarrrfs.world%2Fapi%2Fauth%2Fcallback.php&scope=guilds+identify+guilds.members.read" 
     class="inline-block bg-yellow-400 hover:bg-yellow-500 text-black font-bold px-6 py-3 rounded-xl shadow-lg border-2 border-yellow-500 transition-all duration-300 transform hover:scale-105">
    ğŸ” Login with Discord
  </a>
</div>

</section>

<!-- ğŸ® Triple Game Panel â€” Tetris + Snake + Space Invaders -->
<section class="max-w-6xl w-full mx-auto px-4 mt-12 flex flex-col lg:flex-row gap-8 items-start justify-center">
 <!-- ğŸ® TETRIS PANEL -->
  <section id="cheese-tetris" class="flex-1 relative bg-black text-yellow-300 py-8 px-6 rounded-3xl shadow-xl ring-4 ring-yellow-400/40 mb-8 lg:mb-0">
    <div class="absolute top-4 left-4 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-full shadow animate-pulse z-10">
      ğŸ® TETRIS
    </div>

    <h2 class="text-center text-2xl font-bold mb-4 text-yellow-100 drop-shadow">TETRIS SPOINC MODE</h2>
    <canvas id="tetris-canvas" width="200" height="400" class="bg-gray-900 border-4 border-yellow-400 mx-auto block rounded-lg shadow-lg"></canvas>

    <div class="text-center mt-4 space-y-2">
      <button id="start-tetris-btn" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-4 py-2 rounded-xl shadow-lg w-32">â–¶ï¸ Start</button>
      <button id="pause-tetris-btn" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-4 py-1 rounded-xl shadow-md w-32">â¸ï¸ Pause</button>
    </div>

    <div id="bomb-defused-popup" class="absolute top-[420px] right-6 md:right-12 bg-yellow-300 text-black px-2 py-1 rounded-lg text-xs md:text-sm shadow-lg hidden z-50 scale-75">
      ğŸ’£ Bomb Defused!
    </div>

    <div class="mt-4 flex flex-col items-center justify-center">
      <h4 class="text-xs font-semibold tracking-wide uppercase mb-1">ğŸ”® Next Block</h4>
      <div class="p-1 bg-black rounded-xl ring-2 ring-yellow-500/60 shadow-md">
        <canvas id="next-canvas" width="80" height="80" class="bg-gray-900 rounded-md block"></canvas>
      </div>
    </div>

    <p id="bomb-warning" class="hidden text-pink-400 text-xs font-bold mt-1 animate-glow">ğŸ’£ Incoming Cheese Bomb!</p>
    <p id="spoink-score" class="text-center mt-6 text-sm font-semibold text-yellow-200 animate-pulse">
      ğŸ’° $DSPOINC earned: <span id="score-value" class="font-mono">0</span>
    </p>

  </section>

  <!-- ğŸŸ¢ SNAKE PANEL -->
  <section id="cheese-snake" class="flex-1 bg-black text-yellow-300 py-8 px-4 sm:px-6 rounded-3xl shadow-xl ring-4 ring-yellow-400/40 relative flex flex-col items-center mb-8 lg:mb-0">
    <div class="absolute top-4 left-4 bg-green-400 text-black text-xs font-bold px-3 py-1 rounded-full shadow animate-pulse z-10">
      ğŸ SNAKE
    </div>
  <h2 class="text-center text-2xl font-bold mb-4 text-yellow-100 drop-shadow">Cheese Snake</h2>

    <div class="relative">
      <canvas id="snake-canvas" width="200" height="400" class="bg-gray-900 border-4 border-yellow-400 mx-auto rounded-lg shadow-lg"></canvas>

      <div id="mutation-badge" class="hidden text-xs bg-lime-500 text-black px-3 py-2 rounded-full shadow-lg absolute top-2 right-2 z-50">
        ğŸ§¬ GENETIC MODE ACTIVE
      </div>

      <div id="snake-countdown" class="absolute inset-0 flex items-center justify-center text-5xl font-bold text-yellow-300 bg-black/80 hidden z-50 rounded-lg">
        5
      </div>
    </div>

    <div class="text-center mt-4 space-y-2">
      <button id="start-snake-btn" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-4 py-2 rounded-xl shadow-lg w-32">â–¶ï¸ Start</button>
      <button id="pause-snake-btn" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-4 py-1 rounded-xl shadow-md w-32">â¸ï¸ Pause</button>
    </div>

    <p id="snake-score" class="text-center mt-6 text-sm font-semibold text-yellow-200 animate-pulse">ğŸ’° Snake Score: $0 DSPOINC</p>
    <div class="text-xs italic text-center text-gray-500 mt-1">&larr; first to 100 cheese triggers mutation</div>
  </section>

  <!-- ğŸš€ SPACE INVADERS PANEL -->
  <section id="space-cheese-invaders" class="flex-1 bg-black text-yellow-300 py-8 px-6 rounded-3xl shadow-xl ring-4 ring-yellow-400/40 relative cursor-pointer hover:ring-yellow-300 transition-all duration-300" onclick="window.location.href='space-invaders-test.html'">
    <div class="absolute top-4 left-4 bg-purple-400 text-black text-xs font-bold px-3 py-1 rounded-full shadow animate-pulse z-10">
      ğŸš€ SPACE INVADERS
    </div>
    
    <div class="absolute top-4 right-4 bg-orange-500 text-black text-xs font-bold px-3 py-1 rounded-full shadow animate-pulse z-10">
      ğŸ§€ CHEESE CONSTRUCTION
    </div>

    <!-- ğŸ¯ Click to Play Full Game Indicator -->
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-400/90 text-black text-lg font-bold px-6 py-3 rounded-xl shadow-2xl z-20 hover:bg-yellow-300 transition-all duration-300">
      ğŸ® CLICK TO PLAY FULL GAME
    </div>

    <h2 class="text-center text-2xl font-bold mb-4 text-yellow-100 drop-shadow">SPACE CHEESE INVADERS</h2>
    
    <div class="relative opacity-50">
      <canvas id="space-invaders-canvas" width="200" height="400" class="bg-gray-900 border-4 border-yellow-400 mx-auto block rounded-lg shadow-lg"></canvas>

      <div id="space-invaders-countdown" class="absolute inset-0 flex items-center justify-center text-5xl font-bold text-yellow-300 bg-black/80 hidden z-50 rounded-lg">
        5
      </div>
    </div>

    <div class="text-center mt-4 space-y-2 opacity-50">
      <button id="start-space-invaders-btn" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-4 py-2 rounded-xl shadow-lg w-32">â–¶ï¸ Start</button>
      <button id="pause-space-invaders-btn" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-4 py-1 rounded-xl shadow-md w-32">â¸ï¸ Pause</button>
    </div>

    <p id="space-invaders-score" class="text-center mt-6 text-sm font-semibold text-yellow-200 animate-pulse opacity-50">
      ğŸ’° Space Invaders Score: $0 DSPOINC
    </p>

    <div class="text-xs italic text-center text-gray-500 mt-1">ğŸ‘¾ Click to play the full Space Cheese Invaders game!</div>
  </section>
</section>

<!-- ğŸ§  MODALS GAMEOVER-->
<div id="snake-over-modal" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-80 z-50 backdrop-blur-sm">
  <div class="bg-yellow-100 text-gray-900 rounded-3xl px-6 py-8 text-center shadow-2xl border-4 border-yellow-400 max-w-xs w-full animate-fade-in">
    <h2 class="text-3xl font-extrabold mb-3 text-yellow-900 drop-shadow">ğŸ§  GAME OVER</h2>
    <p id="snake-final-score-text" class="text-lg font-mono text-gray-800 mb-6">You earned $0 DSPOINC</p>
    <button onclick="window.location.reload()" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-6 py-2 rounded-xl shadow-lg">ğŸ” Play Again</button>
  </div>
</div>

<div id="game-over-modal" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-80 z-50 backdrop-blur-sm">
  <div class="bg-yellow-100 text-gray-900 rounded-3xl px-6 py-8 text-center shadow-2xl border-4 border-yellow-400 max-w-xs w-full animate-fade-in">
    <h2 class="text-3xl font-extrabold mb-3 text-yellow-900 drop-shadow">ğŸ§  GAME OVER</h2>
    <p id="final-score-text" class="text-lg font-mono text-gray-800 mb-6">You earned $0 DSPOINC</p>
    <button onclick="window.location.reload()" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-6 py-2 rounded-xl shadow-lg">ğŸ” Play Again</button>
  </div>
</div>

<div id="space-invaders-over-modal" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-80 z-50 backdrop-blur-sm">
  <div class="bg-yellow-100 text-gray-900 rounded-3xl px-6 py-8 text-center shadow-2xl border-4 border-yellow-400 max-w-xs w-full animate-fade-in">
    <h2 class="text-3xl font-extrabold mb-3 text-yellow-900 drop-shadow">ğŸ§  GAME OVER</h2>
    <p id="space-invaders-final-score-text" class="text-lg font-mono text-gray-800 mb-6">You earned $0 DSPOINC</p>
    <button onclick="window.location.reload()" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-6 py-2 rounded-xl shadow-lg">ğŸ” Play Again</button>
  </div>
</div>

<div id="space-invaders-win-modal" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-80 z-50 backdrop-blur-sm">
  <div class="bg-green-100 text-gray-900 rounded-3xl px-6 py-8 text-center shadow-2xl border-4 border-green-400 max-w-xs w-full animate-fade-in">
    <h2 class="text-3xl font-extrabold mb-3 text-green-900 drop-shadow">ğŸ† VICTORY!</h2>
    <p id="space-invaders-win-score-text" class="text-lg font-mono text-gray-800 mb-6">You earned $0 DSPOINC</p>
    <button onclick="window.location.reload()" class="bg-green-400 hover:bg-green-300 text-black font-bold px-6 py-2 rounded-xl shadow-lg">ğŸ” Play Again</button>
  </div>
</div>

<!-- ğŸ” Login Prompt -->
<div id="tetris-auth" class="text-center my-6 w-full max-w-2xl mx-auto">
  <button onclick="loginAndReload()" class="bg-yellow-300 hover:bg-yellow-400 text-black font-bold px-5 py-2 rounded-full shadow transition">
    ğŸ” Login with Discord to Save Score
  </button>
</div>

<!-- ğŸ† Leaderboard Section -->
<section id="leaderboard" class="max-w-6xl mx-auto bg-black text-yellow-300 py-6 px-4 rounded-3xl shadow-lg ring-4 ring-yellow-400 mt-10">
  <h3 class="text-center text-xl font-bold">ğŸ† Leaderboard</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
    <div>
      <h4 class="text-center text-md font-semibold">ğŸ§€ Tetris Top Scores</h4>
      <ul id="leaderboard-tetris-list" class="text-center"></ul>
    </div>
    <div>
      <h4 class="text-center text-md font-semibold">ğŸ Snake Top Scores</h4>
      <ul id="leaderboard-snake-list" class="text-center"></ul>
    </div>
    <div>
      <h4 class="text-center text-md font-semibold">ğŸš€ Space Invaders Top Scores</h4>
      <ul id="leaderboard-space-invaders-list" class="text-center"></ul>
    </div>
  </div>
</section>

<!-- ğŸ”‘ Fallback Login Button -->
<div id="loginBlock" class="mt-6 text-center">
  <a href="https://discord.com/oauth2/authorize?client_id=1357927342265204858&response_type=code&redirect_uri=https%3A%2F%2Fnarrrfs.world%2Fapi%2Fauth%2Fcallback.php&scope=guilds+identify+guilds.members.read"
     class="inline-block bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-5 rounded-full shadow-md border-2 border-yellow-600 animate-bounce transition">
    ğŸ§€ Click to Login with Discord
  </a>
  <p class="mt-2 text-xs text-gray-400 italic">When the Grumpy Cheese gives no love, this does.</p>
</div>

<!-- ğŸ§ª Back to Lab Button -->
<div class="w-full flex justify-center mt-6">
  <a href="/index.html"
     class="bg-yellow-500 text-white px-5 py-2 rounded-full shadow hover:bg-yellow-600 text-sm sm:text-base text-center">
    ğŸ§ª Back to the Lab
  </a>
</div>

  <!-- ğŸŒ€ Cheese Portal to Hytopia -->
<div class="mt-10 text-center">
  <a href="/hytopia.html" class="group inline-block relative" title="ğŸ§€ Hytopia portal is closed... for now.">
    <div class="relative p-4 rounded-full bg-yellow-300/90 hover:bg-yellow-400 transition-all duration-300 shadow-2xl animate-pulse">
      <img src="img/cheese-portal.png" alt="Enter Hytopia" class="w-24 h-24 sm:w-32 sm:h-32 mx-auto group-hover:scale-105 transition-transform duration-300 drop-shadow-lg" />
      <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <div class="text-xs bg-black/80 text-yellow-300 px-3 py-1 rounded-full shadow-md animate-pulse">
          ğŸ§€ Portal Closed Â· Opening Soon!
        </div>
      </div>
    </div>
  </a>
      </div>
      
<!-- ğŸ” Dynamic Fetch Script logged in or not -->
<!-- ğŸ‘‘ VIP Logic + Trophy Shelf (KEEP AS IS) -->
<!-- Patched profile.html by Cheese Architect ğŸ§€âœ¨ -->
<!-- Patched profile.html with working fetch logic ğŸ§  -->

<script>
const trophies = {
  "VIP Holder": { img: "img/trophy_VIP.png", label: "VIP Cheese Lord" },
  "Holder": { img: "img/trophy_holder.png", label: "ğŸ† Holder" },
  "Cheese Hunter": { img: "img/trophy_cheese_hunter.png", label: "ğŸ§€ Cheese Hunter" },
  "ğŸ§€ Cheese Hunter": { img: "img/trophy_cheese_hunter.png", label: "ğŸ§€ Cheese Hunter" },
  "ğŸ† Holder": { img: "img/trophy_holder.png", label: "ğŸ† Holder" },
  "ğŸ´ VIP Holder": { img: "img/trophy_VIP.png", label: "ğŸ´ VIP Holder" },
  "PokerOG": { img: "img/trophy_PokerOG.png", label: "Poker OG" },
  "Champion": { img: "img/trophy_champion.png", label: "Champion" },
  "Rumble": { img: "img/trophy_rumble.png", label: "Rumble Champ" },
  "Engage": { img: "img/trophy_engage.png", label: "Engager" },
  "Moderator": { img: "img/trophy_moderator.png", label: "Moderator" },
  "Server Booster": { img: "img/trophy_serverbooster.png", label: "Server Booster" },
  "Alpha Caller": { img: "img/trophy_alphacaller.png", label: "Alpha Caller" },
  "Crypto Corn Friends": { img: "img/trophy_cryptocornfriends.png", label: "Corny Companion" },
  "Rabbit Friends": { img: "img/trophy_rabbitfriends.png", label: "Bunny Buddy" },
  "Kaleido Friends": { img: "img/trophy_kaleidofriends.png", label: "Kaleido Supporter" },
  "Weedery Friends": { img: "img/trophy_weederyfriends.png", label: "Weedery ğŸŒ¿" },
  "Community Member": { img: "img/trophy_community.png", label: "Community Member" },
  "Verifiziert": { img: "img/trophy_verified.png", label: "Verified" }
};

function renderTrophyShelf(userRoles = []) {
  const shelf = document.getElementById("cheeseShelf");
  if (!shelf) return;
  shelf.innerHTML = "";
  const uniqueRoles = [...new Set(userRoles)];
  
  // Debug logging
  console.log('Rendering trophy shelf with roles:', uniqueRoles);
  
  uniqueRoles.forEach(role => {
    // Check for exact match first
    let trophy = trophies[role];
    
    // If no exact match, try to find a match by removing emojis or adding them
    if (!trophy) {
      // Try removing emojis from role name
      const cleanRole = role.replace(/[ğŸ†ğŸ´ğŸ§€]/g, '').trim();
      trophy = trophies[cleanRole];
      
      // If still no match, try adding emojis
      if (!trophy) {
        if (cleanRole === 'Holder') {
          trophy = trophies['ğŸ† Holder'];
        } else if (cleanRole === 'VIP Holder') {
          trophy = trophies['ğŸ´ VIP Holder'];
        } else if (cleanRole === 'Cheese Hunter') {
          trophy = trophies['ğŸ§€ Cheese Hunter'];
        }
      }
    }
    
    if (trophy) {
      const trophyEl = document.createElement("div");
      trophyEl.className = "flex flex-col items-center animate-pop transition-transform hover:scale-105";
      trophyEl.innerHTML = `
        <img src="${trophy.img}" alt="${trophy.label}" class="w-16 h-16 sm:w-20 sm:h-20 drop-shadow mb-2" />
        <span class="text-sm text-yellow-100 font-semibold text-center">${trophy.label}</span>
      `;
      shelf.appendChild(trophyEl);
      console.log('Added trophy for role:', role, '->', trophy.label);
    } else {
      console.log('No trophy found for role:', role);
    }
  });
}

// Helper for safe text setting
function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.innerText = value;
}
// Helper for class toggle (show/hide)
function showElement(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('hidden');
}
function hideElement(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add('hidden');
}

// Function to navigate to admin interface with proper redirect flag
function goToAdminInterface() {
  // Set the admin redirect flag before navigating
  localStorage.setItem('adminRedirect', 'true');
  console.log('ğŸ”„ Setting admin redirect flag and navigating to admin interface');
  
  // Navigate to admin interface
  window.location.href = '/admin-interface.html';
}

document.addEventListener("DOMContentLoaded", async function () {
  // ğŸª Initialize Cookie Consent Banner
  initializeCookieConsent();
  
  const avatar = document.getElementById('avatar');
  const loginLink = document.getElementById('login-link');

  // Check if user was redirected from admin interface
  const adminRedirect = localStorage.getItem('adminRedirect');
  if (adminRedirect) {
    localStorage.removeItem('adminRedirect'); // Clear the flag
    // We'll handle the admin redirect after user data is loaded
  }

    try {
     // Unified fetch from profile.php
     const res = await fetch('/api/user/profile.php', { 
       credentials: 'include',
       headers: { 'Accept': 'application/json' }
     });

     // Ensure DSPOINC sections are hidden by default for non-logged-in users
     hideElement('dspoincJourneySection');
     showElement('dspoincLoginPrompt');

    if (!res.ok) {
      if (res.status === 401) {
        // Not logged in - show login UI
        setText('username', 'Guest#0000');
        setText('welcome-name', 'Guest');
        setText('email', 'Please log in');
        setText('guilds', 'No guilds connected');
        setText('traits', 'No traits available');
        setText('user-roles', 'No roles');
        setText('wallet-address', 'Wallet not linked');
        hideElement('goldenCheeseGate');
        hideElement('noCheeseJoke');
		hideElement('bingoBanner');


        // Make sure login link is visible and clickable
        if (loginLink) {
          loginLink.href = "https://discord.com/oauth2/authorize?client_id=1357927342265204858&response_type=code&redirect_uri=https%3A%2F%2Fnarrrfs.world%2Fapi%2Fauth%2Fcallback.php&scope=guilds+identify+guilds.members.read";
          loginLink.style.display = 'block';
        }
        if (avatar) {
          avatar.src = 'img/grumpy-cheese.png';
          avatar.style.cursor = 'pointer';
        }
        return;
      }
      throw new Error(`API error: ${res.status}`);
    }

    const user = await res.json();
    
    // Store Discord info for other features (optional)
    if (user.discord_id) {
      localStorage.setItem("discord_id", user.discord_id);
      localStorage.setItem("discord_name", user.discord_name);
    }

    // Username & avatar
    setText('username', user.discord_name || 'Unknown');
    setText('welcome-name', user.discord_name || 'Unknown');
    if (avatar) {
      avatar.src = user.avatar_url || 'img/default-avatar.png';
      avatar.alt = user.discord_name || 'Unknown';
      avatar.title = user.discord_name || 'Unknown';
      avatar.classList.remove('cursor-pointer');
    }
    if (loginLink) loginLink.removeAttribute('href');

    // Traits, roles, and wallet
    setText('traits', user.traits?.join(', ') || 'No traits');
    setText('user-roles', user.roles?.join(', ') || 'No roles');
    setText('wallet-address', localStorage.getItem('walletAddress') || 'Wallet not linked');
    setText('email', user.email || '');
    setText('guilds', `ğŸ¯ Guilds Connected: ${user.guilds?.length || 0}`);

    // Scores/stats (if present in JSON)
    if (user.stats) {
      // Note: DSPOINC balance is now fetched separately via score-total API
      setText('stats-adjustments', user.stats.scoreAdjustments || 0);
      setText('stats-sources', user.stats.sources || 0);
      setText('stats-roles', user.stats.roles || 0);
    }
    
    // Set member since date
    if (user.member_since) {
      setText('stats-member-since', user.member_since);
    }

         // Trophy pokal shelf â€” render immediately from roles
     if (user.roles) renderTrophyShelf(user.roles);

     // VIP/Golden Cheese logic check on top menu
     if (user.roles && (user.roles.includes("VIP Holder") || user.roles.includes("VIP_pass"))) {
       showElement('goldenCheeseGate'); // optional if defined elsewhere
       showElement('vipSection');       // âœ… Matches the DOM ID
     } else {
       showElement('noCheeseJoke');
     }
 	
     // âœ… Show Bingo banner if user is logged in
     if (user.discord_id) {
       showElement('bingoBanner');
     }
     
     // âœ… Show DSPOINC Journey section when logged in
     if (user.discord_id) {
       showElement('dspoincJourneySection');
       hideElement('dspoincLoginPrompt');
       
       // ğŸ§€ Populate DSPOINC Journey data immediately
       try {
         // Fetch actual DSPOINC balance from the score-total API
         const balanceResponse = await fetch(`/api/user/score-total.php`, { 
           credentials: 'include' 
         });
         if (balanceResponse.ok) {
           const balanceData = await balanceResponse.json();
           if (balanceData.total_dspoinc !== undefined) {
             const dspoincBalance = balanceData.total_dspoinc || 0;
             
             // Update DSPOINC Journey display
             const dspoincJourneyEl = document.getElementById('user-dspoinc-journey');
             if (dspoincJourneyEl) {
               dspoincJourneyEl.textContent = dspoincBalance.toLocaleString();
               console.log('âœ… DSPOINC Journey balance set to:', dspoincBalance);
             }
             
             // Update main User Statistics display
             const userSpoincEl = document.getElementById('user-spoinc');
             if (userSpoincEl) {
               userSpoincEl.textContent = dspoincBalance.toLocaleString();
               console.log('âœ… Total DSPOINC balance set to:', dspoincBalance);
             }
           } else {
             console.error('âŒ Score total API error:', balanceData.error);
           }
         } else {
           console.error('âŒ Score total API request failed:', balanceResponse.status);
         }
       } catch (balanceError) {
         console.error('âŒ Error fetching DSPOINC balance:', balanceError);
       }
         
         // Fetch and display recent adjustments
         fetch('/api/user/recent-adjustments.php', { credentials: 'include' })
           .then(res => res.json())
           .then(response => {
             const recentList = document.getElementById('recentAdjustments');
             const adjustments = Array.isArray(response.adjustments) ? response.adjustments : [];

             if (recentList) {
               if (adjustments.length > 0) {
                 recentList.innerHTML = adjustments
                   .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                   .slice(0, 10)
                   .map(a =>
                     `<li>
                       <span class="font-mono">${a.timestamp ? a.timestamp.replace('T', ' ').slice(0, 19) : ''}</span>
                       : <b class="${a.amount > 0 ? 'text-green-400' : 'text-red-400'}">${a.amount > 0 ? '+' : ''}${a.amount}</b>
                       <span class="italic">(${a.reason || a.action})</span>
                     </li>`
                   ).join('');
                 console.log('âœ… Recent adjustments loaded:', adjustments.length);
               } else {
                 recentList.innerHTML = '<li class="text-gray-400">No recent score changes</li>';
                 console.log('â„¹ï¸ No recent adjustments found');
               }
             }
           })
           .catch((error) => {
             console.error('Error fetching recent adjustments:', error);
             const recentList = document.getElementById('recentAdjustments');
             if (recentList) {
               recentList.innerHTML = '<li class="text-red-400">Could not load recent changes</li>';
             }
           });
       } catch (e) {
         console.error('Error populating DSPOINC Journey:', e);
       }
     } else {
       hideElement('dspoincJourneySection');
       showElement('dspoincLoginPrompt');
     }

    // ğŸ”§ Show Admin Access Button for admins/moderators
    if (user.roles && (
        user.roles.includes("Moderator") || 
        user.roles.includes("Admin") || 
        user.roles.includes("super_admin") ||
        user.roles.includes("Founder") ||
        user.roles.includes("Bot Master") ||
        user.discord_id === "328601656659017732" // narrrf's Discord ID
    )) {
      showElement('adminAccessButton');
      
      // If user was redirected from admin interface, show a notification
      if (adminRedirect) {
        // Add a temporary notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
        notification.innerHTML = `
          <div class="flex items-center gap-2">
            <span>âœ… Admin access granted!</span>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">Ã—</button>
          </div>
        `;
        document.body.appendChild(notification);
        
        // Auto-remove notification after 5 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }
    } else if (adminRedirect) {
      // User was redirected from admin but doesn't have admin privileges
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
      notification.innerHTML = `
        <div class="flex items-center gap-2">
          <span>âŒ Admin access denied. You need moderator privileges.</span>
          <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">Ã—</button>
        </div>
      `;
      document.body.appendChild(notification);
      
      // Auto-remove notification after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
    }

  } catch (err) {
    console.error('Profile fetch failed:', err);
         // Show login UI on error
     setText('username', 'Guest#0000');
     setText('welcome-name', 'Guest');
     setText('email', 'Please log in');
     setText('guilds', 'No guilds connected');
     setText('traits', 'No traits available');
     setText('user-roles', 'No roles');
     setText('wallet-address', 'Wallet not linked');
     hideElement('goldenCheeseGate');
     hideElement('noCheeseJoke');
     hideElement('dspoincJourneySection');
     showElement('dspoincLoginPrompt');
     
     // Make sure login link is visible
     if (loginLink) {
       loginLink.href = "https://discord.com/oauth2/authorize?client_id=1357927342265204858&response_type=code&redirect_uri=https%3A%2F%2Fnarrrfs.world%2Fapi%2Fauth%2Fcallback.php&scope=guilds+identify+guilds.members.read";
       loginLink.style.display = 'block';
     }
     if (avatar) {
       avatar.src = 'img/grumpy-cheese.png';
       avatar.style.cursor = 'pointer';
     }
  }
});
</script>



<!-- ğŸ§  Load Scroll Scripts -->
<script src="scripts/tetris-scroll.js?v=9.9"></script>
<script src="scripts/snake-scroll.js?v=1.1"></script>
        <script src="scripts/space-cheese-invaders.js?v=1.1" onerror="console.error('âŒ Failed to load space-cheese-invaders.js')" onload="console.log('âœ… space-cheese-invaders.js loaded successfully')"></script>
        <script>
          // Check if initSpaceInvaders is available immediately after script loads
          console.log('ğŸ” Checking initSpaceInvaders availability after script load...');
          console.log('ğŸ” window.initSpaceInvaders type:', typeof window.initSpaceInvaders);
          if (typeof window.initSpaceInvaders === 'function') {
            console.log('âœ… initSpaceInvaders is available after script load');
          } else {
            console.error('âŒ initSpaceInvaders is NOT available after script load');
          }
        </script>

<!-- ğŸ† Leaderboard Logic -->
<script>
  async function loadCombinedLeaderboards() {
    try {
      const res = await fetch("/api/dev/get-leaderboard.php");
      const result = await res.json();

      const tetrisList = document.getElementById("leaderboard-tetris-list");
      const snakeList = document.getElementById("leaderboard-snake-list");
      const spaceInvadersList = document.getElementById("leaderboard-space-invaders-list");

      tetrisList.innerHTML = "";
      snakeList.innerHTML = "";
      spaceInvadersList.innerHTML = "";

      (result.tetris || []).forEach((entry, i) => {
        const li = document.createElement("li");
        const name = entry.discord_name || `${entry.wallet.slice(0, 6)}...${entry.wallet.slice(-4)}`;
        li.textContent = `#${i + 1} ${name} â€“ ${entry.score} $DSPOINC`;
        tetrisList.appendChild(li);
      });

      (result.snake || []).forEach((entry, i) => {
        const li = document.createElement("li");
        const name = entry.discord_name || `${entry.wallet.slice(0, 6)}...${entry.wallet.slice(-4)}`;
        li.textContent = `#${i + 1} ${name} â€“ ${entry.score} $DSPOINC`;
        snakeList.appendChild(li);
      });

      (result.space_invaders || []).forEach((entry, i) => {
        const li = document.createElement("li");
        const name = entry.discord_name || `${entry.wallet.slice(0, 6)}...${entry.wallet.slice(-4)}`;
        li.textContent = `#${i + 1} ${name} â€“ ${entry.score} $DSPOINC`;
        spaceInvadersList.appendChild(li);
      });
    } catch (err) {
      console.error("Leaderboard fetch failed", err);
    }
  }

  // Load leaderboards when page loads
  loadCombinedLeaderboards();
</script>


<!-- ğŸ® Button Triggers and Init -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tetrisBtn = document.getElementById("start-tetris-btn");
    const snakeBtn = document.getElementById("start-snake-btn");
    const spaceInvadersBtn = document.getElementById("start-space-invaders-btn");
    const spaceInvadersCanvas = document.getElementById("space-invaders-canvas");

    console.log('ğŸ® DOM loaded, checking game elements:');
    console.log('ğŸ” Tetris button:', tetrisBtn);
    console.log('ğŸ” Snake button:', snakeBtn);
    console.log('ğŸ” Space Invaders button:', spaceInvadersBtn);
    console.log('ğŸ” Space Invaders canvas:', spaceInvadersCanvas);

    if (tetrisBtn) {
      tetrisBtn.addEventListener("click", () => {
        window.startTetrisGame?.();
        tetrisBtn.disabled = true;
        tetrisBtn.textContent = "ğŸ•¹ï¸ Playing...";
      });
    }

    if (snakeBtn) {
      snakeBtn.addEventListener("click", () => {
        window.startSnakeGame?.();
        snakeBtn.disabled = true;
        snakeBtn.textContent = "ğŸ•¹ï¸ Playing...";
      });
    }

    if (spaceInvadersBtn) {
      spaceInvadersBtn.addEventListener("click", () => {
        console.log('ğŸ® Space Invaders button clicked');
        console.log('ğŸ” window.initSpaceInvaders exists:', typeof window.initSpaceInvaders);
        if (window.initSpaceInvaders) {
          console.log('ğŸš€ Calling window.initSpaceInvaders()');
          window.initSpaceInvaders();
        } else {
          console.error('âŒ window.initSpaceInvaders is not available');
        }
        spaceInvadersBtn.disabled = true;
        spaceInvadersBtn.textContent = "ğŸ•¹ï¸ Playing...";
      });
    }

    // Reset button states when game ends
    window.addEventListener('spaceInvadersGameEnd', () => {
      if (spaceInvadersBtn) {
        spaceInvadersBtn.disabled = false;
        spaceInvadersBtn.textContent = "â–¶ï¸ Start";
      }
    });

    loadCombinedLeaderboards();
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", async function () {
  // 1. Try to get Discord ID (session or local)
  const userId = window.sessionDiscordId || localStorage.getItem("discord_id") || "";
  if (!userId) return; // Not logged in

  // 2. Fetch user profile data
  let user;
  try {
    const res = await fetch(`/api/user/profile.php?user_id=${userId}`);
    user = await res.json();
    if (user.error) throw new Error(user.error);
  } catch (e) {
    // fallback to loading state
    return;
  }

  // 3. Fill Stats
  const statsAdjustments = document.getElementById('stats-adjustments');
  const statsSources = document.getElementById('stats-sources');
  const statsRoles = document.getElementById('stats-roles');
  const statsMemberSince = document.getElementById('stats-member-since');
  
  if (statsAdjustments) statsAdjustments.innerText = "â€“"; // DSPOINC balance now fetched separately
  if (statsSources) statsSources.innerText = user.stats?.sources ?? "â€“";
  if (statsRoles) statsRoles.innerText = user.stats?.roles ?? "â€“";
  if (statsMemberSince) statsMemberSince.innerText = user.member_since ?? "â€“";

  // 4. Fill Skills (all roles & traits as badges)
  const skillsBox = document.querySelector('.skills-list');
  if (skillsBox) {
    skillsBox.innerHTML = '';
    const allSkills = [...(user.roles || []), ...(user.traits || [])];
    if (allSkills.length) {
      allSkills.forEach(skill => {
        const badge = document.createElement('span');
        badge.className = "inline-block bg-yellow-300 text-black px-2 py-1 rounded-full m-1 text-xs font-semibold shadow";
        badge.innerText = skill;
        skillsBox.appendChild(badge);
      });
    } else {
      skillsBox.innerHTML = '<span class="text-gray-300">No skills yet</span>';
    }
  }

  // 5. Access Levels (portals): show unlocked based on role/trait logic
  const portals = [
    {name: "Lore Portal", role: "Lore Mage", color: "bg-green-500"},
    {name: "Hytopia Portal", role: "Hytopia Hero", color: "bg-yellow-400"},
    {name: "Lab 3", role: "Lab3 Access", color: "bg-red-500"},
  ];
  const accessEl = document.querySelector('.access-levels-list');
  if (accessEl) {
    accessEl.innerHTML = '';
    const allSkills = [...(user.roles || []), ...(user.traits || [])];
    portals.forEach(portal => {
      const unlocked = allSkills.includes(portal.role);
      accessEl.innerHTML += `<span class="px-3 py-1 rounded-full mr-2 mb-2 inline-block text-white text-xs font-bold shadow ${portal.color} ${!unlocked ? 'opacity-50 grayscale' : ''}">
        ${portal.name}${!unlocked ? ' (Locked)' : ''}
      </span>`;
    });
  }

  // 6. Optionally: Let user "highlight" a favorite skill/level
  // You can add an event listener to the badges to let them pick a "main" skill, etc.
});
</script>

<script>
  function loginAndReload() {
    // Redirect to Discord OAuth
    window.location.href = "https://discord.com/oauth2/authorize?client_id=1357927342265204858&response_type=code&redirect_uri=https%3A%2F%2Fnarrrfs.world%2Fapi%2Fauth%2Fcallback.php&scope=guilds+identify+guilds.members.read";
  }
</script>

<!-- Add wallet.js before the closing body tag -->
<script src="js/wallet.js"></script>
<!-- Cheese Score Stats Fetcher -->
<script>
// Utility to get Discord ID (if session is available)
async function getDiscordId() {
  // Try from global variable first
  if (window.userDiscordId) return window.userDiscordId;

  // Fallback to localStorage
  return localStorage.getItem('discord_id') || null;
}

// On page load after DOM is ready
document.addEventListener('DOMContentLoaded', async () => {
  // Score fetching is now handled in the main user data fetch
  // This listener is kept for potential future use
});
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const userId = window.sessionDiscordId || localStorage.getItem('discord_id');
  const canvas = document.getElementById('pointsGraph');
  const msgBox = document.getElementById('pointsGraphMsg');

  function showMsg(msg) {
    if (msgBox) {
      msgBox.innerText = msg;
      msgBox.classList.remove('hidden');
    }
    if (canvas) canvas.style.display = 'none';
  }

  // Only show chart if user is logged in
  if (!userId) {
    console.log('User not logged in, hiding DSPOINC chart');
    if (canvas) canvas.style.display = 'none';
    if (msgBox) {
      msgBox.innerText = 'Please log in to see your DSPOINC history.';
      msgBox.classList.remove('hidden');
    }
    return;
  }

  if (!canvas) {
    console.error('pointsGraph canvas missing!');
    return;
  }

  // Fetch DSPOINC history for logged-in user using session-based API
  fetch(`/api/user/recent-adjustments.php`, { credentials: 'include' })
    .then(res => res.json())
    .then(json => {
      if (msgBox) msgBox.classList.add('hidden');
      canvas.style.display = '';
      
      let cumulative = 0, labels = [], data = [];
      
      if (json.adjustments && json.adjustments.length > 0) {
        // Sort by timestamp to ensure chronological order
        const sortedAdjustments = json.adjustments.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        for (const entry of sortedAdjustments) {
          cumulative += entry.amount;
          labels.push(entry.timestamp.split('T')[0]);
          data.push(cumulative);
        }
        
        new Chart(canvas, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: '$DSPOINC Over Time',
              data,
              fill: false,
              tension: 0.3,
              borderColor: '#fcd34d',
              backgroundColor: '#fde68a',
              pointRadius: 4,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true } }
          }
        });
      } else {
        showMsg('No DSPOINC adjustments found.');
      }
    })
    .catch(err => {
      console.error('Error loading DSPOINC adjustments:', err);
      showMsg('Could not load adjustments. Please try again.');
    });
});
</script>

</script>

<script>
// ğŸ§€ DSPOINC Journey logic consolidated into main profile fetch script above

// --- Claim Quest: Exposed for onclick ---
window.claimQuest = async function(questId, btn) {
  btn.disabled = true;
  btn.innerText = "Claiming...";
  const userId = window.sessionDiscordId || localStorage.getItem("discord_id") || "";
  try {
    const res = await fetch('/api/user/claim-quest.php', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `user_id=${encodeURIComponent(userId)}&quest_id=${encodeURIComponent(questId)}`
    });
    const data = await res.json();
    if (data.success) {
      btn.innerText = "Claimed! Pending review";
      btn.className = "mt-3 px-4 py-1 bg-yellow-400 text-black rounded-lg font-semibold text-sm";
      setTimeout(() => location.reload(), 800);
    } else {
      btn.innerText = "Already claimed";
      btn.className = "mt-3 px-4 py-1 bg-gray-500 text-black rounded-lg font-semibold text-sm";
    }
  } catch (e) {
    btn.innerText = "Failed";
    btn.disabled = false;
  }
};

// ğŸ¯ WL Role Button Logic
async function checkWLRoleAndShowButton() {
    const userId = window.sessionDiscordId || localStorage.getItem("discord_id") || "";
    const statusMessage = document.getElementById('wlStatusMessage');
    const checkButton = document.getElementById('checkWLButton');
    
    console.log('Checking WL role for user:', userId);
    
    // Show status message and disable button
    if (statusMessage) {
        statusMessage.innerHTML = '<div class="text-center"><div class="animate-spin inline-block w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full mr-2"></div>Checking WL status...</div>';
        statusMessage.classList.remove('hidden');
        statusMessage.className = 'text-xs text-blue-400 mt-2 italic max-w-md mx-auto text-center';
    }
    if (checkButton) {
        checkButton.disabled = true;
        checkButton.textContent = 'ğŸ”„ Checking...';
    }
    
    if (!userId) {
        console.log('No user ID found');
        if (statusMessage) {
            statusMessage.innerHTML = '<div class="text-center text-red-400">âŒ Please login with Discord first</div>';
            statusMessage.className = 'text-xs text-red-400 mt-2 italic max-w-md mx-auto text-center';
        }
        if (checkButton) {
            checkButton.disabled = false;
            checkButton.textContent = 'ğŸ¯ Check WL Status';
        }
        return;
    }

    try {
        // First, sync roles from Discord to ensure local database is up-to-date
        console.log('ğŸ”„ Syncing roles from Discord...');
        const syncResponse = await fetch('/api/auth/sync-role.php');
        
        if (!syncResponse.ok) {
            console.warn('âš ï¸ Role sync failed, continuing with local check...');
        } else {
            console.log('âœ… Roles synced from Discord');
        }
        
        // Now check roles from the local database (which should be up-to-date)
        const roleRes = await fetch('/api/user/roles.php');
        const roleData = await roleRes.json();
        console.log('Role data received:', roleData);
        console.log('Available roles:', roleData.roles);
        
        // Check ONLY for WL role - specific role name or ID
        const hasWLRole = roleData.roles && roleData.roles.some(role => {
            // Only check for the specific WL role
            const isWLRole = role === 'WL' || 
                           role === 'WL Role' ||
                           role === '1332108350518857842'; // WL role ID
            
            if (isWLRole) {
                console.log('âœ… Found WL role:', role);
            }
            return isWLRole;
        });
        
        if (hasWLRole) {
            console.log('User has WL role - showing button');
            // User has WL role - show button
            const wlButton = document.getElementById('wlMintButton');
            if (wlButton) {
                wlButton.classList.remove('hidden');
                console.log('WL button should now be visible');
            } else {
                console.log('WL button element not found');
            }
            
            // Update status message
            if (statusMessage) {
                statusMessage.innerHTML = '<div class="text-center text-green-400">âœ… WL Role found! Mint button should be visible below.</div>';
                statusMessage.className = 'text-xs text-green-400 mt-2 italic max-w-md mx-auto text-center';
            }
        } else {
            console.log('User does not have WL role');
            console.log('Available roles:', roleData.roles);
            
            // Update status message - only show WL-specific message
            if (statusMessage) {
                statusMessage.innerHTML = `
                    <div class="text-center">
                        <div class="text-red-400 mb-1">âŒ WL Role not found</div>
                        <div class="text-gray-400 text-xs">
                            <span class="font-semibold">Looking for:</span> WL role
                        </div>
                    </div>
                `;
                statusMessage.className = 'text-xs text-red-400 mt-2 italic max-w-md mx-auto text-center bg-gray-800 rounded-lg p-3';
            }
        }
    } catch (error) {
        console.error('Failed to check WL role:', error);
        if (statusMessage) {
            statusMessage.innerHTML = '<div class="text-center text-yellow-400">âš ï¸ Error checking WL status. Please try again.</div>';
            statusMessage.className = 'text-xs text-yellow-400 mt-2 italic max-w-md mx-auto text-center';
        }
    }
    
    // Re-enable button
    if (checkButton) {
        checkButton.disabled = false;
        checkButton.textContent = 'ğŸ¯ Check WL Status';
    }
}

// Check for WL role on page load
document.addEventListener('DOMContentLoaded', function() {
  // Small delay to ensure page is loaded
  setTimeout(checkWLRoleAndShowButton, 1000);
});

// ğŸ´ Web3 Wallet Verification Functions
let connectedWallet = null;
let connectedWalletAddress = null;

// Connect to Phantom wallet
async function connectWallet() {
  try {
    // Check if Phantom is installed
    if (!window.solana || !window.solana.isPhantom) {
      showError('Phantom wallet is not installed. Please install it from <a href="https://phantom.app/" target="_blank" class="text-blue-400 underline">phantom.app</a>');
      return;
    }

    // Connect to wallet
    const response = await window.solana.connect();
    connectedWallet = window.solana;
    connectedWalletAddress = response.publicKey.toString();
    
    // Update UI
    document.getElementById('wallet-status').classList.remove('hidden');
    document.getElementById('wallet-address').textContent = `Address: ${connectedWalletAddress.substring(0, 4)}...${connectedWalletAddress.substring(connectedWalletAddress.length - 4)}`;
    document.getElementById('connect-wallet-btn').classList.add('hidden');
    document.getElementById('verify-nfts-btn').classList.remove('hidden');
    
    showSuccess('Wallet connected successfully!');
    
  } catch (error) {
    console.error('Wallet connection error:', error);
    showError('Failed to connect wallet: ' + error.message);
  }
}

// Verify NFTs in the connected wallet using efficient Helius searchAssets
async function verifyNFTs() {
  if (!connectedWallet || !connectedWalletAddress) {
    showError('Please connect your wallet first');
    return;
  }

  try {
    showLoading(true);
    
    // Use Helius searchAssets to directly check for our collections - much more efficient
    const ourCollections = {
      'AtJCkW4as31C7cF4zQbZdvTt488ejUuacgynZpohVmML': {
        name: 'Narrrfs World: Genesis Genetic',
        role: 'ğŸ† Holder',
        roleId: '1402668301414563971'
      },
      'CUJH8MV68154vS8wTW15vAKxN6KazNpraFZ1FP8CVojg': {
        name: 'Narrrf Genesis VIP Drop',
        role: 'ğŸ´ VIP Holder', 
        roleId: '1332016526848692345'
      }
    };

    const foundNFTs = [];
    
    // Check each collection directly using searchAssets
    for (const [collectionAddress, collectionInfo] of Object.entries(ourCollections)) {
      try {
        console.log(`ğŸ” Checking ${collectionInfo.name} collection...`);
        
        const response = await fetch(`/api/wallet/get-nfts.php?wallet=${connectedWalletAddress}&collection=${collectionAddress}`);
        
        if (!response.ok) {
          console.warn(`âš ï¸ HTTP error ${response.status} for ${collectionInfo.name}`);
          continue; // Skip this collection and continue with others
        }
        
        const data = await response.json();
        
        if (!data.success) {
          console.warn(`âš ï¸ API error for ${collectionInfo.name}:`, data.error);
          continue; // Skip this collection and continue with others
        }

        console.log(`âœ… ${collectionInfo.name}: Found ${data.count} NFTs using ${data.method}`);
        
        if (data.has_assets && data.count > 0) {
          // User has NFTs from this collection - add to found list
          foundNFTs.push({
            collection: collectionInfo.name,
            role: collectionInfo.role,
            roleId: collectionInfo.roleId,
            count: data.count,
            collectionAddress: collectionAddress
          });
        }
        
      } catch (collectionError) {
        console.warn(`âš ï¸ Error checking ${collectionInfo.name}:`, collectionError);
        // Continue checking other collections
      }
    }
    
    // Display results
    displayVerificationResults(foundNFTs);
    
    // If NFTs found, verify with our backend
    if (foundNFTs.length > 0) {
      await verifyWithBackend(connectedWalletAddress, foundNFTs);
    } else {
      showError('No NFTs from our collections found in your wallet. Make sure you own Narrrfs World: Genesis Genetic or Narrrf Genesis VIP Drop NFTs. If you believe this is an error, please contact support.');
    }
    
  } catch (error) {
    console.error('NFT verification error:', error);
    showError('Failed to verify NFTs: ' + error.message);
  } finally {
    showLoading(false);
  }
}

// Display verification results
function displayVerificationResults(foundNFTs) {
  const resultsDiv = document.getElementById('verification-results');
  const resultsContent = document.getElementById('results-content');
  
  if (foundNFTs.length === 0) {
    resultsContent.innerHTML = '<p>âŒ No NFTs from our collections found.</p>';
  } else {
    let html = '<div class="space-y-2">';
    foundNFTs.forEach(nft => {
      html += `
        <div class="bg-green-800 rounded p-2">
          <div class="font-semibold">âœ… ${nft.role}</div>
          <div class="text-sm">Collection: ${nft.collection}</div>
          <div class="text-sm">NFTs found: ${nft.count}</div>
        </div>
      `;
    });
    html += '</div>';
    resultsContent.innerHTML = html;
  }
  
  resultsDiv.classList.remove('hidden');
}

// Verify with our backend - now requires cryptographic signature
async function verifyWithBackend(walletAddress, nfts) {
  try {
    const userId = window.sessionDiscordId || localStorage.getItem("discord_id") || "";
    
    if (!userId) {
      showError('Please login with Discord first to verify NFTs');
      return;
    }
    
    // Request signature from user to prove wallet ownership
    const message = `Verify NFT ownership for Narrrfs World - ${new Date().toISOString()}`;
    let signature = null;
    
    try {
      // Request signature from Phantom wallet
      if (window.solana && window.solana.isPhantom) {
        const encodedMessage = new TextEncoder().encode(message);
        const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');
        signature = Array.from(signedMessage.signature).map(byte => byte.toString(16).padStart(2, '0')).join('');
        
        console.log('ğŸ” Signature obtained:', signature);
      } else {
        throw new Error('Phantom wallet not available for signing');
      }
    } catch (signError) {
      console.error('Signature error:', signError);
      showError('Failed to get signature. Please approve the signature request in your wallet.');
      return;
    }
    
    // Group NFTs by collection
    const nftsByCollection = {};
    nfts.forEach(nft => {
      if (!nftsByCollection[nft.role]) {
        nftsByCollection[nft.role] = [];
      }
      nftsByCollection[nft.role].push(nft);
    });
    
    // Verify each collection
    for (const [collectionRole, collectionNFTs] of Object.entries(nftsByCollection)) {
      const response = await fetch('/api/user/verify-nft-holder.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId,
          wallet_address: walletAddress,
          nfts: collectionNFTs,
          collection: collectionRole,
          signature: signature,
          message: message
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showSuccess(`âœ… NFT verification successful! Role granted: ${data.role_name}`);
      } else {
        showError(`Verification failed for ${collectionRole}: ${data.error}`);
      }
    }
    
    // Refresh the page to show new roles
    setTimeout(() => location.reload(), 2000);
    
  } catch (error) {
    console.error('Backend verification error:', error);
    showError('Failed to verify with backend: ' + error.message);
  }
}

// Utility functions
function showLoading(show) {
  const loading = document.getElementById('verification-loading');
  if (show) {
    loading.classList.remove('hidden');
  } else {
    loading.classList.add('hidden');
  }
}

function showError(message) {
  const errorDiv = document.getElementById('verification-error');
  const errorMessage = document.getElementById('error-message');
  errorMessage.innerHTML = message;
  errorDiv.classList.remove('hidden');
  
  // Hide after 5 seconds
  setTimeout(() => {
    errorDiv.classList.add('hidden');
  }, 5000);
}

function showSuccess(message) {
  // Create a temporary success message
  const successDiv = document.createElement('div');
  successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  successDiv.textContent = message;
  document.body.appendChild(successDiv);
  
  // Remove after 3 seconds
  setTimeout(() => {
    document.body.removeChild(successDiv);
  }, 3000);
}
</script>

<script>
// Verify Solana keypair format and structure
function verifySolanaKeypair(publicKey) {
  try {
    // Check if it's a valid Solana public key format
    if (!publicKey || typeof publicKey !== 'string') {
      return { valid: false, error: 'Invalid public key format' };
    }
    
    // Solana public keys are base58 encoded and 32-44 characters
    if (!/^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(publicKey)) {
      return { valid: false, error: 'Invalid Solana public key format' };
    }
    
    return { valid: true, publicKey };
  } catch (error) {
    return { valid: false, error: 'Keypair verification failed: ' + error.message };
  }
}

// Connect to Phantom wallet with enhanced keypair verification
async function connectWallet() {
  try {
    // Check if Phantom is installed
    if (!window.solana || !window.solana.isPhantom) {
      showError('Phantom wallet is not installed. Please install it from <a href="https://phantom.app/" target="_blank" class="text-blue-400 underline">phantom.app</a>');
      return;
    }

    // Connect to wallet
    const response = await window.solana.connect();
    const publicKey = response.publicKey.toString();
    
    // Verify the keypair using Solana standards
    const verification = verifySolanaKeypair(publicKey);
    if (!verification.valid) {
      showError('Invalid wallet keypair: ' + verification.error);
      return;
    }
    
    connectedWallet = window.solana;
    connectedWalletAddress = publicKey;
    
    // Update UI
    document.getElementById('wallet-status').classList.remove('hidden');
    document.getElementById('wallet-address').textContent = `Address: ${publicKey.substring(0, 8)}...${publicKey.substring(publicKey.length - 8)}`;
    document.getElementById('connect-wallet-btn').classList.add('hidden');
    document.getElementById('verify-nfts-btn').classList.remove('hidden');
    
    console.log('ğŸ” Solana wallet connected and verified:', publicKey);
    showSuccess('Wallet connected successfully!');
    
  } catch (error) {
    console.error('Wallet connection error:', error);
    showError('Failed to connect wallet: ' + error.message);
  }
}
</script>

<script>
// ğŸª Cookie Consent Management
function initializeCookieConsent() {
  const banner = document.getElementById('cookie-consent-banner');
  const spacer = document.getElementById('cookie-banner-spacer');
  
  // Check if user has already made a choice
  const cookieChoice = localStorage.getItem('cookie-consent');
  
  if (cookieChoice) {
    // User has already made a choice - hide banner and adjust spacing
    hideCookieBanner();
  } else {
    // Show banner and adjust spacing
    showCookieBanner();
  }
  
  // Add event listeners
  document.getElementById('cookie-accept')?.addEventListener('click', acceptAllCookies);
  document.getElementById('cookie-decline')?.addEventListener('click', declineNonEssentialCookies);
}

function acceptAllCookies() {
  localStorage.setItem('cookie-consent', 'accepted');
  localStorage.setItem('cookie-preferences', JSON.stringify({
    essential: true,
    analytics: true,
    marketing: true,
    timestamp: new Date().toISOString()
  }));
  
  hideCookieBanner();
  showCookieSuccess('All cookies accepted! ğŸª');
}

function declineNonEssentialCookies() {
  localStorage.setItem('cookie-consent', 'declined');
  localStorage.setItem('cookie-preferences', JSON.stringify({
    essential: true,
    analytics: false,
    marketing: false,
    timestamp: new Date().toISOString()
  }));
  
  hideCookieBanner();
  showCookieSuccess('Only essential cookies enabled! ğŸ”’');
}

function hideCookieBanner() {
  const banner = document.getElementById('cookie-consent-banner');
  const spacer = document.getElementById('cookie-banner-spacer');
  
  if (banner) {
    banner.style.transform = 'translateY(-100%)';
    setTimeout(() => {
      banner.style.display = 'none';
      if (spacer) spacer.style.display = 'none';
    }, 500);
  }
}

function showCookieBanner() {
  const banner = document.getElementById('cookie-consent-banner');
  const spacer = document.getElementById('cookie-banner-spacer');
  
  if (banner) {
    banner.style.display = 'block';
    banner.style.transform = 'translateY(0)';
    if (spacer) spacer.style.display = 'block';
  }
}

function showCookieSuccess(message) {
  // Create temporary success notification
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in max-w-sm';
  notification.innerHTML = `
    <div class="flex items-center gap-2">
      <span>âœ…</span>
      <span>${message}</span>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200 text-lg">Ã—</button>
    </div>
  `;
  document.body.appendChild(notification);
  
  // Auto-remove after 4 seconds
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 4000);
}
</script>

<!-- ğŸ© Footer GENESIS 12.0 - Enhanced Cheese Universe Footer -->
<footer class="text-center mt-16 mb-10">
  <!-- Back to Top Link -->
  <div class="mb-6">
    <a href="#top" class="text-sm text-gray-500 hover:text-pink-500 transition-colors duration-200">
      ğŸ” Back to Top
    </a>
  </div>
  
  <!-- ğŸ§€ Narrrf's Cheese Universe Section -->
  <div class="mb-8 p-6 bg-gradient-to-r from-yellow-100/50 to-orange-100/50 rounded-xl border border-yellow-300/30">
    <div class="text-lg font-bold text-yellow-800 mb-4">
      ğŸ§€ Narrrf's Cheese Universe
    </div>
    <div class="text-sm text-yellow-700 mb-6">
      Where gaming meets cheese innovation
    </div>
    
    <!-- Quick Links -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <a href="/index.html" class="text-yellow-600 hover:text-yellow-800 transition-colors duration-200 font-medium">
        ğŸ  Home
      </a>
      <a href="/whitepaper-pro.html" class="text-yellow-600 hover:text-yellow-800 transition-colors duration-200 font-medium">
        ğŸ“œ Read the Whitepaper
      </a>
      <a href="/mint.html" class="text-yellow-600 hover:text-yellow-800 transition-colors duration-200 font-medium">
        ğŸ¨ Mint Your NFT
      </a>
      <a href="/profile.html" class="text-yellow-600 hover:text-yellow-800 transition-colors duration-200 font-medium">
        ğŸ­ Get Roles
      </a>
    </div>
    
    <!-- Socials -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <a href="https://x.com/narrrf12345" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 transition-colors duration-200 font-medium">
        ğŸ¦ Twitter / X
      </a>
                     <a href="https://discord.gg/CR5mYu49" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition-colors duration-200 font-medium">
                 ğŸ® Join Discord
               </a>
      <a href="https://www.clubgg.com/" target="_blank" rel="noopener noreferrer" class="text-green-600 hover:text-green-800 transition-colors duration-200 font-medium">
        ğŸƒ Poker ClubGG
      </a>
                     <a href="https://discord.gg/CR5mYu49" target="_blank" rel="noopener noreferrer" class="text-purple-600 hover:text-purple-800 transition-colors duration-200 font-medium">
                 ğŸ“§ Open a Ticket
               </a>
    </div>
    
    <!-- Contact & Location -->
    <div class="text-xs text-yellow-600/80 mb-4">
      ğŸŒ Web3 Only â€“ Austria Based
    </div>
  </div>
  
  <!-- Legal & Important Links - More Prominent -->
  <div class="mb-6 p-4 bg-gradient-to-r from-blue-50/50 to-indigo-50/50 rounded-lg border border-blue-200/30">
    <div class="text-sm font-semibold text-blue-800 mb-3">
      ğŸ“‹ Important Legal & Support Links
    </div>
    <div class="flex flex-wrap justify-center gap-6 text-sm">
      <a href="/privacy-policy.html" class="text-blue-600 hover:text-blue-800 transition-colors duration-200 font-medium px-3 py-2 bg-white/70 rounded-lg border border-blue-200/50 hover:bg-white hover:shadow-md">
        ğŸª Privacy Policy
      </a>
      <a href="/faq.html" class="text-blue-600 hover:text-blue-800 transition-colors duration-200 font-medium px-3 py-2 bg-white/70 rounded-lg border border-blue-200/50 hover:bg-white hover:shadow-md">
        â“ FAQ
      </a>
      <a href="/profile.html" class="text-blue-600 hover:text-blue-800 transition-colors duration-200 font-medium px-3 py-2 bg-white/700 rounded-lg border border-blue-200/50 hover:bg-white hover:shadow-md">
        ğŸ‘¤ Profile
      </a>
    </div>
  </div>
  
  <!-- Copyright & Branding -->
  <div class="pt-6 border-t border-yellow-600/30 text-xs text-yellow-600/80">
    <div class="mb-2">
      Â© 2025 Narrrf's World. Built with brain & cheese ğŸ§ ğŸ§€
    </div>
    <div class="text-yellow-500/70">
      ğŸš€ Powered by the ultimate cheese gaming technology
    </div>
  </div>
</footer>

</body>
</html>

