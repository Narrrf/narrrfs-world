<?php
// Update only scores for CSV users while preserving all other data
// This will NOT delete any users, only update scores for users in the CSV

$db_path = '/var/www/html/db/narrrf_world.sqlite';

// Embedded CSV data with accurate scores
$csv_data = [
    ['User Name', 'User ID', 'Points Balance', 'Total Harvested', 'Store Spent', 'Quest Points Earned', 'Quests Completed', 'Tips Given', 'Drops Claimed', 'Magic Embeds Claimed', 'Highest Tip Received', 'Total Tips Received', 'Total Tokens Received', 'Highest Tip Given', 'Total Tips Given', 'Total Magic Embeds'],
    ['Narrrf', '328601656659017732', '1521401', '0', '0', '5', '1', '0', '0', '10', '0', '0', '0', '0', '0', '2'],
    ['Harald1977', '1138915296959287468', '1346599', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Yeldos', '813992163377414156', '1268200', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['DEECZO || Narrrf\'s World', '987492370616561714', '1198006', '0', '0', '5', '1', '2', '0', '5', '0', '0', '0', '2', '1', '1'],
    ['spridarn', '405758248407531521', '1154800', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['PoliTechsGuy', '330373758172921877', '1086600', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['weedy75', '1233440156128641065', '980400', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Cryptime', '946199839111266354', '953000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Pauleecyio', '782242542095826946', '716000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['S1991z', '896779071164403822', '684800', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Victorifyd6r', '729674774745186405', '650000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['IrinKra𝕊', '899076429633945611', '615000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Capital T', '919618776620748831', '601998', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['KAKANFO || Narrrf\'s World', '1260317833532014805', '600004', '0', '0', '0', '0', '0', '0', '5', '2', '1', '2', '0', '0', '1'],
    ['hzz2001', '760183609222758501', '561900', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['rezidenc12', '919526807374553151', '543000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Dallas', '854353478646366230', '539999', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['The Pied PipeR', '973986241202753586', '488399', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['SarahDonna', '1215665502970581004', '477000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Santa', '1107633105185013790', '445300', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Magali', '902990329446277150', '438800', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['ꁅꂦꂦꌚꈼ🪿', '519526528506396693', '415000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['johngope', '650836758321430564', '381000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['dingo', '625662297033146368', '340000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['HamBearPig', '776667871173541909', '338000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Justme', '1224428436928594015', '306000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['GIDS', '931474434303344670', '298000', '0', '200000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['bigbear🇺🇲', '678680281904971809', '295000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['cryptodaniel', '734200554322001922', '294600', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Kerstin', '1208076026727501824', '285000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['&RES', '933055368924389377', '277000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Token77', '429757499147812904', '270000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['antdroidz', '991087101925797889', '266000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['ES213', '1005337747625611324', '263000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['SamX', '738929529808093265', '260000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['LennyLOCO', '871944171081043989', '225000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['02🫡', '993984242260398081', '210000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['yeahbaby', '954088420194537492', '203000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Hererra⨀', '830148295280033802', '200000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['G.O.A.L !', '925218322105126912', '200000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['HillsTrap', '1295502067724451933', '200000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['dilauo96', '681855532210061326', '200000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['meowy', '894003364717789206', '181997', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['🐉Dboss011', '841429450867474432', '178000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['GeorgeD2305', '888053272798175294', '169000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Now U see Me ᵗᵐ ⭕', '704506147138437152', '168400', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Loveable', '1146994462468362250', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Shark09411', '1009927843754553344', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Ice001', '971196904417423380', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['A_dam', '1099840086314602597', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Toheeb', '1072237466175684709', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['ShenBlake', '1011409269691789312', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Zeta', '937394508772036629', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Htyphoon', '350639704267554827', '160000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Gale 1', '986301774749134879', '150000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['¥aniesa¥orleone43|YOBBO', '1190122205485477898', '150000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['MrsJF1984', '1198736295845969980', '145000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Undisputed treepleA', '756577702604963960', '125000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['inkstaincowboy', '1056627693619265596', '120400', '0', '200000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Capital_🇷', '1002066138617888778', '110000', '0', '200000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Bored Cabbie', '303697392157327360', '110000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Pinkpal', '1014974234860199997', '110000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Oluwapelumi', '1222200013489180743', '107400', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Ancient1053 | Champion', '817203029291040819', '107000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['jimmyg85.eth', '820695152795975721', '106200', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['JMoreen | Watch Ya Neck!', '443414647907811339', '102000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Muzamil Beer', '1167252145406488648', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Jacquly9 🦉', '942142356537372692', '100000', '0', '0', '0', '0', '0', '0', '5', '0', '0', '0', '0', '0', '1'],
    ['lanalina111', '1320441586554769419', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['KaTaHaCaH', '707522457619136542', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Beenzo', '1129110565118296144', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['RockApe | DeAgentAl', '1126945806650462288', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['💯', '1206547081808842794', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['LordLanto', '903282819843911730', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Wills 📈', '1140072496905846934', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['BossPlayerT.X', '592624674152906752', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['ArturPolak', '1296597315041235036', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Kestr0', '982250249290678354', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['RyanJackV', '1154887353370939542', '100000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['irdg07', '942194524619415633', '93700', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Believers', '1202494597159456841', '82000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['ledropwcheese', '825023944032518225', '80000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['BIG Sheyzzie😎🪁', '1263586389052883037', '80000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Dnextg🧢', '850315742112514089', '75800', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['whats-app', '1142811808428732566', '75000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['venutschi', '899524110441402401', '75000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['mohammed', '409537495760371713', '75000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Hyp3rShocK', '301937905486790656', '70000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['xlinx', '1270833222787403887', '67000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['+[XX]Sir  Cronic[XX]+', '533727593497755648', '64000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Juani', '937394540476760125', '60000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['GaroB', '703615294966464533', '58000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Nickfresh1', '1029098424051707914', '57600', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['BANJOO \'Eth', '1101738237036343337', '50000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Rapu', '1190361566047125577', '50000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['thatneusguy', '1305902450309595166', '50000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['Rebelium', '436155587504373761', '50000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['ObviousGlee', '943603635491844167', '50000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['CoinnMann 🪙 ltcman 🪙', '970328921893646390', '50000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'],
    ['flyingsowrds', '1229084470829912127', '50000', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0']
];

if (!file_exists($db_path)) {
    echo "❌ Database not found: $db_path\n";
    exit;
}

try {
    $db = new SQLite3($db_path);
    $db->enableExceptions(true);
    
    echo "🔧 Starting score update (preserving all other data)...\n\n";
    
    // Get current user count
    $result = $db->query('SELECT COUNT(*) as count FROM tbl_user_scores');
    $current_count = $result->fetchArray(SQLITE3_ASSOC)['count'];
    echo "📊 Current users in database: $current_count\n";
    
    // Remove header row from CSV
    $headers = array_shift($csv_data);
    
    echo "📊 Found " . count($csv_data) . " users in CSV to update\n\n";
    
    // Start transaction
    $db->exec('BEGIN TRANSACTION');
    
    $updated_count = 0;
    $errors = [];
    
    foreach ($csv_data as $row) {
        if (count($row) < 3) {
            $errors[] = "Invalid row: " . implode(',', $row);
            continue;
        }
        
        $username = trim($row[0]);
        $user_id = trim($row[1]);
        $points_balance = (int)trim($row[2]);
        
        // Skip if no user_id or invalid points
        if (empty($user_id) || $points_balance === 0) {
            continue;
        }
        
        try {
            // Check if user exists
            $stmt = $db->prepare('SELECT COUNT(*) as count FROM tbl_user_scores WHERE user_id = ?');
            $stmt->bindValue(1, $user_id, SQLITE3_TEXT);
            $result = $stmt->execute();
            $exists = $result->fetchArray(SQLITE3_ASSOC)['count'] > 0;
            
            if ($exists) {
                // Update only the score for existing user (preserve all other data)
                $stmt = $db->prepare('UPDATE tbl_user_scores SET score = ? WHERE user_id = ?');
                $stmt->bindValue(1, $points_balance, SQLITE3_INTEGER);
                $stmt->bindValue(2, $user_id, SQLITE3_TEXT);
                $stmt->execute();
                echo "✅ Updated score: $username ($user_id) → " . number_format($points_balance) . " \$DSPOINC\n";
            } else {
                // Insert new user if not exists
                $stmt = $db->prepare('INSERT INTO tbl_user_scores (user_id, score, game, source) VALUES (?, ?, ?, ?)');
                $stmt->bindValue(1, $user_id, SQLITE3_TEXT);
                $stmt->bindValue(2, $points_balance, SQLITE3_INTEGER);
                $stmt->bindValue(3, 'discord', SQLITE3_TEXT);
                $stmt->bindValue(4, 'csv_update', SQLITE3_TEXT);
                $stmt->execute();
                echo "➕ Added new user: $username ($user_id) → " . number_format($points_balance) . " \$DSPOINC\n";
            }
            
            $updated_count++;
            
        } catch (Exception $e) {
            $errors[] = "Error updating $username ($user_id): " . $e->getMessage();
        }
    }
    
    // Commit transaction
    $db->exec('COMMIT');
    
    echo "\n🎉 SCORE UPDATE COMPLETE!\n";
    echo "✅ Successfully updated $updated_count users\n";
    
    if (!empty($errors)) {
        echo "⚠️  Errors encountered:\n";
        foreach ($errors as $error) {
            echo "   - $error\n";
        }
    }
    
    // Verify final state
    $result = $db->query('SELECT COUNT(*) as count FROM tbl_user_scores');
    $final_count = $result->fetchArray(SQLITE3_ASSOC)['count'];
    echo "📊 Final user count: $final_count (was $current_count)\n";
    
    // Check for Narrrf specifically
    $result = $db->query("SELECT user_id, score FROM tbl_user_scores WHERE user_id = '328601656659017732'");
    $narrrf = $result->fetchArray(SQLITE3_ASSOC);
    if ($narrrf) {
        echo "✅ Narrrf balance: " . number_format($narrrf['score']) . " \$DSPOINC\n";
    } else {
        echo "❌ Narrrf not found in database!\n";
    }
    
    // Add entry to score adjustments table (if table exists with correct structure)
    $current_time = date('Y-m-d H:i:s');
    $sync_description = "Score update from CSV - Updated $updated_count users with accurate balances";
    
    try {
        $stmt = $db->prepare('
            INSERT INTO tbl_score_adjustments (user_id, reason, adjusted_by, adjusted_at) 
            VALUES (?, ?, ?, ?)
        ');
        $stmt->bindValue(1, 'SYSTEM_UPDATE', SQLITE3_TEXT);
        $stmt->bindValue(2, $sync_description, SQLITE3_TEXT);
        $stmt->bindValue(3, 'ADMIN_SYSTEM', SQLITE3_TEXT);
        $stmt->bindValue(4, $current_time, SQLITE3_TEXT);
        $stmt->execute();
        
        echo "📝 Added update record to score adjustments table\n";
    } catch (Exception $e) {
        echo "📝 Note: Could not add to adjustments table (table structure may differ)\n";
    }
    
    echo "🕐 Update completed at: $current_time\n";
    
    echo "\n🔧 Database updated successfully!\n";
    echo "✅ All CSV users have accurate scores\n";
    echo "✅ All other users and data preserved\n";
    
} catch (Exception $e) {
    // Only rollback if transaction is active
    try {
        $db->exec('ROLLBACK');
    } catch (Exception $rollback_error) {
        // Transaction already committed or not active
    }
    echo "❌ Error: " . $e->getMessage() . "\n";
}
?> 